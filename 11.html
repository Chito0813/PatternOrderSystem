<!DOCTYPE html><html lang="zh-HK"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pattern Automatic Ordering System</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 添加Chart.js库用于图表显示 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f5f5fc',
              100: '#eeeef9',
              200: '#d8d8f2',
              300: '#b8b8e6',
              400: '#9797da',
              500: '#7676cd',
              600: '#5D5CDE', // 主色調 (保留）
              700: '#4a49b1',
              800: '#3d3c94',
              900: '#312e81',
            },
            secondary: {
              50: '#f8f9fa',
              100: '#f1f3f5',
              200: '#e9ecef',
              300: '#dee2e6',
              400: '#ced4da',
              500: '#adb5bd',
              600: '#868e96',
              700: '#495057',
              800: '#343a40',
              900: '#212529',
              950: '#0d0f12',
            },
            // 更新深色背景色為更乾淨的色調
            dark: {
              100: '#343a40',
              200: '#2b3035',
              300: '#212529',
              400: '#1a1d20',
              500: '#151718',
              600: '#121314',
              700: '#0e0e0f',
              800: '#0a0a0b',
              900: '#050506',
            }
          },
          fontFamily: {
            sans: ['"Inter"', 'system-ui', '-apple-system', 'sans-serif'],
          },
          boxShadow: {
            // 扁平化設計降低陰影強度
            'soft': '0 1px 3px rgba(0, 0, 0, 0.04)',
            'medium': '0 2px 6px rgba(0, 0, 0, 0.06)',
            'elegant': '0 4px 12px rgba(0, 0, 0, 0.08)',
            'inner-glow': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.05)',
            'floating': '0 4px 14px rgba(0, 0, 0, 0.08)',
            'card': '0 1px 3px rgba(0, 0, 0, 0.05)',
          },
          backgroundImage: {
            'subtle-pattern': 'linear-gradient(to right, #f0f0f0 1px, transparent 1px), linear-gradient(to bottom, #f0f0f0 1px, transparent 1px)',
            'subtle-pattern-dark': 'linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px)',
          },
          listStyleType: {
            'circle': 'circle',
          },
          animation: {
            // 優化動畫時間使其更短
            'pulse-subtle': 'pulse 2.5s infinite',
            'float': 'float 2.5s ease-out infinite',
            'bounce-light': 'bounce-light 1.5s ease-out infinite',
            'shakeX': 'shakeX 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97)',
            'dialogScale': 'dialogScale 0.2s cubic-bezier(0.4, 0, 0.2, 1)',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-4px)' },
            },
            'bounce-light': {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-2px)' },
            },
            shakeX: {
              '0%, 100%': { transform: 'translateX(0)' },
              '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-3px)' },
              '20%, 40%, 60%, 80%': { transform: 'translateX(3px)' },
            },
            dialogScale: {
              'from': { opacity: '0', transform: 'translateY(-4px)' },
              'to': { opacity: '1', transform: 'translateY(0)' },
            },
          },
          letterSpacing: {
            'widest': '0.15em',
          },
          borderRadius: {
            'md': '0.25rem',
            'lg': '0.375rem',
            'xl': '0.5rem',
            '2xl': '0.75rem',
          }
        }
      }
    }
  </script><!DOCTYPE html><html lang="zh-HK"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pattern Automatic Ordering System</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 添加Chart.js库用于图表显示 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f5f5fc',
              100: '#eeeef9',
              200: '#d8d8f2',
              300: '#b8b8e6',
              400: '#9797da',
              500: '#7676cd',
              600: '#5D5CDE', // 主色調 (保留）
              700: '#4a49b1',
              800: '#3d3c94',
              900: '#312e81',
            },
            secondary: {
              50: '#f8f9fa',
              100: '#f1f3f5',
              200: '#e9ecef',
              300: '#dee2e6',
              400: '#ced4da',
              500: '#adb5bd',
              600: '#868e96',
              700: '#495057',
              800: '#343a40',
              900: '#212529',
              950: '#0d0f12',
            },
            // 更新深色背景色為更乾淨的色調
            dark: {
              100: '#343a40',
              200: '#2b3035',
              300: '#212529',
              400: '#1a1d20',
              500: '#151718',
              600: '#121314',
              700: '#0e0e0f',
              800: '#0a0a0b',
              900: '#050506',
            }
          },
          fontFamily: {
            sans: ['"Inter"', 'system-ui', '-apple-system', 'sans-serif'],
          },
          boxShadow: {
            // 扁平化設計降低陰影強度
            'soft': '0 1px 3px rgba(0, 0, 0, 0.04)',
            'medium': '0 2px 6px rgba(0, 0, 0, 0.06)',
            'elegant': '0 4px 12px rgba(0, 0, 0, 0.08)',
            'inner-glow': 'inset 0 1px 2px 0 rgba(0, 0, 0, 0.05)',
            'floating': '0 4px 14px rgba(0, 0, 0, 0.08)',
            'card': '0 1px 3px rgba(0, 0, 0, 0.05)',
          },
          backgroundImage: {
            'subtle-pattern': 'linear-gradient(to right, #f0f0f0 1px, transparent 1px), linear-gradient(to bottom, #f0f0f0 1px, transparent 1px)',
            'subtle-pattern-dark': 'linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px), linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px)',
          },
          listStyleType: {
            'circle': 'circle',
          },
          animation: {
            // 優化動畫時間使其更短
            'pulse-subtle': 'pulse 2.5s infinite',
            'float': 'float 2.5s ease-out infinite',
            'bounce-light': 'bounce-light 1.5s ease-out infinite',
            'shakeX': 'shakeX 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97)',
            'dialogScale': 'dialogScale 0.2s cubic-bezier(0.4, 0, 0.2, 1)',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-4px)' },
            },
            'bounce-light': {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-2px)' },
            },
            shakeX: {
              '0%, 100%': { transform: 'translateX(0)' },
              '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-3px)' },
              '20%, 40%, 60%, 80%': { transform: 'translateX(3px)' },
            },
            dialogScale: {
              'from': { opacity: '0', transform: 'translateY(-4px)' },
              'to': { opacity: '1', transform: 'translateY(0)' },
            },
          },
          letterSpacing: {
            'widest': '0.15em',
          },
          borderRadius: {
            'md': '0.25rem',
            'lg': '0.375rem',
            'xl': '0.5rem',
            '2xl': '0.75rem',
          }
        }
      }
    }
  </script>
  <style>
    /* 核心動畫效果 - 優化移動端性能與滾動體驗 */
    html {
      scroll-behavior: smooth;
    }
    
    @media (max-width: 768px) {
      .form-container {
        padding-bottom: 120px;
      }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .fade-in, .animate-fadeIn {
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: opacity;
      backface-visibility: hidden;
    }
    @keyframes slideInUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .slide-in-up {
      animation: slideInUp 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, opacity;
      backface-visibility: hidden;
    }
    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-15px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .slide-in-left {
      animation: slideInLeft 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, opacity;
      backface-visibility: hidden;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(15px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .slide-in-right {
      animation: slideInRight 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, opacity;
      backface-visibility: hidden;
    }
    @keyframes dialogScale {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    .animate-dialogScale {
      animation: dialogScale 0.28s cubic-bezier(0.4, 0, 0.2, 1);
      will-change: transform, opacity;
    }
    @keyframes shakeX {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
      20%, 40%, 60%, 80% { transform: translateX(4px); }
    }
    .animate-shakeX {
      animation: shakeX 0.6s cubic-bezier(0.36, 0.07, 0.19, 0.97);
      will-change: transform;
    }
    .spin {
      animation: spin 1s linear infinite;
      will-change: transform;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* 过渡效果 */
    .transition-smooth {
      transition: all 0.24s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .transition-bounce {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    /* 輸入框效果 */
    .input-focus-ring {
      @apply focus:ring-2 focus:ring-primary-200 focus:border-primary-600 focus:outline-none;
    }
    .scrollbar-hidden::-webkit-scrollbar {
      display: none;
    }
    .scrollbar-hidden {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .dark .dark\:prose-invert {
      color: #e5e7eb;
    }
    .dark .dark\:prose-invert h2,
    .dark .dark\:prose-invert h3 {
      color: #f3f4f6;
    }
    .list-circle {
      list-style-type: circle;
    }
    
    /* 增強觸摸回饋動畫 */
    .btn-shake {
      animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97);
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
      20%, 40%, 60%, 80% { transform: translateX(5px); }
    }
    
    /* 增強按鈕按下效果 - 更適合觸屏操作 */
    .btn-press {
      transition: transform 0.12s cubic-bezier(0.4, 0, 0.2, 1), 
                  box-shadow 0.12s cubic-bezier(0.4, 0, 0.2, 1), 
                  background-color 0.12s cubic-bezier(0.4, 0, 0.2, 1);
      -webkit-tap-highlight-color: transparent;
    }
    .btn-press:active {
      transform: scale(0.96);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
    }
    
    /* 移動端觸摸效果 */
    @media (hover: none) {
      .btn-press:active {
        transform: scale(0.94);
      }
      .touch-feedback {
        position: relative;
        overflow: hidden;
      }
      .touch-feedback::after {
        content: '';
        display: block;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        pointer-events: none;
        background-image: radial-gradient(circle, rgba(0, 0, 0, 0.1) 10%, transparent 10.01%);
        background-repeat: no-repeat;
        background-position: 50%;
        transform: scale(10, 10);
        opacity: 0;
        transition: transform 0.4s, opacity 0.8s;
      }
      .touch-feedback:active::after {
        transform: scale(0, 0);
        opacity: 0.3;
        transition: 0s;
      }
    }
    
    /* 對話框動畫 */
    .dialog-enter {
      animation: dialogEnter 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      will-change: transform, opacity;
    }
    @keyframes dialogEnter {
      from { opacity: 0; transform: translateY(-5px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    
    /* 背景模糊效果 */
    .backdrop-blur {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    
    /* 卡片懸停效果 - 移動端優化 */
    .card-hover {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .card-hover:hover {
      transform: translateY(-3px);
    }
    @media (hover: none) {
      .card-hover:active {
        transform: translateY(-2px);
      }
    }
    
    /* 漸變背景 */
    .gradient-bg {
      background: linear-gradient(to bottom right, rgba(93, 92, 222, 0.05), rgba(93, 92, 222, 0.02));
    }
    .dark .gradient-bg {
      background: linear-gradient(to bottom right, rgba(93, 92, 222, 0.1), rgba(93, 92, 222, 0.05));
    }
    
    /* 優雅的輸入框 */
    .elegant-input {
      @apply transition-all duration-200 ease-in-out;
    }
    .elegant-input:focus {
      @apply shadow-inner-glow;
    }
    
    /* 裝飾線 - 自適應動畫 */
    .decorative-line {
      position: relative;
    }
    .decorative-line::after {
      content: '';
      position: absolute;
      bottom: -8px;
      left: 0;
      width: 40px;
      height: 3px;
      background-color: #5D5CDE;
      border-radius: 3px;
      transform-origin: left;
      animation: lineGrow 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    @keyframes lineGrow {
      from { transform: scaleX(0); }
      to { transform: scaleX(1); }
    }
    .dark .decorative-line::after {
      background-color: #7b79e5;
    }
    
    /* 彈窗和交互動畫 */
    @keyframes welcomePop {
      from { opacity: 0; transform: scale(0.95); }
      50% { transform: scale(1.02); }
      to { opacity: 1; transform: scale(1); }
    }
    .welcome-pop {
      animation: welcomePop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      will-change: transform, opacity;
    }
    
    /* 表情符號動畫 */
    @keyframes thumbsUp {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-10deg); }
      75% { transform: rotate(10deg); }
    }
    .thumbs-up {
      display: inline-block;
      animation: thumbsUp 1s ease-in-out;
    }
    
    /* 輸入框選擇特效 */
    .input-highlight {
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .input-highlight:focus {
      box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.3);
    }
    
    /* 頂部裝飾帶 */
    .top-decoration {
      background: linear-gradient(to right, #5D5CDE, #7b5cf9);
      height: 4px;
      width: 100%;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 100;
    }
    
    /* 氣泡圖標 - 觸摸優化 */
    .bubble-icon {
      position: relative;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .bubble-icon::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      transform: scale(0);
      transition: transform 0.3s ease-out;
    }
    .bubble-icon:hover::after {
      transform: scale(2);
    }
    @media (hover: none) {
      .bubble-icon:active::after {
        transform: scale(2);
      }
    }
    
    /* 自訂單選和複選框 */
    .custom-checkbox {
      @apply rounded-md text-primary-600 focus:ring-2 focus:ring-primary-200 focus:ring-offset-1 transition-all duration-200;
      min-width: 1.2rem;
      min-height: 1.2rem;
    }
    .custom-checkbox:hover:not(:checked) {
      @apply shadow-sm;
    }
    .custom-checkbox:checked {
      @apply transform scale-110 transition-transform;
    }
    
    /* 美化滾動條 */
    .styled-scrollbar::-webkit-scrollbar {
      width: 6px;
    }
    .styled-scrollbar::-webkit-scrollbar-track {
      background: rgba(243, 244, 246, 0.8);
      border-radius: 10px;
    }
    .dark .styled-scrollbar::-webkit-scrollbar-track {
      background: rgba(31, 41, 55, 0.8);
    }
    .styled-scrollbar::-webkit-scrollbar-thumb {
      background: rgba(93, 92, 222, 0.5);
      border-radius: 10px;
    }
    .styled-scrollbar::-webkit-scrollbar-thumb:hover {
      background: rgba(93, 92, 222, 0.7);
    }
    
    /* 移動端布局和觸摸優化 */
    @media (max-width: 768px) {
      .mobile-full {
        margin-left: -1rem;
        margin-right: -1rem;
        border-radius: 0;
        width: calc(100% + 2rem);
      }
      .mobile-stack {
        flex-direction: column;
      }
      .mobile-stack > * {
        width: 100%;
      }
      .mobile-p-adjust {
        padding: 1rem !important;
      }
      .mobile-m-adjust {
        margin: 0.5rem 0 !important;
      }
      /* 移動端按鈕尺寸優化 */
      .mobile-touch-target {
        min-height: 44px;
        padding: 0.75rem 1rem;
      }
      /* 確保表單控件足夠大觸摸 */
      input[type="checkbox"], 
      input[type="radio"] {
        min-width: 22px;
        min-height: 22px;
      }
      /* 增大移動端表單控件間距 */
      .mobile-form-spacing > * + * {
        margin-top: 1rem;
      }
      /* 移動端滑動動畫 */
      .mobile-slide-in {
        animation: mobileSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      @keyframes mobileSlideIn {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
      }
    }
    
    /* 3D卡片效果 - 簡化版 */
    .card-3d {
      transform-style: preserve-3d;
      perspective: 1000px;
    }
    .card-3d:hover .card-3d-inner {
      transform: translateZ(5px);
    }
    .card-3d-inner {
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    /* 適配深色模式的圖標 */
    .dark-mode-icon {
      @apply text-gray-800 dark:text-white;
    }
    
    /* 確保深色模式生效 */
    .dark body {
      background-color: #1a1e2c !important;
    }
    
    /* 新增夜間模式背景 */
    .night-bg {
      background-color: #1a1e2c;
      background-image: 
        radial-gradient(circle at 25px 25px, rgba(255, 255, 255, 0.15) 2%, transparent 0%), 
        radial-gradient(circle at 75px 75px, rgba(255, 255, 255, 0.15) 2%, transparent 0%);
      background-size: 100px 100px;
    }
    
    /* 更美觀的卡片底色 */
    .card-bg {
      background-color: #f7f9fc;
    }
    .dark .card-bg {
      background-color: #252d3c;
    }
    
    /* 浮動按鈕懸停效果 - 移動端優化 */
    .floating-btn {
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      box-shadow: 0 4px 12px rgba(93, 92, 222, 0.25);
      -webkit-tap-highlight-color: transparent;
    }
    .floating-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(93, 92, 222, 0.3);
    }
    /* 移動端特別觸摸回饋 */
    @media (hover: none) {
      .floating-btn:active {
        transform: translateY(-1px) scale(0.96);
      }
    }
    
    /* 導出按鈕動畫 */
    @keyframes pulse-ring {
      0% {
        box-shadow: 0 0 0 0 rgba(93, 92, 222, 0.4);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(93, 92, 222, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(93, 92, 222, 0);
      }
    }
    .btn-pulse {
      animation: pulse-ring 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
    }
    
    /* 複製成功動畫 */
    @keyframes copy-success {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    .copy-success {
      animation: copy-success 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    /* 加載動畫 - 移動端優化 */
    @keyframes loading-dots {
      0%, 20% {
        opacity: 0;
      }
      50% {
        opacity: 1;
      }
      80%, 100% {
        opacity: 0;
      }
    }
    .loading-dot:nth-child(1) {
      animation: loading-dots 1.4s infinite;
      animation-delay: 0s;
    }
    .loading-dot:nth-child(2) {
      animation: loading-dots 1.4s infinite;
      animation-delay: 0.2s;
    }
    .loading-dot:nth-child(3) {
      animation: loading-dots 1.4s infinite;
      animation-delay: 0.4s;
    }
    
    /* 標題動畫 */
    @keyframes title-glow {
      0%, 100% { text-shadow: 0 0 5px rgba(93, 92, 222, 0.2); }
      50% { text-shadow: 0 0 15px rgba(93, 92, 222, 0.4); }
    }
    .title-glow {
      animation: title-glow 3s ease-in-out infinite;
    }
    
    /* 導出成功動畫 */
    @keyframes export-success {
      0% { background-color: rgba(16, 185, 129, 0.1); }
      50% { background-color: rgba(16, 185, 129, 0.25); }
      100% { background-color: rgba(16, 185, 129, 0.1); }
    }
    .export-success-animation {
      animation: export-success 1s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* 防止輸入時页面跳動 */
    .no-scroll-jump {
      min-height: 350px;
    }
    
    /* 移動端5E點餐界面優化 */
    @media (max-width: 768px) {
      #fiveEOrderSystem .max-w-4xl {
        max-width: 100%;
        height: 100% !important;
        border-radius: 0;
      }
      
      #fiveEOrderList {
        padding-bottom: 80px; /* 為底部按鈕預留空間 */
      }
      
      #fiveEUserInfo, #fiveEOrderForm {
        padding-bottom: 20px;
      }
      
      .fiveE-category-btn {
        min-height: 44px; /* 增大可點擊區域 */
      }
    }
    
    /* 移動端骨架屏動畫 */
    @keyframes shimmer {
      0% {
        background-position: -200% 0;
      }
      100% {
        background-position: 200% 0;
      }
    }
    .skeleton-loading {
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.1) 25%, 
        rgba(255, 255, 255, 0.2) 50%, 
        rgba(255, 255, 255, 0.1) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      will-change: background-position;
    }
    .dark .skeleton-loading {
      background: linear-gradient(90deg, 
        rgba(255, 255, 255, 0.05) 25%, 
        rgba(255, 255, 255, 0.1) 50%, 
        rgba(255, 255, 255, 0.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    /* 順滑滑動動畫 */
    .smooth-slide {
      scroll-behavior: smooth;
    }
    
    /* 移動端快捷菜單動畫 */
    @keyframes slideUpMenu {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .mobile-menu {
      animation: slideUpMenu 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      will-change: transform;
    }
    
    /* 觸摸漣漪效果 */
    .ripple {
      position: relative;
      overflow: hidden;
      transform: translate3d(0, 0, 0);
      -webkit-tap-highlight-color: transparent;
    }
    .ripple::after {
      content: "";
      display: block;
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
      background-repeat: no-repeat;
      background-position: 50%;
      transform: scale(10, 10);
      opacity: 0;
      transition: transform .4s, opacity 1s;
    }
    .ripple:active::after {
      transform: scale(0, 0);
      opacity: .2;
      transition: 0s;
    }
    .dark .ripple::after {
      background-image: radial-gradient(circle, rgba(255,255,255,.2) 10%, transparent 10.01%);
    }
    
    /* 日期分类卡片样式 */
    .date-divider {
      position: relative;
      margin: 1.5rem 0;
      text-align: center;
    }
    .date-divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: rgba(156, 163, 175, 0.2);
      z-index: 1;
    }
    .date-divider-text {
      position: relative;
      display: inline-block;
      padding: 0 1rem;
      background-color: #f7f9fc;
      z-index: 2;
      font-weight: 500;
      color: #5D5CDE;
      border-radius: 0.5rem;
    }
    .dark .date-divider-text {
      background-color: #252d3c;
      color: #7676cd;
    }
  </style>
</head>
<body class="min-h-screen bg-gray-100 dark:night-bg font-sans transition-colors duration-200">
  <!-- 頂部裝飾帶 -->
  <div class="top-decoration"></div>

  <!-- 已移除顶部5E入口，改为在标题下方添加 -->

  <!-- 初始加載指示器 - 改為頂部非阻塞式 -->
  <div id="initialLoadingIndicator" class="fixed top-0 left-0 right-0 bg-white dark:bg-dark-500 shadow-md z-40 px-4 py-3 flex items-center justify-center">
    <div class="flex items-center bg-primary-50 dark:bg-primary-900/40 px-4 py-2 rounded-full border border-primary-100 dark:border-primary-800/30">
      <svg class="animate-spin h-5 w-5 mr-3 text-primary-600 dark:text-primary-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p class="text-primary-600 dark:text-primary-400 font-medium text-sm">正在同步最新訂單數據...</p>
    </div>
  </div>
  
  <!-- 5E學生專用點餐系統模態窗口 - 移動端優化版本 -->
  <div id="fiveEOrderSystem" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center z-40 hidden">
    <div class="bg-white dark:bg-dark-300 w-full md:w-11/12 max-w-4xl rounded-xl md:rounded-xl shadow-2xl animate-dialogScale overflow-auto h-[100vh] md:h-[90vh] md:overflow-hidden flex flex-col" style="height: 100dvh; max-height: 90vh; touch-action: none;">
      <!-- 頂部標題 -->
      <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-5 flex justify-between items-center">
        <div class="flex items-center">
          <div class="bg-white/20 p-3 rounded-full text-white mr-4 flex-shrink-0 shadow-lg">
            <i class="ri-school-line text-xl"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold text-white">5E 學生專用點餐系統</h3>
            <p class="text-white/80 text-sm">歡迎使用專屬訂單系統</p>
          </div>
        </div>
        <button id="closeFiveESystem" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
          <i class="ri-close-line text-xl"></i>
        </button>
      </div>
      
      <!-- 內容區域 -->
      <!-- 移動端導航欄 - 僅在移動端顯示 -->
      <div class="md:hidden flex border-b border-gray-200 dark:border-gray-700">
        <button id="fiveEFormTab" class="flex-1 py-3 px-4 bg-indigo-600 text-white font-medium">
          <i class="ri-edit-box-line mr-1.5"></i>點餐表單
        </button>
        <button id="fiveEListTab" class="flex-1 py-3 px-4 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-medium">
          <i class="ri-list-check-2 mr-1.5"></i>訂單列表
          <span id="fiveEOrderCounter" class="ml-1 px-1.5 py-0.5 bg-indigo-600 text-white text-xs rounded-full">0</span>
        </button>
      </div>
      
      <div class="flex flex-col md:flex-row flex-1 overflow-hidden">
        <!-- 點餐表單 -->
        <div id="fiveEFormView" class="md:w-1/2 p-4 md:p-6 overflow-y-auto styled-scrollbar" style="touch-action: pan-y;">
          <div id="fiveEUserInfo" class="mb-6">
            <h4 class="text-lg font-medium text-gray-800 dark:text-white mb-4 flex items-center">
              <i class="ri-user-follow-line mr-2 text-indigo-600"></i>身份信息
            </h4>
            
            <div class="space-y-4">
              <!-- 身份選擇 -->
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">您的身份是</label>
                <div class="flex space-x-4">
                  <div class="flex items-center">
                    <input type="radio" id="fiveETeacher" name="fiveEUserType" value="teacher" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                    <label for="fiveETeacher" class="ml-2 text-sm text-gray-700 dark:text-gray-300">老師</label>
                  </div>
                  <div class="flex items-center">
                    <input type="radio" id="fiveEStudent" name="fiveEUserType" value="student" checked="" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500">
                    <label for="fiveEStudent" class="ml-2 text-sm text-gray-700 dark:text-gray-300">學生</label>
                  </div>
                </div>
              </div>
              
              <!-- 姓名輸入 -->
              <div>
                <label for="fiveEName" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">姓名</label>
                <div class="relative">
                  <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                    <i class="ri-user-line"></i>
                  </span>
                  <input type="text" id="fiveEName" name="fiveEName" required="" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-dark-400 dark:text-white" placeholder="請輸入您的姓名">
                </div>
              </div>
              
              <!-- 學號輸入 (只有學生才顯示) -->
              <div id="fiveEStudentIdField">
                <label for="fiveEStudentId" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">學號</label>
                <div class="relative">
                  <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                    <i class="ri-number-5"></i>
                  </span>
                  <input type="text" id="fiveEStudentId" name="fiveEStudentId" required="" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-dark-400 dark:text-white" placeholder="請輸入您的學號">
                </div>
              </div>
            </div>
          </div>
          
          <div id="fiveEOrderForm" class="space-y-6">
            <h4 class="text-lg font-medium text-gray-800 dark:text-white mb-4 flex items-center">
              <i class="ri-restaurant-line mr-2 text-indigo-600"></i>點餐信息
            </h4>
            
            <!-- Food Category Selection -->
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">食品分類</label>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button type="button" class="fiveE-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 focus:ring-2 focus:ring-indigo-500 transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-indigo-600 active:text-white dark:active:text-white shadow-sm" data-category="pasta">
                  <i class="ri-restaurant-2-line mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>意粉
                </button>
                <button type="button" class="fiveE-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 focus:ring-2 focus:ring-indigo-500 transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-indigo-600 active:text-white dark:active:text-white shadow-sm" data-category="rice">
                  <i class="ri-cup-line mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>飯類
                </button>
                <button type="button" class="fiveE-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 focus:ring-2 focus:ring-indigo-500 transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-indigo-600 active:text-white dark:active:text-white shadow-sm" data-category="burger">
                  <i class="ri-takeaway-fill mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>漢堡
                </button>
                <button type="button" class="fiveE-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 focus:ring-2 focus:ring-indigo-500 transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-indigo-600 active:text-white dark:active:text-white shadow-sm" data-category="pizza">
                  <i class="ri-pie-chart-line mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>Pizza
                </button>
              </div>
            </div>
            
            <!-- Food Selection -->
            <div>
              <label for="fiveEFoodSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">選擇食品</label>
              <div class="relative">
                <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                  <i class="ri-restaurant-line"></i>
                </span>
                <select id="fiveEFoodSelect" name="fiveEFood" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-dark-400 dark:text-white appearance-none bg-no-repeat bg-right pr-10" style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width=\" 20\"="" height="\&quot;20\&quot;" viewbox="\&quot;0" 0="" 20="" fill="\&quot;none\&quot;" xmlns="\&quot;http://www.w3.org/2000/svg\&quot;">'); background-position: right 0.75rem center;"&gt;
                  <option value="" disabled="" selected="">請先選擇分類</option>
                </select>
              </div>
            </div>
            
            <!-- Food Requirements -->
            <div class="bg-gray-50 dark:bg-dark-200 rounded-lg p-4 border border-gray-100 dark:border-gray-700">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2.5 flex items-center">
                <i class="ri-settings-line mr-1.5 text-indigo-500"></i>食品要求
              </label>
              <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-no-pepper" name="fiveEFoodReq" value="走椒" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-no-pepper" class="ml-2 text-sm text-gray-700 dark:text-gray-300">走椒</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-extra-pepper" name="fiveEFoodReq" value="多椒" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-extra-pepper" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多椒</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-extra-garlic" name="fiveEFoodReq" value="多蒜" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-extra-garlic" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多蒜</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-extra-rice" name="fiveEFoodReq" value="多飯" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-extra-rice" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多飯</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-extra-pasta" name="fiveEFoodReq" value="多意粉" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-extra-pasta" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多意粉</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-not-spicy" name="fiveEFoodReq" value="唔辣" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-not-spicy" class="ml-2 text-sm text-gray-700 dark:text-gray-300">唔辣</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-add-egg" name="fiveEFoodReq" value="加蛋" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-add-egg" class="ml-2 text-sm text-gray-700 dark:text-gray-300">加蛋 <span class="text-xs text-red-500 dark:text-red-400">加$10 僅漢堡</span></label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-req-change-fries" name="fiveEFoodReq" value="轉薯條" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-req-change-fries" class="ml-2 text-sm text-gray-700 dark:text-gray-300">轉薯條</label>
                </div>
              </div>
            </div>
            
            <!-- Drink Selection -->
            <div>
              <label for="fiveEDrinkSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">選擇飲品</label>
              <div class="relative">
                <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                  <i class="ri-cup-line"></i>
                </span>
                <select id="fiveEDrinkSelect" name="fiveEDrink" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-dark-400 dark:text-white appearance-none bg-no-repeat bg-right pr-10" style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width=\" 20\"="" height="\&quot;20\&quot;" viewbox="\&quot;0" 0="" 20="" fill="\&quot;none\&quot;" xmlns="\&quot;http://www.w3.org/2000/svg\&quot;">'); background-position: right 0.75rem center;"&gt;
                  <option value="" selected="">不需要飲品</option>
                  <option value="檸茶">檸茶</option>
                  <option value="檸水">檸水</option>
                  <option value="奶茶">奶茶</option>
                  <option value="齋啡">齋啡</option>
                  <option value="咖啡">咖啡</option>
                </select>
              </div>
            </div>
            
            <!-- Drink Requirements -->
            <div id="fiveEDrinkReqSection" class="hidden bg-gray-50 dark:bg-dark-200 rounded-lg p-4 border border-gray-100 dark:border-gray-700">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2.5 flex items-center">
                <i class="ri-settings-line mr-1.5 text-indigo-500"></i>飲品要求
              </label>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-drink-less-ice" name="fiveEDrinkReq" value="少冰" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-drink-less-ice" class="ml-2 text-sm text-gray-700 dark:text-gray-300">少冰</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-drink-no-sugar" name="fiveEDrinkReq" value="走甜" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-drink-no-sugar" class="ml-2 text-sm text-gray-700 dark:text-gray-300">走甜</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-drink-extra-milk" name="fiveEDrinkReq" value="多奶" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-drink-extra-milk" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多奶</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-drink-less-sweet" name="fiveEDrinkReq" value="少甜" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-drink-less-sweet" class="ml-2 text-sm text-gray-700 dark:text-gray-300">少甜</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-drink-extra-sweet" name="fiveEDrinkReq" value="多甜" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-drink-extra-sweet" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多甜</label>
                </div>
                <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                  <input type="checkbox" id="fiveE-drink-hot" name="fiveEDrinkReq" value="熱飲" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                  <label for="fiveE-drink-hot" class="ml-2 text-sm text-gray-700 dark:text-gray-300">熱飲</label>
                </div>
              </div>
            </div>
            
            <!-- Submit Button -->
            <div class="pt-2">
              <button type="button" id="fiveESubmitOrderBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all transform hover:scale-[1.01] active:scale-[0.99] shadow-md">
                <i class="ri-send-plane-fill mr-2"></i>提交訂單
              </button>
            </div>
          </div>
        </div>
        
        <!-- 訂單顯示 -->
        <div id="fiveEListView" class="md:w-1/2 bg-gray-50 dark:bg-dark-400 p-6 overflow-y-auto styled-scrollbar border-t md:border-t-0 md:border-l border-gray-200 dark:border-gray-700 hidden md:block" style="touch-action: pan-y;">
          <div class="flex justify-between items-center mb-4">
            <h4 class="text-lg font-medium text-gray-800 dark:text-white flex items-center">
              <i class="ri-list-check-2 mr-2 text-indigo-600"></i>5E 訂單列表
            </h4>
            <div class="relative group">
              <button id="fiveEActionsDropdownBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-3 rounded-lg flex items-center text-sm">
                <i class="ri-more-2-fill mr-1.5"></i>操作
                <i class="ri-arrow-down-s-line ml-1"></i>
              </button>
              <div id="fiveEActionsDropdown" class="absolute right-0 mt-2 w-40 bg-white dark:bg-dark-300 rounded-lg shadow-xl border border-gray-200 dark:border-gray-700 hidden z-10">
                <ul class="py-1">
                  <li>
                    <button id="fiveEPrintBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-400 flex items-center">
                      <i class="ri-printer-line mr-2 text-blue-600"></i>打印訂單
                    </button>
                  </li>
                  <li>
                    <button id="fiveEExportOrdersBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-400 flex items-center">
                      <i class="ri-file-copy-line mr-2 text-green-600"></i>導出文本
                    </button>
                  </li>
                  <li>
                    <button id="fiveEExportExcelBtn" class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-dark-400 flex items-center">
                      <i class="ri-file-excel-line mr-2 text-purple-600"></i>導出Excel
                    </button>
                  </li>
                  <li class="border-t border-gray-100 dark:border-gray-700">
                    <button id="fiveEClearOrdersBtn" class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center">
                      <i class="ri-delete-bin-line mr-2"></i>清空訂單
                    </button>
                  </li>
                </ul>
              </div>
            </div>
          </div>
          
          <div id="fiveEOrderList" class="space-y-4 min-h-[300px]">
            <div class="text-center py-8 text-gray-500 dark:text-gray-400">
              <i class="ri-inbox-line text-4xl mb-2 block"></i>
              <p>暫無訂單</p>
              <p class="text-sm mt-1">訂單提交後將顯示在這裡</p>
            </div>
          </div>
          
          <!-- 5E訂單統計 -->
          <div class="mt-6 border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="text-lg font-medium text-gray-800 dark:text-white mb-3 flex items-center">
              <i class="ri-bar-chart-grouped-line mr-2 text-indigo-600"></i>訂單統計
            </h4>
            <div id="fiveEOrderSummary" class="bg-white dark:bg-dark-500 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
              <div class="space-y-4">
                <div>
                  <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">餐品總數</h5>
                  <div id="fiveEFoodSummary" class="space-y-2">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">暫無數據</p>
                  </div>
                </div>
                <div>
                  <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">飲品總數</h5>
                  <div id="fiveEDrinkSummary" class="space-y-2">
                    <p class="text-gray-500 dark:text-gray-400 text-sm">暫無數據</p>
                  </div>
                </div>
                <div class="pt-2 text-right">
                  <span class="text-xs text-gray-500 dark:text-gray-400" id="fiveEOrderCount">總訂單數: 0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="mx-auto px-4 py-8 max-w-6xl relative z-10">
    <!-- Header -->
    <header class="text-center mb-8 md:mb-10">
      <div class="inline-block p-1.5 px-3 bg-primary-100 dark:bg-primary-900/30 rounded-full text-primary-600 dark:text-primary-300 text-xs mb-2 font-medium tracking-wider animate-bounce-light">
        <i class="ri-restaurant-line mr-1 align-text-bottom"></i> 自動下單系統
      </div>
      <h1 class="text-3xl md:text-4xl font-bold text-gray-900 dark:text-white tracking-tight mb-1 title-glow">Pattern Automatic Ordering System</h1>
      <p class="text-gray-600 dark:text-gray-300 max-w-xl mx-auto slide-in-up">GGH Pattern</p>
      
      <!-- GGH Pattern和导出订单中间的E班开Call按钮 -->
      <div class="mt-4 flex flex-wrap justify-center gap-2">
        <button id="fiveEOrderBtn" class="flex items-center gap-1.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-smooth btn-press shadow-md border border-purple-700 hover:translate-y-0.5">
          <i class="ri-user-star-line mr-1"></i>
          <span>E班開Cell</span>
        </button>
        <a href="https://patternshare.cpuloyalty.cc/" target="_blank" rel="noopener" class="flex items-center gap-1.5 bg-gradient-to-r from-green-500 to-teal-500 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-smooth btn-press shadow-md border border-green-600 hover:translate-y-0.5">
          <i class="ri-bar-chart-2-line mr-1"></i>
          <span>三個月點單分析</span>
        </a>
        <button id="quickExportBtn" class="flex items-center gap-1.5 bg-primary-50 dark:bg-primary-900/30 hover:bg-primary-100 dark:hover:bg-primary-900/50 text-primary-600 dark:text-primary-400 px-3 py-1.5 rounded-lg text-sm font-medium transition-smooth btn-press shadow-sm border border-primary-200 dark:border-primary-800/30">
          <i class="ri-file-copy-line text-primary-500"></i>
          <span>導出訂單</span>
        </button>
      </div>
      <!-- 5E班点单提示 -->
      <p class="mt-2 text-sm text-indigo-600 dark:text-indigo-400 animate-pulse">
        <i class="ri-arrow-up-line mr-1"></i>E班同學請點擊「E班開Cell」進行點單
      </p>
    </header>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
      <!-- Order Form -->
      <div class="lg:col-span-2">
        <div class="card-bg dark:bg-dark-300 rounded-xl shadow-card p-6 md:p-8 card-hover transition-smooth relative overflow-hidden">
          <div class="relative no-scroll-jump">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white mb-6 decorative-line flex items-center slide-in-left">
              <i class="ri-file-list-3-line mr-2 text-primary-600"></i>訂單表格
            </h2>
            
            <form id="orderForm" class="space-y-6">
              <!-- Name Input -->
              <div class="slide-in-left" style="animation-delay: 0.1s">
                <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">姓名</label>
                <div class="relative">
                  <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                    <i class="ri-user-line"></i>
                  </span>
                  <input type="text" id="name" name="name" required="" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white elegant-input input-highlight" placeholder="請輸入姓名">
                </div>
              </div>
              
              <!-- Food Category Selection -->
              <div class="slide-in-left" style="animation-delay: 0.2s">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">食品分類</label>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  <button type="button" class="category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 input-focus-ring transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-primary-600 active:text-white dark:active:text-white shadow-sm" data-category="pasta">
                    <i class="ri-restaurant-2-line mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>意粉
                  </button>
                  <button type="button" class="category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 input-focus-ring transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-primary-600 active:text-white dark:active:text-white shadow-sm" data-category="rice">
                    <i class="ri-cup-line mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>飯類
                  </button>
                  <button type="button" class="category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 input-focus-ring transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-primary-600 active:text-white dark:active:text-white shadow-sm" data-category="burger">
                    <i class="ri-takeaway-fill mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>漢堡
                  </button>
                  <button type="button" class="category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-3 px-4 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 input-focus-ring transition-all duration-200 ease-out transform hover:scale-[1.02] active:scale-[0.98] active:bg-primary-600 active:text-white dark:active:text-white shadow-sm" data-category="pizza">
                    <i class="ri-pie-chart-line mr-1.5 transition-transform duration-200 group-hover:translate-y-[-1px]"></i>Pizza
                  </button>
                </div>
              </div>
              
              <!-- Food Selection -->
              <div class="slide-in-left" style="animation-delay: 0.3s">
                <label for="foodSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">選擇食品</label>
                <div class="relative">
                  <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                    <i class="ri-restaurant-line"></i>
                  </span>
                  <select id="foodSelect" name="food" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white appearance-none bg-no-repeat bg-right pr-10 elegant-input input-highlight" style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width=\" 20\"="" height="\&quot;20\&quot;" viewbox="\&quot;0" 0="" 20="" fill="\&quot;none\&quot;" xmlns="\&quot;http://www.w3.org/2000/svg\&quot;">'); background-position: right 0.75rem center;"&gt;
                    <option value="" disabled="" selected="">請先選擇分類</option>
                  </select>
                </div>
              </div>
              
              <!-- Food Requirements -->
              <div class="bg-gray-50 dark:bg-dark-200 rounded-lg p-4 border border-gray-100 dark:border-gray-700 slide-in-left" style="animation-delay: 0.4s">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2.5 flex items-center">
                  <i class="ri-settings-line mr-1.5 text-primary-500"></i>食品要求
                </label>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-no-pepper" name="foodReq" value="走椒" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-no-pepper" class="ml-2 text-sm text-gray-700 dark:text-gray-300">走椒</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-extra-pepper" name="foodReq" value="多椒" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-extra-pepper" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多椒</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-extra-garlic" name="foodReq" value="多蒜" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-extra-garlic" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多蒜</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-extra-rice" name="foodReq" value="多飯" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-extra-rice" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多飯</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-extra-pasta" name="foodReq" value="多意粉" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-extra-pasta" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多意粉</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-not-spicy" name="foodReq" value="唔辣" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-not-spicy" class="ml-2 text-sm text-gray-700 dark:text-gray-300">唔辣</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-add-egg" name="foodReq" value="加蛋" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-add-egg" class="ml-2 text-sm text-gray-700 dark:text-gray-300">加蛋 <span class="text-xs text-red-500 dark:text-red-400">加$10 僅漢堡</span></label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="req-change-fries" name="foodReq" value="轉薯條" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="req-change-fries" class="ml-2 text-sm text-gray-700 dark:text-gray-300">轉薯條</label>
                  </div>
                </div>
              </div>
              
              <!-- Drink Selection -->
              <div class="slide-in-left" style="animation-delay: 0.5s">
                <label for="drinkSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">選擇飲品</label>
                <div class="relative">
                  <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                    <i class="ri-cup-line"></i>
                  </span>
                  <select id="drinkSelect" name="drink" class="w-full pl-10 px-4 py-3 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white appearance-none bg-no-repeat bg-right pr-10 elegant-input input-highlight" style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width=\" 20\"="" height="\&quot;20\&quot;" viewbox="\&quot;0" 0="" 20="" fill="\&quot;none\&quot;" xmlns="\&quot;http://www.w3.org/2000/svg\&quot;">'); background-position: right 0.75rem center;"&gt;
                    <option value="" selected="">不需要飲品</option>
                    <option value="檸茶">檸茶</option>
                    <option value="檸水">檸水</option>
                    <option value="奶茶">奶茶</option>
                    <option value="齋啡">齋啡</option>
                    <option value="咖啡">咖啡</option>
                  </select>
                </div>
              </div>
              
              <!-- Drink Requirements -->
              <div id="drinkReqSection" class="hidden bg-gray-50 dark:bg-dark-200 rounded-lg p-4 border border-gray-100 dark:border-gray-700 slide-in-left" style="animation-delay: 0.6s">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2.5 flex items-center">
                  <i class="ri-settings-line mr-1.5 text-primary-500"></i>飲品要求
                </label>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="drink-less-ice" name="drinkReq" value="少冰" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="drink-less-ice" class="ml-2 text-sm text-gray-700 dark:text-gray-300">少冰</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="drink-no-sugar" name="drinkReq" value="走甜" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="drink-no-sugar" class="ml-2 text-sm text-gray-700 dark:text-gray-300">走甜</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="drink-extra-milk" name="drinkReq" value="多奶" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="drink-extra-milk" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多奶</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="drink-less-sweet" name="drinkReq" value="少甜" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="drink-less-sweet" class="ml-2 text-sm text-gray-700 dark:text-gray-300">少甜</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="drink-extra-sweet" name="drinkReq" value="多甜" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="drink-extra-sweet" class="ml-2 text-sm text-gray-700 dark:text-gray-300">多甜</label>
                  </div>
                  <div class="flex items-center bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600">
                    <input type="checkbox" id="drink-hot" name="drinkReq" value="熱飲" class="h-4 w-4 text-primary-600 focus:ring-primary-200 border-gray-300 rounded custom-checkbox">
                    <label for="drink-hot" class="ml-2 text-sm text-gray-700 dark:text-gray-300">熱飲</label>
                  </div>
                </div>
              </div>
              
              <!-- Submit Button -->
              <div class="pt-2 slide-in-left" style="animation-delay: 0.7s">
                <button type="submit" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-smooth transform hover:scale-[1.01] active:scale-[0.99] btn-press shadow-md">
                  <i class="ri-send-plane-fill mr-2"></i>提交訂單
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- Summary Display -->
      <div>
        <div class="card-bg dark:bg-dark-300 rounded-xl shadow-card p-6 md:p-7 card-hover transition-smooth sticky top-4 slide-in-right">
          <div class="flex justify-between items-center mb-5">
            <h2 class="text-xl font-semibold text-gray-800 dark:text-white decorative-line flex items-center">
              <i class="ri-file-list-line mr-2 text-primary-600"></i>訂單匯總
            </h2>
            <div>
              <button id="toggleAdmin" class="text-sm bg-white dark:bg-dark-400 border border-primary-200 dark:border-primary-700/30 hover:bg-primary-50 dark:hover:bg-primary-700/20 text-primary-600 dark:text-primary-400 font-medium py-1.5 px-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500/30 focus:ring-offset-2 transition-smooth btn-press shadow-sm flex items-center transform active:scale-95">
                <i class="ri-user-settings-line mr-1.5"></i>
                <span class="hidden sm:inline">管理員</span>
              </button>
            </div>
          </div>
          
          <!-- Summary Content -->
          <div id="summaryContent" class="prose dark:prose-invert max-w-none overflow-y-auto styled-scrollbar gradient-bg p-4 rounded-lg" style="max-height: 500px;">
            <div class="flex flex-col items-center justify-center text-center py-8">
              <div class="text-gray-300 dark:text-gray-600 mb-3">
                <svg class="animate-spin h-10 w-10 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
              <p class="text-gray-600 dark:text-gray-400">正在載入訂單數據...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Mobile Export Button (Only visible on mobile) -->
    <div class="lg:hidden fixed bottom-4 right-4 z-30">
      <button id="mobileExportBtn" class="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition-smooth btn-press">
        <i class="ri-file-copy-line text-xl"></i>
      </button>
    </div>
    
    <!-- 訂單分析面板 -->
    <div id="orderAnalysisPanel" class="fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center hidden">
      <div class="bg-white dark:bg-dark-300 max-w-3xl w-11/12 rounded-xl shadow-2xl animate-dialogScale p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center">
            <i class="ri-bar-chart-boxed-line text-xl text-green-600 mr-2"></i>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">訂單分析與統計</h3>
          </div>
          <button id="closeOrderAnalysisPanel" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-1.5 transition-colors hover:bg-gray-100 dark:hover:bg-dark-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <!-- 統計卡片 -->
          <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
            <h4 class="text-base font-medium text-gray-800 dark:text-white mb-2 flex items-center">
              <i class="ri-pie-chart-line text-green-500 mr-1.5"></i>訂單分佈
            </h4>
            <div id="orderCategoryChart" class="h-40" style="position: relative;">
              <canvas id="orderCategoryCanvas"></canvas>
            </div>
          </div>
          
          <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
            <h4 class="text-base font-medium text-gray-800 dark:text-white mb-2 flex items-center">
              <i class="ri-bar-chart-fill text-blue-500 mr-1.5"></i>熱門餐品
            </h4>
            <div id="popularItemsChart" class="h-40" style="position: relative;">
              <canvas id="popularItemsCanvas"></canvas>
            </div>
          </div>
        </div>
        
        <div id="analysisContent" class="bg-gray-50 dark:bg-dark-200 rounded-lg border border-gray-200 dark:border-gray-700 p-4">
          <div class="flex items-center space-x-4 mb-4">
            <button id="dailyStatsTab" class="px-3 py-2 bg-green-500 text-white rounded-lg text-sm font-medium">日消費統計</button>
            <button id="weeklyTrendsTab" class="px-3 py-2 bg-gray-200 dark:bg-dark-400 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium">週趨勢分析</button>
            <button id="userPreferencesTab" class="px-3 py-2 bg-gray-200 dark:bg-dark-400 text-gray-700 dark:text-gray-300 rounded-lg text-sm font-medium">用戶偏好</button>
          </div>
          
          <div id="dailyStatsContent" class="space-y-4">
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
              <h5 class="text-sm font-medium text-gray-800 dark:text-white mb-2">今日消費統計</h5>
              <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                <div class="bg-green-50 dark:bg-green-900/20 p-3 rounded-md text-center">
                  <p class="text-xs text-green-600 dark:text-green-400">總訂單數</p>
                  <p id="totalOrdersToday" class="text-xl font-bold text-green-700 dark:text-green-300">0</p>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 p-3 rounded-md text-center">
                  <p class="text-xs text-blue-600 dark:text-blue-400">總消費額</p>
                  <p id="totalSpendingToday" class="text-xl font-bold text-blue-700 dark:text-blue-300">$0</p>
                </div>
                <div class="bg-purple-50 dark:bg-purple-900/20 p-3 rounded-md text-center">
                  <p class="text-xs text-purple-600 dark:text-purple-400">平均消費</p>
                  <p id="avgSpendingToday" class="text-xl font-bold text-purple-700 dark:text-purple-300">$0</p>
                </div>
              </div>
            </div>
            
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
              <h5 class="text-sm font-medium text-gray-800 dark:text-white mb-2">最受歡迎項目</h5>
              <div id="popularItemsList" class="space-y-2">
                <div class="animate-pulse flex space-x-2">
                  <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                  <div class="flex-1 h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
                <div class="animate-pulse flex space-x-2">
                  <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                  <div class="flex-1 h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
                <div class="animate-pulse flex space-x-2">
                  <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                  <div class="flex-1 h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
              </div>
            </div>
          </div>
          
          <div id="weeklyTrendsContent" class="hidden space-y-4">
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
              <h5 class="text-sm font-medium text-gray-800 dark:text-white mb-2">週訂單趨勢</h5>
              <div id="weeklyOrdersChart" class="h-52" style="position: relative;">
                <canvas id="weeklyOrdersCanvas"></canvas>
              </div>
            </div>
            
            <!-- 歷史訂單記錄查看部分 -->
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700 mt-4">
              <h5 class="text-sm font-medium text-gray-800 dark:text-white mb-2 flex items-center">
                <i class="ri-history-line text-blue-500 mr-1.5"></i>歷史訂單記錄
              </h5>
              <div id="orderHistoryList" class="max-h-[200px] overflow-y-auto styled-scrollbar">
                <div class="text-center py-4">
                  <p class="text-gray-500 dark:text-gray-400">加載歷史訂單記錄...</p>
                </div>
              </div>
            </div>
          </div>
          
          <div id="userPreferencesContent" class="hidden space-y-4">
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700">
              <h5 class="text-sm font-medium text-gray-800 dark:text-white mb-2">用戶偏好分析</h5>
              <div id="userPreferencesList" class="space-y-2">
                <div class="animate-pulse flex space-x-2">
                  <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                  <div class="flex-1 h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
                <div class="animate-pulse flex space-x-2">
                  <div class="h-4 w-4 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                  <div class="flex-1 h-4 bg-gray-200 dark:bg-gray-700 rounded"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 管理員登錄彈窗 - 新設計 -->
    <div id="adminLoginDialog" class="fixed inset-0 z-50 hidden">
      <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm"></div>
      <div class="fixed inset-0 flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl shadow-2xl animate-dialogScale">
          <!-- 標題區域 - 漸變背景 -->
          <div class="bg-gradient-to-r from-primary-600 to-primary-500 dark:from-primary-700 dark:to-primary-500 p-5 rounded-t-xl relative overflow-hidden">
            <!-- 裝飾圓點 -->
            <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
            <div class="absolute bottom-0 left-10 w-16 h-16 bg-white/10 rounded-full translate-y-1/2"></div>
            
            <div class="flex items-center justify-between relative z-10">
              <div class="flex items-center">
                <div class="bg-white/20 p-3 rounded-full text-white mr-4 flex-shrink-0 shadow-lg">
                  <i class="ri-shield-keyhole-line text-xl"></i>
                </div>
                <div>
                  <h3 class="text-xl font-bold text-white">管理員登入</h3>
                  <p class="text-white/80 text-sm">請輸入您的管理員密碼繼續操作</p>
                </div>
              </div>
              <button id="closeAdminLoginDialog" class="text-white/80 hover:text-white hover:bg-white/20 rounded-full p-2 transition-all">
                <i class="ri-close-line text-xl"></i>
              </button>
            </div>
          </div>
          
          <!-- 內容區域 -->
          <div class="p-6">
            <!-- 錯誤提示 -->
            <div id="loginError" class="hidden bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 dark:border-red-500 text-red-700 dark:text-red-300 rounded-r-lg p-4 mb-5 text-sm flex items-start animate-shakeX">
              <i class="ri-error-warning-line text-red-500 dark:text-red-400 text-lg mr-2.5 flex-shrink-0 mt-0.5"></i>
              <span id="loginErrorText">密碼輸入錯誤，請重試。</span>
            </div>
            
            <!-- 密碼輸入框 - 改進樣式 -->
            <div class="mb-4">
              <label for="adminPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">管理員密碼</label>
              <div class="group relative">
                <span class="absolute left-4 inset-y-0 flex items-center text-gray-500 dark:text-gray-400 group-focus-within:text-primary-500 transition-colors">
                  <i class="ri-lock-password-line text-lg"></i>
                </span>
                <input type="password" id="adminPassword" class="w-full pl-11 pr-10 py-3.5 text-base border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:border-primary-500 dark:focus:border-primary-500 focus:ring-4 focus:ring-primary-500/20 dark:focus:ring-primary-500/20 outline-none dark:bg-dark-400 dark:text-white transition-all duration-200" placeholder="請輸入管理員密碼">
                <!-- 顯示/隱藏密碼按鈕 -->
                <button type="button" id="togglePassword" class="absolute right-4 inset-y-0 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none">
                  <i class="ri-eye-off-line text-lg"></i>
                </button>
              </div>
            </div>
            
            <!-- 記住我選項 - 更好的複選框樣式 -->
            <div class="flex items-center mb-6">
              <div class="relative w-5 h-5">
                <input type="checkbox" id="rememberAdmin" name="rememberAdmin" checked="" class="absolute w-5 h-5 opacity-0 cursor-pointer peer">
                <div class="w-5 h-5 border-2 border-gray-300 dark:border-gray-500 rounded transition-colors peer-checked:bg-primary-500 peer-checked:border-primary-500 peer-focus:ring-4 peer-focus:ring-primary-500/20"></div>
                <i class="ri-check-line text-white text-sm absolute top-0.5 left-0.5 opacity-0 peer-checked:opacity-100 transition-opacity"></i>
              </div>
              <label for="rememberAdmin" class="ml-2.5 text-sm text-gray-700 dark:text-gray-300 cursor-pointer select-none">記住我的登入狀態</label>
            </div>
            
            <!-- 按鈕區域 - 全寬登入按鈕 -->
            <div class="space-y-3">
              <button id="adminLoginBtn" class="relative w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold py-3.5 px-6 rounded-xl focus:outline-none focus:ring-4 focus:ring-primary-500/30 transition-all duration-200 transform active:scale-[0.98] shadow-lg shadow-primary-600/30 overflow-hidden group">
                <span id="loginBtnText" class="flex items-center justify-center group-hover:translate-x-1 transition-transform">
                  <i class="ri-login-box-line mr-2 text-lg"></i>登入管理系統
                </span>
                <span id="loginBtnLoading" class="absolute inset-0 flex items-center justify-center bg-primary-600 hidden">
                  <svg class="animate-spin h-6 w-6 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                  </svg>
                </span>
              </button>
              
              <button id="cancelAdminLogin" class="w-full bg-transparent hover:bg-gray-100 dark:hover:bg-dark-200 text-gray-600 dark:text-gray-400 font-medium py-2.5 px-4 rounded-xl transition-colors border border-gray-200 dark:border-gray-700 flex items-center justify-center">
                <i class="ri-arrow-left-line mr-1.5"></i>返回點餐系統
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Admin Panel (Hidden by default) -->
    <div id="adminPanel" class="fixed inset-0 z-50 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center hidden">
      <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl shadow-2xl animate-dialogScale p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
          <div class="flex items-center">
            <i class="ri-settings-4-line text-xl text-primary-600 mr-2"></i>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-white">管理員功能</h3>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex items-center">
              <span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
              <p id="adminName" class="text-sm font-medium text-primary-600">已登入</p>
            </div>
            <button id="closeAdminPanel" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-1.5 transition-colors hover:bg-gray-100 dark:hover:bg-dark-200">
              <i class="ri-close-line text-xl"></i>
            </button>
          </div>
        </div>
        
        <div id="adminFullAccess" class="space-y-3 hidden">
          <!-- 超級管理員功能：高級管理工具 -->
          <div class="bg-white dark:bg-slate-800 shadow-xl rounded-xl overflow-hidden mb-3">
            <div class="bg-gradient-to-r from-slate-800 to-slate-700 dark:from-slate-900 dark:to-slate-800 p-3 flex items-center justify-between">
              <h4 class="text-base font-medium text-white flex items-center">
                <i class="ri-dashboard-3-line text-sky-400 mr-2"></i>管理控制台
              </h4>
              <!-- 更新版本號為 V4.3.3 -->
              <span class="text-xs bg-sky-500/20 text-sky-300 px-2 py-0.5 rounded-full">V4.3.3</span>
            </div>
            
            <div class="px-3 py-3">
              <div class="flex items-center mb-3">
                <div class="w-1 h-4 bg-sky-500 rounded-full mr-2"></div>
                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300">系統監控</h5>
              </div>
              
              <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="checkNetworkStateBtn" type="button" class="group bg-slate-100 hover:bg-sky-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-sky-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-radar-line mr-1.5 text-sky-500 group-hover:animate-pulse"></i>網絡診斷
                </button>
                <button id="refreshCloudStateBtn" type="button" class="group bg-slate-100 hover:bg-emerald-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-emerald-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-refresh-line mr-1.5 text-emerald-500 group-hover:rotate-180 transition-transform duration-500"></i>刷新狀態
                </button>
              </div>
              
              <div class="flex items-center mb-3">
                <div class="w-1 h-4 bg-indigo-500 rounded-full mr-2"></div>
                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300">數據管理</h5>
              </div>
              
              <div class="grid grid-cols-2 gap-2 mb-4">
                <button id="dataExportBtn" type="button" class="group bg-slate-100 hover:bg-purple-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-purple-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-file-excel-2-line mr-1.5 text-purple-500"></i>數據導出
                </button>
                <button id="showHistoryBtn" type="button" class="group bg-slate-100 hover:bg-blue-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-blue-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-history-line mr-1.5 text-blue-500"></i>歷史記錄
                </button>
                <button id="orderAnalysisBtn" type="button" class="col-span-2 group bg-slate-100 hover:bg-indigo-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-indigo-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-bar-chart-boxed-line mr-1.5 text-indigo-500"></i>數據分析<span class="ml-1.5 text-[10px] uppercase font-bold bg-indigo-500/20 dark:bg-indigo-500/30 text-indigo-600 dark:text-indigo-300 px-1 py-0.5 rounded">Pro</span>
                </button>
              </div>
              
              <div class="flex items-center mb-3">
                <div class="w-1 h-4 bg-amber-500 rounded-full mr-2"></div>
                <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300">高級功能</h5>
              </div>
              
              <div class="grid grid-cols-2 gap-2">
                <button id="systemSettingsBtn" type="button" class="group bg-slate-100 hover:bg-amber-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-amber-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-settings-3-line mr-1.5 text-amber-500"></i>系統設置
                </button>
                <button id="bulkOperationsBtn" type="button" class="group bg-slate-100 hover:bg-rose-50 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 border-l-2 border-rose-500 font-medium py-2.5 px-3 rounded focus:outline-none transition-all duration-300 btn-press flex items-center justify-center text-sm">
                  <i class="ri-group-line mr-1.5 text-rose-500"></i>批量操作
                </button>
              </div>
            </div>
          </div>
          
          <button id="generateSummaryBtn" type="button" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex items-center justify-center">
            <i class="ri-file-list-3-line mr-1.5"></i>手動生成匯總
          </button>
          
          <button id="clearOrdersBtn" type="button" class="w-full bg-red-600 hover:bg-red-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex items-center justify-center">
            <i class="ri-delete-bin-line mr-1.5"></i>清除所有訂單
          </button>
          
          <button id="modifyOrdersBtn" type="button" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex items-center justify-center">
            <i class="ri-edit-2-line mr-1.5"></i>修改訂單
          </button>
          
          <div class="bg-gray-50 dark:bg-dark-200 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
            <label for="exportFormat" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 flex items-center">
              <i class="ri-file-download-line mr-1.5 text-primary-500"></i>導出格式
            </label>
            <div class="flex gap-2">
              <select id="exportFormat" class="flex-1 px-4 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white appearance-none bg-no-repeat bg-right pr-10 elegant-input input-highlight" style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width=\" 20\"="" height="\&quot;20\&quot;" viewbox="\&quot;0" 0="" 20="" fill="\&quot;none\&quot;" xmlns="\&quot;http://www.w3.org/2000/svg\&quot;">'); background-position: right 0.75rem center;"&gt;
                <option value="text">文本格式</option>
                <option value="markdown">Markdown格式</option>
              </select>
              <button id="exportSummaryBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex-shrink-0">
                <i class="ri-download-2-line"></i>
              </button>
            </div>
          </div>
          
          <!-- Cloudflare Sync Section -->
          <div class="pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">
            <div class="flex items-center mb-3">
              <i class="ri-cloud-line text-lg text-primary-600 mr-2"></i>
              <h4 class="text-md font-medium text-gray-800 dark:text-white">雲端同步</h4>
            </div>
            <div class="flex gap-2 mb-3">
              <button id="syncToCloudflareBtn" type="button" class="flex-1 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-smooth btn-press shadow-md">
                <span id="syncToCloudflareText"><i class="ri-upload-cloud-line mr-1.5"></i>推送</span>
                <span id="syncToCloudflareSpinner" class="hidden ml-2 inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full spin"></span>
              </button>
              <button id="syncFromCloudflareBtn" type="button" class="flex-1 flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-smooth btn-press shadow-md">
                <span id="syncFromCloudflareText"><i class="ri-download-cloud-line mr-1.5"></i>拉取</span>
                <span id="syncFromCloudflareSpinner" class="hidden ml-2 inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full spin"></span>
              </button>
            </div>
            <div class="relative">
              <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                <i class="ri-link"></i>
              </span>
              <input type="text" id="apiEndpoint" class="w-full pl-10 px-4 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white elegant-input input-highlight" placeholder="API 端點 (例如: https://api.cpuloyalty.cc)" value="https://api.cpuloyalty.cc">
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center">
              <i class="ri-information-line mr-1"></i>設置您的 API 端點
            </p>
          </div>
        </div>
        
        <div id="adminViewAccess" class="space-y-3 hidden">
          <div class="bg-blue-50 dark:bg-blue-900/20 text-blue-800 dark:text-blue-200 p-3 rounded-lg text-sm flex items-start">
            <i class="ri-information-line text-blue-500 text-lg mr-2 flex-shrink-0 mt-0.5"></i>
            <p>您可以管理和刪除訂單並同步到雲端。</p>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-2">
            <button id="modifyOrdersViewBtn" type="button" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex items-center justify-center">
              <i class="ri-edit-2-line mr-1.5"></i>修改訂單
            </button>
            
            <button id="generateSummaryViewBtn" type="button" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex items-center justify-center">
              <i class="ri-file-list-3-line mr-1.5"></i>生成匯總
            </button>
          </div>
          
          <div class="bg-gray-50 dark:bg-dark-200 p-3 rounded-lg border border-gray-100 dark:border-gray-700">
            <label for="exportFormatView" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5 flex items-center">
              <i class="ri-file-download-line mr-1.5 text-primary-500"></i>導出格式
            </label>
            <div class="flex gap-2">
              <select id="exportFormatView" class="flex-1 px-4 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white appearance-none bg-no-repeat bg-right pr-10 elegant-input input-highlight" style="background-image: url('data:image/svg+xml;charset=US-ASCII,<svg width=\" 20\"="" height="\&quot;20\&quot;" viewbox="\&quot;0" 0="" 20="" fill="\&quot;none\&quot;" xmlns="\&quot;http://www.w3.org/2000/svg\&quot;">'); background-position: right 0.75rem center;"&gt;
                <option value="text">文本格式</option>
                <option value="markdown">Markdown格式</option>
              </select>
              <button id="exportSummaryViewBtn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex-shrink-0">
                <i class="ri-download-2-line"></i>
              </button>
            </div>
          </div>
          
          <!-- Cloudflare Sync for View Access -->
          <div class="pt-4 border-t border-gray-200 dark:border-gray-700 mt-4">
            <div class="flex items-center mb-3">
              <i class="ri-cloud-line text-lg text-primary-600 mr-2"></i>
              <h4 class="text-md font-medium text-gray-800 dark:text-white">雲端同步</h4>
            </div>
            <div class="flex gap-2 mb-3">
              <button id="syncToCloudflareViewBtn" type="button" class="flex-1 flex items-center justify-center bg-blue-500 hover:bg-blue-600 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-smooth btn-press shadow-md">
                <span id="syncToCloudflareTextView"><i class="ri-upload-cloud-line mr-1.5"></i>推送到雲端</span>
                <span id="syncToCloudflareSpinnerView" class="hidden ml-2 inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full spin"></span>
              </button>
              <button id="syncFromCloudflareViewBtn" type="button" class="flex-1 flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-smooth btn-press shadow-md">
                <span id="syncFromCloudflareTextView"><i class="ri-download-cloud-line mr-1.5"></i>從雲端拉取</span>
                <span id="syncFromCloudflareSpinnerView" class="hidden ml-2 inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full spin"></span>
              </button>
            </div>
            <div class="relative">
              <span class="absolute left-3 inset-y-0 flex items-center text-gray-500 dark:text-gray-400">
                <i class="ri-link"></i>
              </span>
              <input type="text" id="apiEndpointView" class="w-full pl-10 px-4 py-2.5 text-base border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-400 dark:text-white elegant-input input-highlight" placeholder="API 端點 (例如: https://api.cpuloyalty.cc)" value="https://api.cpuloyalty.cc">
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1 flex items-center">
              <i class="ri-information-line mr-1"></i>設置您的 API 端點
            </p>
          </div>
        </div>
        
        <button id="adminLogoutBtn" class="w-full mt-4 bg-gray-100 dark:bg-dark-200 hover:bg-gray-200 dark:hover:bg-dark-100 text-gray-700 dark:text-gray-300 font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 transition-smooth btn-press shadow-sm flex items-center justify-center">
          <i class="ri-logout-box-line mr-1.5"></i>登出
        </button>
      </div>
    </div>
    
    <!-- Order Modification Panel (Hidden by default) -->
    <div id="modifyOrdersPanel" class="hidden fixed inset-0 z-50 bg-black bg-opacity-40 backdrop-blur-sm flex items-center justify-center">
      <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl shadow-2xl animate-dialogScale p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-3">
          <div class="flex items-center">
            <i class="ri-edit-line text-lg text-primary-600 mr-2"></i>
            <h3 class="text-lg font-medium text-gray-800 dark:text-white">修改訂單</h3>
          </div>
          <button id="backToAdminBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-1.5 transition-colors hover:bg-gray-100 dark:hover:bg-dark-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        <div id="orderList" class="space-y-3 max-h-[70vh] overflow-y-auto styled-scrollbar">
          <!-- Order items will be inserted here -->
        </div>
      </div>
    </div>
    
    <!-- Universal Loading Indicator -->
    <div id="loadingIndicator" class="fixed inset-0 bg-black bg-opacity-30 backdrop-blur-sm flex items-center justify-center hidden z-50">
      <div class="bg-white dark:bg-dark-300 rounded-xl shadow-xl p-6 max-w-sm w-11/12 animate-pulse">
        <div class="flex items-center">
          <div class="relative mr-4">
            <div class="w-12 h-12 rounded-full border-4 border-primary-200 dark:border-primary-800"></div>
            <div class="w-12 h-12 rounded-full border-4 border-t-primary-600 absolute top-0 left-0 animate-spin"></div>
          </div>
          <div class="flex-1">
            <h3 id="loadingTitle" class="text-gray-800 dark:text-white font-medium text-lg">正在處理</h3>
            <p id="loadingText" class="text-gray-600 dark:text-gray-300 text-sm mt-1">請稍候...</p>
          </div>
        </div>
        <div class="mt-4 bg-gray-100 dark:bg-dark-600 rounded-full h-2 overflow-hidden">
          <div id="loadingProgress" class="h-full bg-primary-600 dark:bg-primary-500 transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="fixed bottom-4 right-4 max-w-md bg-white dark:bg-dark-300 border border-gray-200 dark:border-gray-700 shadow-card px-4 py-3 rounded-lg hidden fade-in z-50">
      <div class="flex items-center">
        <div id="statusIcon" class="flex-shrink-0 h-5 w-5 mr-3"></div>
        <span id="statusMessageText" class="text-gray-800 dark:text-gray-100">操作成功</span>
      </div>
    </div>

    <!-- Cloud Sync Indicator -->
    <div id="cloudSyncIndicator" class="fixed top-4 right-4 flex items-center bg-white dark:bg-dark-300 border border-gray-200 dark:border-gray-700 shadow-card px-3 py-2 rounded-lg text-sm hidden fade-in z-40">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-primary-600 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="12" y1="2" x2="12" y2="6"></line>
        <line x1="12" y1="18" x2="12" y2="22"></line>
        <line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line>
        <line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line>
        <line x1="2" y1="12" x2="6" y2="12"></line>
        <line x1="18" y1="12" x2="22" y2="12"></line>
        <line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line>
        <line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line>
      </svg>
      <span id="cloudSyncText" class="text-gray-800 dark:text-gray-100">正在同步到雲端...</span>
    </div>
    
    <!-- Confirmation Dialog -->
    <div id="confirmDialog" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl p-6 shadow-floating dialog-enter">
        <div class="mb-5 flex items-start">
          <div class="bg-red-100 dark:bg-red-900/30 p-2 rounded-full text-red-600 dark:text-red-400 mr-3 flex-shrink-0">
            <i class="ri-error-warning-line text-xl"></i>
          </div>
          <div>
            <h3 id="confirmTitle" class="text-lg font-semibold text-gray-800 dark:text-white mb-1">確認操作</h3>
            <p id="confirmMessage" class="text-gray-600 dark:text-gray-300">您確定要執行此操作嗎？</p>
          </div>
        </div>
        <div class="flex space-x-3 justify-end">
          <button id="confirmCancel" class="px-4 py-2 bg-gray-200 dark:bg-dark-200 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-dark-100 btn-press shadow-sm flex items-center">
            <i class="ri-close-line mr-1"></i>取消
          </button>
          <button id="confirmOk" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 btn-press shadow-md flex items-center">
            <i class="ri-check-line mr-1"></i>確定
          </button>
        </div>
      </div>
    </div>

    <!-- Welcome Dialog -->
    <div id="welcomeDialog" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center z-100 hidden" style="z-index: 100;">
      <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl p-6 shadow-floating welcome-pop overflow-hidden relative">
        <div class="text-center relative">
          <div class="inline-block p-3 bg-primary-100 dark:bg-primary-800/50 rounded-full mb-4">
            <i class="ri-check-double-line text-primary-600 dark:text-primary-400 text-2xl"></i>
          </div>
          <h3 id="welcomeTitle" class="text-xl font-bold text-gray-800 dark:text-white mb-4">歡迎!</h3>
          <p id="welcomeMessage" class="text-gray-700 dark:text-gray-300 text-lg font-medium mb-6">好嘢！<span id="welcomeName"></span>好嘢！<span class="thumbs-up text-xl">👍🏻</span></p>
          <button id="welcomeOk" class="w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 transition-smooth btn-press shadow-md">
            <i class="ri-check-line mr-1.5"></i>我知道了
          </button>
        </div>
      </div>
    </div>
    
    <!-- Export Success Dialog -->
    <div id="exportSuccessDialog" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl p-6 shadow-floating welcome-pop overflow-hidden relative">
        <div class="text-center relative">
          <div class="inline-block p-3 bg-green-100 dark:bg-green-800/50 rounded-full mb-4 copy-success">
            <i class="ri-file-copy-line text-green-600 dark:text-green-400 text-2xl"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">導出成功！</h3>
          <p class="text-gray-700 dark:text-gray-300 text-base mb-6">訂單信息已成功複製到剪貼板。</p>
          <button id="exportSuccessOk" class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2.5 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-smooth btn-press shadow-md">
            <i class="ri-check-line mr-1.5"></i>確定
          </button>
        </div>
      </div>
    </div>
    
    <!-- 更新版本號為 V4.3.3 -->
    <div class="fixed bottom-4 left-4 flex items-center gap-1 bg-blue-100 dark:bg-blue-800/30 border border-blue-200 dark:border-blue-700 rounded-md px-2 py-1 text-xs text-blue-800 dark:text-blue-100 shadow-sm">
      <i class="ri-information-line"></i>
      <span id="versionBadge" class="cursor-pointer hover:underline">V4.3.3</span>
    </div>
    
    <!-- Version History Modal - 更新版本歷史信息 -->
    <div id="versionModal" class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center z-50 hidden">
      <div class="bg-white dark:bg-dark-300 max-w-md w-11/12 rounded-xl p-6 shadow-floating dialog-enter max-h-[80vh] overflow-auto">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold text-gray-800 dark:text-white">版本歷史</h3>
          <button id="closeVersionModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
            <i class="ri-close-line text-xl"></i>
          </button>
        </div>
        <div class="space-y-4">
          <!-- 添加新版本 V4.3.0 -->
          <div class="border-l-2 border-primary-500 pl-4 py-1">
            <h4 class="text-base font-medium text-gray-800 dark:text-white flex items-center">
              V4.3.3 <span class="ml-2 text-xs bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 px-2 py-0.5 rounded-full">最新版本</span>
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">調整版本號和增加功能優化</p>
            <ul class="mt-2 space-y-1 list-disc list-inside text-sm text-gray-600 dark:text-gray-400">
              <li>添加「E班開Cell」功能，支持5E班級專用點餐</li>
              <li>添加「三個月點單分析」鏈接功能</li>
              <li>優化系統底層運行機制</li>
              <li>提升雲端數據同步穩定性</li>
              <li>修復輕微顯示問題</li>
              <li>更新系統版本號至V4.3.3</li>
            </ul>
          </div>
          
          <!-- V4.2.0 版本說明 -->
          <div class="border-l-2 border-gray-300 dark:border-gray-700 pl-4 py-1 mt-4">
            <h4 class="text-base font-medium text-gray-700 dark:text-gray-300 flex items-center">
              V4.2.0
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">界面風格更新及每日自動保存訂單功能</p>
            <ul class="mt-2 space-y-1 list-disc list-inside text-sm text-gray-600 dark:text-gray-400">
              <li>UI 更優雅</li>
              <li>每日凌晨自動保存當天訂單至管理員控制台，並保留歷史記錄</li>
              <li>版本號改為 V4.2.0</li>
              <li>優化整體使用體驗，修復一些 UI 細節問題</li>
            </ul>
          </div>
          
          <!-- 保留原 V4.1.3 與其他版本歷史 -->
          <div class="border-l-2 border-gray-300 dark:border-gray-700 pl-4 py-1 mt-4">
            <h4 class="text-base font-medium text-gray-700 dark:text-gray-300 flex items-center">
              V4.1.3
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">管理員功能優化與自動化訂單管理</p>
            <ul class="mt-2 space-y-1 list-disc list-inside text-sm text-gray-600 dark:text-gray-400">
              <li>新增每天凌晨1:00自動刪除訂單汇總功能</li>
              <li>自動保存歷史訂單記錄，方便後續查詢</li>
              <li>修復歷史記錄按鈕點擊無反應問題</li>
              <li>權限調整：下放部分管理工具給普通管理員</li>
              <li>優化訂單存儲邏輯，提高數據安全性</li>
              <li>提升系統整體穩定性和性能表現</li>
            </ul>
          </div>
          
          <div class="border-l-2 border-gray-300 dark:border-gray-700 pl-4 py-1 mt-4">
            <h4 class="text-base font-medium text-gray-700 dark:text-gray-300 flex items-center">
              V3.2.0
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">雲端同步與導出格式優化</p>
            <ul class="mt-2 space-y-1 list-disc list-inside text-sm text-gray-600 dark:text-gray-400">
              <li>系統啟動時自動從雲端同步最新訂單數據</li>
              <li>優化餐品和飲品匯總格式，直接包含個人要求詳情</li>
              <li>改進導出格式，更清晰顯示各成員的餐品和飲料要求</li>
              <li>簡化導出內容，移除冗餘的個人訂單詳情部分</li>
              <li>增加初始加載指示器，提供更好的用戶體驗</li>
            </ul>
          </div>
          
          <div class="border-l-2 border-gray-300 dark:border-gray-700 pl-4 py-1 mt-4">
            <h4 class="text-base font-medium text-gray-700 dark:text-gray-300 flex items-center">
              V3.1.0
            </h4>
            <p class="text-sm text-gray-600 dark:text-gray-300 mt-1">訂單顯示與管理員功能優化</p>
            <ul class="mt-2 space-y-1 list-disc list-inside text-sm text-gray-600 dark:text-gray-400">
              <li>重新設計訂單匯總格式，按人分組顯示餐品和飲料要求</li>
              <li>美化導出格式，使用表情符號和分隔線增强可讀性</li>
              <li>升級匯總報表，使同一人的食物和飲料要求整合顯示</li>
              <li>優化導出按鈕設計與交互體驗</li>
              <li>為管理員按鈕增加更明顯的交互反饋</li>
              <li>清理界面，移除"未同步"等不必要提示</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Menu Data
    const menuData = {
      pasta: [
        { name: "卡邦尼煙肉蘑菇意粉", price: 68 },
        { name: "香辣鮮茄煙三文魚意粉", price: 68 },
        { name: "巴馬火腿雜菇葉菜忌廉意", price: 78 },
        { name: "带子黑松露野菌野廉意粉", price: 88 },
        { name: "一口和牛香蒜意粉", price: 78 },
        { name: "一口雞香蒜意粉", price: 78 },
        { name: "大蝦蜆肉鮮茄意粉", price: 88 },
        { name: "紐倫堡一口雞腸鮮茄忌廉意粉", price: 75 },
        { name: "板燒寵脷配煙三文魚墨魚汗意粉", price: 85 },
        { name: "板燒羊西冷意粉", price: 98 },
        { name: "焗芝士鮮茄豬扒意粉", price: 72 },
        { name: "焗葡汁一口和牛茄子意粉", price: 78 },
        { name: "焗芝士蘑菇肉醬意粉", price: 72 },
        { name: "焗葡汁雞意粉", price: 72 },
        { name: "焗葡汁豬意粉", price: 72 },
        { name: "焗咖喱雞意粉", price: 72 },
        { name: "焗咖喱猪意粉", price: 72 }
      ],
      rice: [
        { name: "焗芝士鮮茄豬扒飯", price: 72 },
        { name: "焗葡汁一口和牛茄子飯", price: 78 },
        { name: "焗芝士蘑菇肉醬飯", price: 72 },
        { name: "焗葡汁雞飯", price: 72 },
        { name: "焗葡汁豬飯", price: 72 },
        { name: "焗咖喱雞飯", price: 72 },
        { name: "焗咖喱猪飯", price: 72 }
      ],
      burger: [
        { name: "豬扒汉堡配薯角", price: 65 },
        { name: "他他酱吉列魚柳漢堡配薯角", price: 67 },
        { name: "雙層芝士鮮茄菠蘿漢堡配著角", price: 65 },
        { name: "煙三文魚凱撒漢堡配薯角", price: 70 },
        { name: "脆辣雞煙肉漢堡配薯角", price: 73 },
        { name: "板燒雞煙肉漢堡配薯角", price: 73 },
        { name: "真係辣 脆雞菠蘿漢堡配薯角", price: 75 },
        { name: "真係辣 板燒雞菠蘿漢堡配薯角", price: 75 }
      ],
      pizza: [
        { name: "蕃茄芝士薄餅（素）", price: 78 },
        { name: "雜菌素菜芝士薄餅（素）", price: 80 },
        { name: "美式辣肉腸薄餅", price: 82 },
        { name: "夏威夷風情薄餅", price: 86 },
        { name: "挪威煙三文魚芝士薄饼", price: 88 },
        { name: "千島醬雜錦海鮮薄餅", price: 91 },
        { name: "千島醬烤鸡菠萝薄餅", price: 92 },
        { name: "真係辣海鮮薄餅", price: 94 },
        { name: "飛魚子紫菜海鮮波蘿薄餅", price: 95 },
        { name: "至尊雜錦薄餅", price: 98 },
        { name: "意式巴西火腿薄餅", price: 100 }
      ]
    };

    // In-memory storage for orders and history
    let orderStore = [];
    let summaryStore = null;
    let orderHistoryStore = []; // 存儲歷史訂單記錄
    
    // 圖表對象
    let categoryChart = null;
    let popularItemsChart = null;
    let weeklyOrdersChart = null;
    
    // 新增：把每日自動保存當天訂單到歷史（保留原自動刪除功能並加強提示）
    let autoDeleteTimer = null;
    
    // 初始化每日自動保存 & 半夜刪除前的保存
    function setupAutomaticOrderDeletion() {
      // 先調用保存函數（確保當天數據在管理員後台留存）
      saveOrdersToHistory();
      
      // 清除已有的定時器
      if (autoDeleteTimer) {
        clearTimeout(autoDeleteTimer);
      }
      
      // 設定每日凌晨1:00 執行：自動保存 -> 刪除舊訂單
      const now = new Date();
      const target = new Date();
      target.setHours(1, 0, 0, 0); // 設為凌晨1:00
      
      // 若今天1:00已過，則設定為明天的1:00
      if (now.getTime() > target.getTime()) {
        target.setDate(target.getDate() + 1);
      }
      
      const timeToWait = target.getTime() - now.getTime();
      
      console.log(`訂單自動保存將在 ${new Date(target).toLocaleString()} 執行。還有約 ${Math.floor(timeToWait/1000/60/60)} 小時 ${Math.floor(timeToWait/1000/60) % 60} 分鐘`);
      
      // 設置定時器
      autoDeleteTimer = setTimeout(() => {
        // 在刪除前先保存當天訂單至歷史
        saveOrdersToHistory();
        
        // 清除所有訂單
        clearAllOrders();
        
        // 顯示狀態消息
        showStatusMessage('已自動保存並清除昨日訂單', 'info');
        
        // 重新設定下一天的定時器
        setupAutomaticOrderDeletion();
      }, timeToWait);
    }
    
    // 保存訂單到歷史記錄
    function saveOrdersToHistory() {
      try {
        const orders = getOrders();
        if (orders.length > 0) {
          // 建立歷史記錄對象
          const historyRecord = {
            date: new Date().toISOString(),
            orders: orders,
            summary: generateTextSummary(orders)
          };
          
          // 添加到歷史記錄
          orderHistoryStore.push(historyRecord);
          
          // 保存到 localStorage
          try {
            localStorage.setItem('patternOrdersHistory', JSON.stringify(orderHistoryStore));
          } catch (e) {
            console.warn('無法保存歷史記錄到 localStorage:', e);
          }
          
          // 同步到云端
          saveHistoryToCloud(historyRecord);
          
          console.log(`已保存 ${orders.length} 條訂單到歷史記錄，當前歷史記錄數：${orderHistoryStore.length}`);
        }
      } catch (error) {
        console.error('保存訂單歷史記錄時出錯:', error);
      }
    }
    
    // 将历史记录保存到云端
    async function saveHistoryToCloud(historyRecord) {
      try {
        const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc";
        
        const response = await fetch(`${apiEndpoint}/api/history`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(historyRecord)
        });
        
        if (!response.ok) {
          throw new Error(`API 請求失敗: ${response.status}`);
        }
        
        console.log('歷史記錄已成功同步到雲端');
      } catch (error) {
        console.warn('同步歷史記錄到雲端失敗:', error);
      }
    }
    
    // 從云端加載歷史記錄
    async function loadHistoryFromCloud() {
      try {
        const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc";
        
        const response = await fetch(`${apiEndpoint}/api/history`);
        if (!response.ok) {
          throw new Error(`API 請求失敗: ${response.status}`);
        }
        
        const history = await response.json();
        if (Array.isArray(history)) {
          // 合并云端和本地历史记录，按日期去重
          const existingDates = new Set(orderHistoryStore.map(item => new Date(item.date).toDateString()));
          
          const newHistory = history.filter(item => 
            !existingDates.has(new Date(item.date).toDateString())
          );
          
          orderHistoryStore = [...orderHistoryStore, ...newHistory];
          
          // 保存合并后的记录到本地
          localStorage.setItem('patternOrdersHistory', JSON.stringify(orderHistoryStore));
          
          console.log(`從雲端加載了 ${history.length} 條歷史記錄，新增 ${newHistory.length} 條`);
          return true;
        }
        return false;
      } catch (error) {
        console.warn('從雲端加載歷史記錄失敗:', error);
        return false;
      }
    }
    
    // 從 localStorage 載入歷史記錄
    function loadOrderHistoryFromStorage() {
      try {
        const storedHistory = localStorage.getItem('patternOrdersHistory');
        if (storedHistory) {
          orderHistoryStore = JSON.parse(storedHistory);
          console.log(`從 localStorage 載入了 ${orderHistoryStore.length} 條歷史記錄`);
        }
      } catch (error) {
        console.error('載入歷史記錄時出錯:', error);
      }
    }
    
    // 保存用戶IP和登入狀態
    let ipLoginStatus = {
      userIP: null,
      lastLogin: null,
      expiresIn: 43200000, // 12小時 (毫秒)
      autoLoginToken: null
    };

    // Admin passwords
    const adminPasswords = {
      'Chito0813': { name: 'Chito', welcomeName: 'Chito', role: 'full-access' },
      'GGHWaz': { name: 'Next World Boss', welcomeName: 'Next World Boss', role: 'edit-access' },
      'GGHBryan': { name: '屁屁', welcomeName: '屁屁', role: 'edit-access' },
      'GGHLaZam': { name: 'gay佬', welcomeName: 'gay佬', role: 'edit-access' },
      'GGHOne': { name: '劉貝鳴', welcomeName: '劉貝鳴', role: 'edit-access' },
      'GGHTed': { name: '徐仔', welcomeName: '徐仔', role: 'edit-access' },
      'GGHFilly': { name: '餘震', welcomeName: '餘震', role: 'edit-access' },
      'GGH23': { name: '錦浩好嘢', welcomeName: '錦浩好嘢', role: 'edit-access' },
      'GGHTMan': { name: 'cwh好靚仔', welcomeName: 'cwh好靚仔', role: 'edit-access' },
      'GGHLou': { name: '豪豪', welcomeName: '豪豪', role: 'edit-access' },
      'GGHLamelo': { name: '熙熙', welcomeName: '熙熙', role: 'edit-access' },
      'GGHShamelly': { name: '雞', welcomeName: '雞', role: 'edit-access' },
      'GGHJet': { name: '俊峰', welcomeName: '俊峰', role: 'edit-access' },
      'GGHZamel': { name: '隧道豬', welcomeName: '隧道豬', role: 'edit-access' },
      'GGHFar': { name: 'Faran', welcomeName: 'Faran', role: 'edit-access' }
    };

    let currentAdmin = null;
    let selectedOrderForEdit = null;
    let autoSyncInProgress = false;
    
    // 添加深色模式切换功能
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
      if (event.matches) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    });
    
    // 获取用戶IP
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        if (!response.ok) {
          throw new Error('無法獲取IP地址');
        }
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.warn('獲取IP地址失敗:', error);
        return null;
      }
    }
    
    // 简单加密函数（用于数据保护）
    function encryptData(data, key) {
      // 简单的XOR加密，用于基本数据保护
      let encrypted = '';
      for (let i = 0; i < data.length; i++) {
        encrypted += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
      }
      return btoa(encrypted); // Base64编码
    }
    
    // 简单解密函数
    function decryptData(encryptedData, key) {
      try {
        const data = atob(encryptedData); // Base64解码
        let decrypted = '';
        for (let i = 0; i < data.length; i++) {
          decrypted += String.fromCharCode(data.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return decrypted;
      } catch (e) {
        console.error('解密失败:', e);
        return null;
      }
    }
    
    // 生成数据校验码
    function generateChecksum(data) {
      let hash = 0;
      if (!data) return hash;
      for (let i = 0; i < data.length; i++) {
        const char = data.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // 转换为32位整数
      }
      return hash.toString(16);
    }
    
    // 向API發送登入IP
    async function sendLoginIPToAPI(ip, password) {
      try {
        const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc";
        
        const timestamp = new Date().toISOString();
        // 对敏感数据加密
        const encryptedPassword = encryptData(password, ip + timestamp.substring(0, 10));
        
        const response = await fetch(`${apiEndpoint}/api/admin/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            ip: ip,
            encryptedAuth: encryptedPassword,
            timestamp: timestamp,
            checksum: generateChecksum(ip + timestamp + password)
          })
        });
        
        if (!response.ok) {
          throw new Error(`API 請求失敗: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('登入IP已發送到API', data);
        
        return data.token || 'default-token';
      } catch (error) {
        console.warn('發送登入IP失敗:', error);
        return 'fallback-token';
      }
    }
    
    // 保存 IP 登入狀態 - 使用加密存储
    function saveIPLoginState(ip, password) {
      try {
        ipLoginStatus.userIP = ip;
        ipLoginStatus.lastLogin = new Date().getTime();
        
        // 不直接存储密码，而是存储加密后的token
        const timestamp = new Date().toISOString().split('T')[0]; // 使用当天日期作为加密盐
        ipLoginStatus.autoLoginToken = encryptData(password, ip + timestamp);
        
        // 计算校验和 - 用于验证数据完整性
        const dataString = ip + ipLoginStatus.lastLogin + password;
        ipLoginStatus.checksum = generateChecksum(dataString);
        
        localStorage.setItem('patternIPLoginStatus', JSON.stringify(ipLoginStatus));
        console.log('IP 登入狀態已保存（加密）');
      } catch (error) {
        console.warn('保存 IP 登入狀態失敗:', error);
      }
    }
    
    // 檢查 IP 登入狀態 - 增强版支持数据完整性校验
    function isIPLoginValid() {
      try {
        const savedStatus = localStorage.getItem('patternIPLoginStatus');
        if (!savedStatus) return false;
        
        const status = JSON.parse(savedStatus);
        
        // 验证数据完整性 - 检查校验和
        if (status.checksum) {
          const dataString = status.userIP + status.lastLogin + status.autoLoginToken;
          const calculatedChecksum = generateChecksum(dataString);
          
          // 如果校验和不匹配，可能数据被篡改
          if (calculatedChecksum !== status.checksum) {
            console.warn('登录数据完整性校验失败');
            return false;
          }
        }
        
        ipLoginStatus = status; // 更新全局狀態
        
        const now = new Date().getTime();
        const expired = now - status.lastLogin > status.expiresIn;
        
        return !expired && status.autoLoginToken && status.userIP;
      } catch (error) {
        console.warn('檢查 IP 登入狀態失敗:', error);
        return false;
      }
    }
    
    // 嘗試自動登入 - 增强版，支持解密和验证
    async function tryAutoLogin() {
      if (isIPLoginValid()) {
        try {
          // 获取加密的token
          const encryptedToken = ipLoginStatus.autoLoginToken;
          if (!encryptedToken) return false;
          
          // 解密token
          const currentDate = new Date().toISOString().split('T')[0];
          const ip = ipLoginStatus.userIP;
          
          // 尝试当天的日期作为解密密钥
          let decryptedPassword = decryptData(encryptedToken, ip + currentDate);
          
          // 如果不成功，尝试前一天（处理跨天登录）
          if (!adminPasswords[decryptedPassword]) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            decryptedPassword = decryptData(encryptedToken, ip + yesterdayStr);
          }
          
          // 验证解密后的密码
          if (adminPasswords[decryptedPassword]) {
            currentAdmin = adminPasswords[decryptedPassword];
            document.getElementById('adminName').textContent = currentAdmin.name;
            
            // 显示加载指示器
            showLoading('验证登录', '正在检查登录状态...');
            
            // 更新IP
            const newIp = await getUserIP();
            if (newIp) {
              ipLoginStatus.userIP = newIp;
              ipLoginStatus.lastLogin = new Date().getTime();
              
              // 使用新的 IP 和当前日期重新加密并保存 token
              const newEncryptedToken = encryptData(decryptedPassword, newIp + currentDate);
              ipLoginStatus.autoLoginToken = newEncryptedToken;
              
              // 计算新的校验和
              const dataString = newIp + ipLoginStatus.lastLogin + decryptedPassword;
              ipLoginStatus.checksum = generateChecksum(dataString);
              
              localStorage.setItem('patternIPLoginStatus', JSON.stringify(ipLoginStatus));
              
              // 背景更新登入记录
              sendLoginIPToAPI(newIp, decryptedPassword).catch(error => {
                console.warn('更新登入IP記錄失敗:', error);
              });
            }
            
            hideLoading();
            
            // 顯示對應的管理面板
            if (currentAdmin.role === 'full-access') {
              document.getElementById('adminFullAccess').classList.remove('hidden');
              document.getElementById('adminViewAccess').classList.add('hidden');
            } else {
              document.getElementById('adminFullAccess').classList.add('hidden');
              document.getElementById('adminViewAccess').classList.remove('hidden');
            }
            
            console.log(`自動登入管理員: ${currentAdmin.name} (安全验证成功)`);
            return true;
          }
        } catch (error) {
          console.error('自動登入解密失敗:', error);
          hideLoading();
          return false;
        }
      }
      return false;
    }
    
    // Mobile toggle for summary on small screens
    if (document.getElementById('mobileToggleSummary')) {
      document.getElementById('mobileToggleSummary').addEventListener('click', function() {
        const summaryCard = document.querySelector('.summary-card');
        if (summaryCard) {
          summaryCard.classList.toggle('fixed');
          summaryCard.classList.toggle('inset-0');
          summaryCard.classList.toggle('z-40');
          summaryCard.classList.toggle('m-4');
        }
      });
    }

    // Show welcome dialog
    function showWelcomeDialog(admin) {
      const welcomeTitle = document.getElementById('welcomeTitle');
      const welcomeMessage = document.getElementById('welcomeMessage');
      const welcomeOk = document.getElementById('welcomeOk');
      const welcomeDialog = document.getElementById('welcomeDialog');
      
      welcomeTitle.textContent = `歡迎，${admin.name}！`;
      welcomeMessage.innerHTML = `好嘢👏🏻👏🏻${admin.welcomeName}👍🏻👍🏻好嘢`;
      
      welcomeDialog.classList.remove('hidden');
      welcomeOk.focus();
      
      // Register confirmation button event
      welcomeOk.onclick = () => {
        welcomeDialog.classList.add('hidden');
      };
    }
    
    // Show export success dialog
    function showExportSuccessDialog() {
      const exportSuccessDialog = document.getElementById('exportSuccessDialog');
      exportSuccessDialog.classList.remove('hidden');
      
      const exportSuccessOk = document.getElementById('exportSuccessOk');
      exportSuccessOk.focus();
      
      exportSuccessOk.onclick = () => {
        exportSuccessDialog.classList.add('hidden');
      };
    }
    
    // 添加数据备份功能 - 导出订单数据为JSON
    function exportOrdersAsJSON() {
      try {
        showLoading('正在准备数据', '正在准备导出...');
        
        const orders = getOrders();
        if (orders.length === 0) {
          hideLoading();
          showStatusMessage('没有订单可以导出', 'error');
          return;
        }
        
        console.log('准备导出 ' + orders.length + ' 条订单数据');
        
        // 构建导出的数据对象
        const exportData = {
          version: '4.3.0',
          timestamp: new Date().toISOString(),
          orders: orders,
          summary: summaryStore,
          checksumOrders: generateChecksum(JSON.stringify(orders)),
          checksumSummary: summaryStore ? generateChecksum(JSON.stringify(summaryStore)) : null
        };
        
        // 转换为JSON字符串并加密
        const jsonData = JSON.stringify(exportData, null, 2);
        console.log('JSON数据准备完成，长度: ' + jsonData.length);
        updateLoadingProgress(30, '数据已处理，正在加密...');
        
        const encryptedData = encryptOrderData(jsonData);
        
        updateLoadingProgress(50, '数据已准备完成');
        console.log('数据加密完成，准备复制到剪贴板');
        
        // 复制到剪贴板
        navigator.clipboard.writeText(encryptedData).then(() => {
          hideLoading();
          showStatusMessage('数据已复制到剪贴板，请保存到文本文件', 'success');
          
          // 提示用户如何保存
          const saveInstructions = `
请立即将复制的数据粘贴到一个文本文件中，并用日期命名保存。
例如：Pattern订单备份-${new Date().toISOString().split('T')[0]}.txt

重要：此备份文件包含加密的订单数据，可用于恢复系统。
          `;
          
          alert(saveInstructions);
        }).catch(err => {
          hideLoading();
          showStatusMessage('无法复制到剪贴板: ' + err, 'error');
        });
      } catch (error) {
        hideLoading();
        console.error('导出数据失败:', error);
        showStatusMessage('导出数据失败: ' + error.message, 'error');
      }
    }
    
    // 解决Unicode编码问题的新加密函数
    function encryptOrderData(data) {
      try {
        // 使用简单的替代方案：Base64直接编码而不是XOR加密
        // 这样可以避免非Latin1字符问题
        return btoa(unescape(encodeURIComponent(data)));
      } catch (e) {
        console.error('加密失败:', e);
        // 备用编码方案
        try {
          // 将JSON转换为URI编码字符串，然后Base64编码
          const encoded = encodeURIComponent(data);
          console.log('URI编码后的长度: ' + encoded.length);
          return btoa(encoded);
        } catch (e2) {
          console.error('备用加密也失败:', e2);
          throw new Error('数据包含无法编码的字符，请联系管理员');
        }
      }
    }
    
    // 添加数据恢复功能 - 从JSON文件恢复
    function importOrdersFromJSON() {
      showConfirmDialog(
        "导入数据",
        "请将之前导出的加密数据粘贴到下方。此操作将替换当前所有订单数据，请确认是否继续？",
        (confirmed) => {
          if (confirmed) {
            // 使用prompt获取用户粘贴的数据
            const encryptedData = prompt("请粘贴之前导出的加密数据:");
            if (!encryptedData) {
              showStatusMessage('导入已取消', 'info');
              return;
            }
            
            showLoading('正在处理', '正在解析数据...');
            
            try {
              // 尝试解密数据
              let decryptedData = null;
              
              // 尝试不同的日期作为解密密钥（今天和过去几天）
              for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                const key = 'PatternExport' + dateStr;
                
                try {
                  decryptedData = decryptData(encryptedData, key);
                  if (decryptedData && decryptedData.length > 0) {
                    break;
                  }
                } catch (e) {
                  console.log(`使用日期 ${dateStr} 解密失败，尝试其他日期`);
                }
              }
              
              if (!decryptedData) {
                throw new Error('无法解密数据，可能不是有效的备份文件');
              }
              
              updateLoadingProgress(30, '正在验证数据...');
              
              // 解析JSON
              const importedData = JSON.parse(decryptedData);
              
              // 验证数据完整性
              if (!importedData.orders || !Array.isArray(importedData.orders)) {
                throw new Error('无效的数据格式');
              }
              
              // 验证校验和
              const currentOrdersChecksum = generateChecksum(JSON.stringify(importedData.orders));
              if (currentOrdersChecksum !== importedData.checksumOrders) {
                throw new Error('数据校验失败，可能已损坏');
              }
              
              updateLoadingProgress(60, '正在恢复订单数据...');
              
              // 备份当前数据
              const currentOrders = getOrders();
              const originalBackup = {
                timestamp: new Date().toISOString(),
                orders: currentOrders
              };
              
              try {
                localStorage.setItem('patternOrdersBackup', JSON.stringify(originalBackup));
              } catch (e) {
                console.warn('无法保存当前数据备份:', e);
              }
              
              // 恢复订单数据
              orderStore = importedData.orders;
              updateSummary();
              saveToLocalStorage();
              
              updateLoadingProgress(90, '正在同步到云端...');
              
              // 同步到云端
              syncToCloudflare(true).then(() => {
                hideLoading();
                showStatusMessage(`成功导入 ${importedData.orders.length} 条订单数据`, 'success');
              }).catch(error => {
                hideLoading();
                showStatusMessage(`数据已导入但同步到云端失败: ${error.message}`, 'warning');
              });
            } catch (error) {
              hideLoading();
              console.error('导入数据失败:', error);
              showStatusMessage('导入数据失败: ' + error.message, 'error');
            }
          }
        }
      );
    }

    // 嘗試從localStorage載入管理員登入狀態
    function loadAdminLoginState() {
      try {
        const savedAdminState = localStorage.getItem('patternAdminLogin');
        if (savedAdminState) {
          const adminInfo = JSON.parse(savedAdminState);
          // 驗證存儲的管理員資訊
          if (adminInfo && adminInfo.password && adminPasswords[adminInfo.password]) {
            // 自動登入
            currentAdmin = adminPasswords[adminInfo.password];
            document.getElementById('adminName').textContent = currentAdmin.name;
            
            // 顯示相應面板
            if (currentAdmin.role === 'full-access') {
              document.getElementById('adminFullAccess').classList.remove('hidden');
              document.getElementById('adminViewAccess').classList.add('hidden');
            } else {
              document.getElementById('adminFullAccess').classList.add('hidden');
              document.getElementById('adminViewAccess').classList.remove('hidden');
            }
            
            console.log(`自動登入管理員: ${currentAdmin.name}`);
            return true;
          }
        }
      } catch (error) {
        console.warn('載入管理員登入狀態失敗:', error);
      }
      return false;
    }
    
    // 小彩蛋图片显示
    function showEasterEgg() {
      console.log("显示彩蛋函数被调用");
      // 创建彩蛋弹窗
      const easterEggDialog = document.createElement('div');
      easterEggDialog.id = 'easterEggDialog';
      easterEggDialog.className = 'fixed inset-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center';
      
      // 全新设计的彩蛋UI
      easterEggDialog.innerHTML = `
        <div class="bg-gradient-to-br from-white to-gray-100 dark:from-gray-800 dark:to-dark-300 max-w-lg w-11/12 rounded-2xl shadow-2xl p-0 overflow-hidden welcome-pop">
          <!-- 顶部装饰带 -->
          <div class="h-2 w-full bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
          
          <!-- 彩蛋内容 -->
          <div class="p-6">
            <!-- 标题 -->
            <div class="flex justify-between items-center mb-5">
              <div class="flex items-center">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary-500 to-indigo-600 flex items-center justify-center text-white mr-3 shadow-lg">
                  <i class="ri-gift-2-line text-xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">发现彩蛋！</h3>
              </div>
              <button id="closeEasterEgg" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-2 transition-colors hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="ri-close-line text-xl"></i>
              </button>
            </div>
            
            <!-- 主要内容 -->
            <div class="bg-white dark:bg-gray-700 rounded-xl shadow-md overflow-hidden mb-5 relative">
              <!-- 炫酷的波浪背景 -->
              <div class="absolute inset-0 bg-gradient-to-br from-primary-400/10 to-indigo-400/5 dark:from-primary-900/30 dark:to-indigo-900/20 overflow-hidden">
                <svg class="absolute bottom-0 left-0 w-full h-24 transform translate-y-1/2 opacity-10" viewBox="0 0 1200 120" preserveAspectRatio="none">
                  <path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" fill="currentColor" class="text-primary-600 dark:text-primary-400"></path>
                </svg>
              </div>
              
              <div class="relative z-10 p-6 flex flex-col items-center">
                <!-- 动态Logo -->
                <div class="w-24 h-24 bg-gradient-to-br from-primary-600 to-indigo-700 dark:from-primary-500 dark:to-indigo-600 rounded-2xl shadow-xl flex items-center justify-center mb-4 transform hover:rotate-3 hover:scale-105 transition-all duration-300">
                  <span class="text-white font-bold text-2xl tracking-wide">GGH</span>
                </div>
                
                <!-- 名称 -->
                <div class="text-center">
                  <h4 class="text-3xl font-bold bg-gradient-to-r from-primary-600 to-indigo-600 dark:from-primary-400 dark:to-indigo-400 bg-clip-text text-transparent mb-2">Pattern</h4>
                </div>
                
                <!-- 装饰元素 -->
                <div class="w-16 h-1 bg-gradient-to-r from-primary-500 to-indigo-500 rounded-full my-5"></div>
                
                <!-- 团队成员图示 -->
                <div class="grid grid-cols-4 gap-2 w-full max-w-xs mt-2">
                  <div class="flex flex-col items-center">
                    <div class="w-12 h-12 rounded-full bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 dark:text-blue-400">👨‍💻</div>
                  </div>
                  <div class="flex flex-col items-center">
                    <div class="w-12 h-12 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center text-green-600 dark:text-green-400">👨‍🎨</div>
                  </div>
                  <div class="flex flex-col items-center">
                    <div class="w-12 h-12 rounded-full bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center text-amber-600 dark:text-amber-400">🧙‍♂️</div>
                  </div>
                  <div class="flex flex-col items-center">
                    <div class="w-12 h-12 rounded-full bg-rose-100 dark:bg-rose-900/30 flex items-center justify-center text-rose-600 dark:text-rose-400">🥰</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 动画口号 -->
            <div class="text-center bg-gradient-to-br from-primary-50 to-indigo-50 dark:from-primary-900/20 dark:to-indigo-900/20 rounded-xl p-5 shadow-inner">
              <div class="relative overflow-hidden thumbs-up inline-block">
                <p class="text-lg font-bold text-primary-600 dark:text-primary-400">
                  <span class="animate-bounce-light inline-block">👏🏻</span> 
                  好嘢！Pattern 好嘢！
                  <span class="animate-bounce-light inline-block" style="animation-delay: 0.2s">👏🏻</span>
                </p>
              </div>
              <p class="text-gray-500 dark:text-gray-400 mt-1 text-sm">— GGH Pattern Chito. —</p>
            </div>
          </div>
        </div>
      `;
      
      // 添加到文档
      document.body.appendChild(easterEggDialog);
      console.log("彩蛋对话框已添加到文档");
      
      // 绑定关闭按钮事件
      const closeButton = document.getElementById('closeEasterEgg');
      if (closeButton) {
        closeButton.addEventListener('click', () => {
          document.body.removeChild(easterEggDialog);
        });
        console.log("关闭按钮事件已绑定");
      } else {
        console.error("找不到关闭按钮元素");
      }
      
      // 点击外部区域也关闭
      easterEggDialog.addEventListener('click', (e) => {
        if (e.target === easterEggDialog) {
          document.body.removeChild(easterEggDialog);
        }
      });
    }
    
    // 保存管理員登入狀態
    function saveAdminLoginState(password) {
      const rememberAdminCheckbox = document.getElementById('rememberAdmin');
      if (rememberAdminCheckbox && rememberAdminCheckbox.checked) {
        try {
          localStorage.setItem('patternAdminLogin', JSON.stringify({
            password: password,
            timestamp: new Date().toISOString()
          }));
          console.log('管理員登入狀態已保存');
        } catch (error) {
          console.warn('保存管理員登入狀態失敗:', error);
        }
      }
    }
    
    // 清除管理員登入狀態
    function clearAdminLoginState() {
      try {
        localStorage.removeItem('patternAdminLogin');
        console.log('管理員登入狀態已清除');
      } catch (error) {
        console.warn('清除管理員登入狀態失敗:', error);
      }
    }
    
    // 显示或隐藏通用加载指示器
    function showLoading(title = "处理中", message = "请稍候...", progress = 0) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const loadingTitle = document.getElementById('loadingTitle');
      const loadingText = document.getElementById('loadingText');
      const loadingProgress = document.getElementById('loadingProgress');
      
      loadingTitle.textContent = title;
      loadingText.textContent = message;
      loadingProgress.style.width = `${progress}%`;
      
      loadingIndicator.classList.remove('hidden');
    }
    
    function updateLoadingProgress(progress, message = null) {
      const loadingProgress = document.getElementById('loadingProgress');
      const loadingText = document.getElementById('loadingText');
      
      loadingProgress.style.width = `${progress}%`;
      if (message) {
        loadingText.textContent = message;
      }
    }
    
    function hideLoading() {
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.classList.add('hidden');
    }
    
    // 顯示確認對話框
    function showConfirmDialog(title, message, callback) {
      const confirmDialog = document.getElementById('confirmDialog');
      const confirmTitle = document.getElementById('confirmTitle');
      const confirmMessage = document.getElementById('confirmMessage');
      const confirmOk = document.getElementById('confirmOk');
      const confirmCancel = document.getElementById('confirmCancel');
      
      confirmTitle.textContent = title;
      confirmMessage.textContent = message;
      
      // 移除舊的事件
      const newOkButton = confirmOk.cloneNode(true);
      const newCancelButton = confirmCancel.cloneNode(true);
      confirmOk.parentNode.replaceChild(newOkButton, confirmOk);
      confirmCancel.parentNode.replaceChild(newCancelButton, confirmCancel);
      
      // 新的 reference
      const updatedOkButton = document.getElementById('confirmOk');
      const updatedCancelButton = document.getElementById('confirmCancel');
      
      updatedOkButton.addEventListener('click', () => {
        confirmDialog.classList.add('hidden');
        callback(true);
      });
      updatedCancelButton.addEventListener('click', () => {
        confirmDialog.classList.add('hidden');
        callback(false);
      });
      
      confirmDialog.classList.remove('hidden');
    }
    
    // 快速導出 - 只導出當天訂單
    async function quickExport() {
      const allOrders = getOrders();
      
      // 過濾只保留當天的訂單
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const todayOrders = allOrders.filter(order => {
        const orderDate = new Date(order.timestamp);
        orderDate.setHours(0, 0, 0, 0);
        return orderDate.getTime() === today.getTime();
      });
      
      if (todayOrders.length === 0) {
        showStatusMessage('今日暫無訂單可以導出', 'error');
        return;
      }
      
      try {
        const exportText = generateTextSummary(todayOrders);
        
        await navigator.clipboard.writeText(exportText);
        
        showExportSuccessDialog();
        
        // 根據哪個按鈕被點擊來添加動畫效果
        const isMobile = window.innerWidth < 768;
        const quickExportBtn = document.getElementById('quickExportBtn');
        const mobileExportBtn = document.getElementById('mobileExportBtn');
        
        if (isMobile) {
          mobileExportBtn.classList.add('export-success-animation');
          setTimeout(() => {
            mobileExportBtn.classList.remove('export-success-animation');
          }, 1000);
        } else {
          quickExportBtn.classList.add('export-success-animation');
          setTimeout(() => {
            quickExportBtn.classList.remove('export-success-animation');
          }, 1000);
        }
      } catch (err) {
        showStatusMessage('無法複製到剪貼板: ' + err, 'error');
        console.error('Failed to copy:', err);
      }
    }

    // 統計圖表初始化
    function initializeCharts() {
      const ctx1 = document.getElementById('orderCategoryCanvas').getContext('2d');
      const ctx2 = document.getElementById('popularItemsCanvas').getContext('2d');
      const ctx3 = document.getElementById('weeklyOrdersCanvas').getContext('2d');
      
      // 訂單分佈圖
      categoryChart = new Chart(ctx1, {
        type: 'doughnut',
        data: {
          labels: ['意粉', '飯類', '漢堡', 'Pizza'],
          datasets: [{
            data: [0, 0, 0, 0],
            backgroundColor: [
              'rgba(93, 92, 222, 0.7)',
              'rgba(16, 185, 129, 0.7)',
              'rgba(245, 158, 11, 0.7)',
              'rgba(14, 165, 233, 0.7)'
            ],
            borderColor: [
              'rgba(93, 92, 222, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(245, 158, 11, 1)',
              'rgba(14, 165, 233, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                color: document.documentElement.classList.contains('dark') ? 'white' : 'black',
                font: {
                  size: 11
                }
              }
            }
          }
        }
      });
      
      // 熱門餐品圖
      popularItemsChart = new Chart(ctx2, {
        type: 'bar',
        data: {
          labels: [],
          datasets: [{
            label: '訂單數',
            data: [],
            backgroundColor: 'rgba(93, 92, 222, 0.7)',
            borderColor: 'rgba(93, 92, 222, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: document.documentElement.classList.contains('dark') ? 'white' : 'black',
                precision: 0
              }
            },
            x: {
              ticks: {
                color: document.documentElement.classList.contains('dark') ? 'white' : 'black',
                autoSkip: true,
                maxRotation: 45,
                minRotation: 45
              }
            }
          }
        }
      });
      
      // 週訂單趨勢圖
      weeklyOrdersChart = new Chart(ctx3, {
        type: 'line',
        data: {
          labels: ['周一', '周二', '周三', '周四', '周五', '周六', '周日'],
          datasets: [{
            label: '訂單數',
            data: [0, 0, 0, 0, 0, 0, 0],
            backgroundColor: 'rgba(93, 92, 222, 0.2)',
            borderColor: 'rgba(93, 92, 222, 1)',
            borderWidth: 2,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: document.documentElement.classList.contains('dark') ? 'white' : 'black',
                precision: 0
              }
            },
            x: {
              ticks: {
                color: document.documentElement.classList.contains('dark') ? 'white' : 'black'
              }
            }
          }
        }
      });
    }

    // 更新圖表數據
    function updateCharts() {
      const orders = getOrders();
      if (!orders || orders.length === 0) return;
      
      // 分類統計
      const categoryData = [0, 0, 0, 0]; // 意粉, 飯類, 漢堡, Pizza
      
      orders.forEach(order => {
        const food = order.food;
        let categoryIndex = -1;
        
        if (menuData.pasta.some(item => item.name === food)) {
          categoryIndex = 0;
        } else if (menuData.rice.some(item => item.name === food)) {
          categoryIndex = 1;
        } else if (menuData.burger.some(item => item.name === food)) {
          categoryIndex = 2;
        } else if (menuData.pizza.some(item => item.name === food)) {
          categoryIndex = 3;
        }
        
        if (categoryIndex !== -1) {
          categoryData[categoryIndex]++;
        }
      });
      
      // 更新訂單分佈圖
      categoryChart.data.datasets[0].data = categoryData;
      categoryChart.update();
      
      // 熱門餐品統計
      const foodCount = {};
      orders.forEach(order => {
        foodCount[order.food] = (foodCount[order.food] || 0) + 1;
      });
      
      const sortedItems = Object.entries(foodCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5); // 只取前5名
      
      const labels = sortedItems.map(item => {
        // 如果名稱太長，截短它
        return item[0].length > 10 ? item[0].substring(0, 10) + '...' : item[0];
      });
      const data = sortedItems.map(item => item[1]);
      
      // 更新熱門餐品圖
      popularItemsChart.data.labels = labels;
      popularItemsChart.data.datasets[0].data = data;
      popularItemsChart.update();
      
      // 週趨勢分析
      const weeklyData = [0, 0, 0, 0, 0, 0, 0]; // 星期一到星期日
      
      // 歷史記錄分析
      if (orderHistoryStore && orderHistoryStore.length > 0) {
        // 添加日期選擇器UI
        const weeklyTrendsContent = document.getElementById('weeklyTrendsContent');
        if (!document.getElementById('weeklyDateRangePicker')) {
          const datePickerHTML = `
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700 mb-4">
              <div class="flex items-center justify-between mb-2">
                <h5 class="text-sm font-medium text-gray-800 dark:text-white">選擇日期範圍</h5>
                <button id="refreshWeeklyChart" class="text-xs bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 px-2 py-1 rounded-full flex items-center">
                  <i class="ri-refresh-line mr-1"></i>更新圖表
                </button>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="weeklyStartDate" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">開始日期</label>
                  <input type="date" id="weeklyStartDate" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
                </div>
                <div>
                  <label for="weeklyEndDate" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">結束日期</label>
                  <input type="date" id="weeklyEndDate" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
                </div>
              </div>
            </div>
          `;
          
          // 將日期選擇器插入到週趨勢圖的頂部
          const firstChild = weeklyTrendsContent.firstChild;
          const datePickerContainer = document.createElement('div');
          datePickerContainer.innerHTML = datePickerHTML;
          weeklyTrendsContent.insertBefore(datePickerContainer, firstChild);
          
          // 设置默认日期: 今天和一周前
          const today = new Date();
          const oneWeekAgo = new Date();
          oneWeekAgo.setDate(today.getDate() - 7);
          
          document.getElementById('weeklyEndDate').value = today.toISOString().split('T')[0];
          document.getElementById('weeklyStartDate').value = oneWeekAgo.toISOString().split('T')[0];
          
          // 添加更新图表事件
          document.getElementById('refreshWeeklyChart').addEventListener('click', function() {
            updateWeeklyChart();
          });
        }
        
        // 更新週趨勢圖的函數
        function updateWeeklyChart() {
          const startDate = document.getElementById('weeklyStartDate').value;
          const endDate = document.getElementById('weeklyEndDate').value;
          
          if (!startDate || !endDate) {
            showStatusMessage('請選擇有效的日期範圍', 'warning');
            return;
          }
          
          const start = new Date(startDate);
          const end = new Date(endDate);
          end.setHours(23, 59, 59, 999); // 設置結束日期為當天最後一刻
          
          if (start > end) {
            showStatusMessage('開始日期不能晚於結束日期', 'error');
            return;
          }
          
          // 重置數據
          const weeklyData = [0, 0, 0, 0, 0, 0, 0];
          
          // 處理歷史記錄中在選定日期範圍內的數據
          orderHistoryStore.forEach(history => {
            const historyDate = new Date(history.date);
            if (historyDate >= start && historyDate <= end) {
              const dayOfWeek = historyDate.getDay();
              const adjustedIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
              
              if (history.orders && history.orders.length) {
                weeklyData[adjustedIndex] += history.orders.length;
              }
            }
          });
          
          // 處理當天數據
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          if (today >= start && today <= end) {
            const todayDayOfWeek = today.getDay();
            const todayAdjustedIndex = todayDayOfWeek === 0 ? 6 : todayDayOfWeek - 1;
            weeklyData[todayAdjustedIndex] += orders.length;
          }
          
          // 更新週趨勢圖
          weeklyOrdersChart.data.datasets[0].data = weeklyData;
          weeklyOrdersChart.update();
          
          showStatusMessage('週趨勢圖表已更新', 'success');
        }
        
        // 初始化圖表
        updateWeeklyChart();
      }
    }

    function init() {
      console.log("初始化應用...");
      
      // 初始化圖表
      initializeCharts();
      
      const showHistoryBtn = document.getElementById('showHistoryBtn');
      if (showHistoryBtn) {
        showHistoryBtn.addEventListener('click', function() {
          console.log("歷史記錄按鈕被點擊");
          const orderAnalysisPanel = document.getElementById('orderAnalysisPanel');
          orderAnalysisPanel.classList.remove('hidden');
          const adminPanel = document.getElementById('adminPanel');
          adminPanel.classList.add('hidden');
          
          loadOrderAnalysis();
          
          const weeklyTrendsTab = document.getElementById('weeklyTrendsTab');
          if (weeklyTrendsTab) {
            weeklyTrendsTab.click();
          }
          
          loadOrderHistory();
        });
      }
      
      function loadOrderHistory() {
        const orderHistoryList = document.getElementById('orderHistoryList');
        if (!orderHistoryList) {
          console.error('找不到歷史記錄容器');
          return;
        }
        
        console.log('載入歷史訂單記錄，歷史記錄數量:', orderHistoryStore ? orderHistoryStore.length : 0);
        
        if (!orderHistoryStore || orderHistoryStore.length === 0) {
          orderHistoryList.innerHTML = `
            <div class="text-center py-4">
              <p class="text-gray-500 dark:text-gray-400">暫無歷史訂單記錄</p>
            </div>
          `;
          return;
        }
        
        // 按日期对历史记录进行分组
        const recordsByMonth = {};
        const sortedRecords = orderHistoryStore.slice().sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedRecords.forEach(record => {
          const recordDate = new Date(record.date);
          const monthKey = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}`;
          
          if (!recordsByMonth[monthKey]) {
            recordsByMonth[monthKey] = [];
          }
          
          recordsByMonth[monthKey].push(record);
        });
        
        let html = '';
        
        // 添加日期选择器
        html += `
          <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700 mb-4">
            <div class="flex items-center justify-between mb-2">
              <h5 class="text-sm font-medium text-gray-800 dark:text-white">選擇日期範圍</h5>
              <button id="historyDateFilterBtn" class="text-xs bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 px-2 py-1 rounded-full flex items-center">
                <i class="ri-filter-line mr-1"></i>篩選記錄
              </button>
            </div>
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label for="historyStartDate" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">開始日期</label>
                <input type="date" id="historyStartDate" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
              </div>
              <div>
                <label for="historyEndDate" class="block text-xs text-gray-600 dark:text-gray-400 mb-1">結束日期</label>
                <input type="date" id="historyEndDate" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
              </div>
            </div>
          </div>
        `;
        
        // 按月份分组显示历史记录
        Object.keys(recordsByMonth).sort().reverse().forEach(monthKey => {
          const recordsInMonth = recordsByMonth[monthKey];
          const [year, month] = monthKey.split('-');
          const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
          const monthName = monthNames[parseInt(month) - 1];
          
          html += `
            <div class="mb-4 history-month-group" data-month="${monthKey}">
              <div class="flex items-center mb-2">
                <i class="ri-calendar-2-line text-primary-500 mr-1.5"></i>
                <h5 class="text-sm font-medium text-gray-800 dark:text-white">${year}年${monthName}</h5>
              </div>
              <div class="space-y-3">
          `;
          
          recordsInMonth.forEach((historyRecord, index) => {
            const recordDate = new Date(historyRecord.date);
            const formattedDate = `${recordDate.getFullYear()}-${String(recordDate.getMonth() + 1).padStart(2, '0')}-${String(recordDate.getDate()).padStart(2, '0')}`;
            const weekday = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"][recordDate.getDay()];
            const orderCount = historyRecord.orders ? historyRecord.orders.length : 0;
            
            html += `
              <div class="bg-white dark:bg-dark-500 p-3 rounded-lg border border-gray-200 dark:border-gray-700 history-record-item" data-date="${formattedDate}">
                <div class="flex justify-between items-center mb-2">
                  <h5 class="text-sm font-medium text-gray-800 dark:text-white flex items-center">
                    <i class="ri-calendar-line text-blue-500 mr-1.5"></i>${formattedDate} ${weekday}
                  </h5>
                  <span class="text-xs bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2 py-0.5 rounded-full">
                    ${orderCount} 個訂單
                  </span>
                </div>
                
                <div class="text-sm text-gray-600 dark:text-gray-400 border-t border-gray-100 dark:border-gray-700 pt-2">
                  <button class="history-detail-btn w-full text-left text-xs text-primary-600 dark:text-primary-400 hover:underline flex items-center" data-id="${historyRecord.date}">
                    <i class="ri-eye-line mr-1"></i>查看詳情
                  </button>
                  
                  <div class="history-detail-content hidden mt-2 bg-gray-50 dark:bg-dark-400 p-2 rounded text-xs">
                    <pre class="whitespace-pre-wrap">${historyRecord.summary || '無摘要信息'}</pre>
                  </div>
                </div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        orderHistoryList.innerHTML = html;
        
        // 設置默認日期: 今天和一個月前
        const today = new Date();
        const oneMonthAgo = new Date();
        oneMonthAgo.setMonth(today.getMonth() - 1);
        
        document.getElementById('historyEndDate').value = today.toISOString().split('T')[0];
        document.getElementById('historyStartDate').value = oneMonthAgo.toISOString().split('T')[0];
        
        // 添加日期篩選功能
        document.getElementById('historyDateFilterBtn').addEventListener('click', function() {
          const startDateStr = document.getElementById('historyStartDate').value;
          const endDateStr = document.getElementById('historyEndDate').value;
          
          if (!startDateStr || !endDateStr) {
            showStatusMessage('請選擇有效的日期範圍', 'warning');
            return;
          }
          
          const startDate = new Date(startDateStr);
          const endDate = new Date(endDateStr);
          endDate.setHours(23, 59, 59, 999); // 設置結束日期為當天最後一刻
          
          if (startDate > endDate) {
            showStatusMessage('開始日期不能晚於結束日期', 'error');
            return;
          }
          
          // 過濾歷史記錄
          document.querySelectorAll('.history-record-item').forEach(item => {
            const itemDate = new Date(item.dataset.date);
            if (itemDate >= startDate && itemDate <= endDate) {
              item.classList.remove('hidden');
            } else {
              item.classList.add('hidden');
            }
          });
          
          // 隱藏沒有可見記錄的月份組
          document.querySelectorAll('.history-month-group').forEach(group => {
            const visibleRecords = group.querySelectorAll('.history-record-item:not(.hidden)');
            if (visibleRecords.length === 0) {
              group.classList.add('hidden');
            } else {
              group.classList.remove('hidden');
            }
          });
          
          showStatusMessage('已篩選歷史記錄', 'success');
        });
        
        document.querySelectorAll('.history-detail-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const content = this.nextElementSibling;
            if (content.classList.contains('hidden')) {
              document.querySelectorAll('.history-detail-content:not(.hidden)').forEach(el => {
                el.classList.add('hidden');
              });
              
              content.classList.remove('hidden');
              this.innerHTML = '<i class="ri-close-line mr-1"></i>隱藏詳情';
            } else {
              content.classList.add('hidden');
              this.innerHTML = '<i class="ri-eye-line mr-1"></i>查看詳情';
            }
          });
        });
        
        console.log(`顯示了 ${orderHistoryStore.length} 條歷史記錄`);
      }

      const categoryButtons = document.querySelectorAll('.category-btn');
      categoryButtons.forEach(button => {
        button.addEventListener('click', () => {
          categoryButtons.forEach(btn => {
            btn.classList.remove('bg-primary-600', 'text-white');
            btn.classList.add('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
          });
          
          button.classList.remove('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
          button.classList.add('bg-primary-600', 'text-white');
          
          updateFoodOptions(button.dataset.category);
        });
      });
      
      const drinkSelect = document.getElementById('drinkSelect');
      const drinkReqSection = document.getElementById('drinkReqSection');
      drinkSelect.addEventListener('change', () => {
        if (drinkSelect.value) {
          drinkReqSection.classList.remove('hidden');
          // 先設置好動畫樣式相關屬性
          drinkReqSection.style.opacity = '0';
          drinkReqSection.style.display = 'block';
          
          // 強制重排後應用動畫
          void drinkReqSection.offsetWidth;
          drinkReqSection.style.opacity = '1';
          drinkReqSection.style.transition = 'opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1)';
        } else {
          drinkReqSection.classList.add('hidden');
          document.querySelectorAll('input[name="drinkReq"]').forEach(checkbox => {
            checkbox.checked = false;
          });
        }
      });
      
      const orderForm = document.getElementById('orderForm');
      orderForm.addEventListener('submit', handleOrderSubmit);
      
      const toggleAdminBtn = document.getElementById('toggleAdmin');
      toggleAdminBtn.addEventListener('click', () => {
        if (currentAdmin) {
          document.getElementById('adminPanel').classList.remove('hidden');
        } else {
          document.getElementById('adminLoginDialog').classList.remove('hidden');
        }
      });
      
      document.getElementById('closeAdminLoginDialog').addEventListener('click', closeAdminLoginDialog);
      document.getElementById('cancelAdminLogin').addEventListener('click', closeAdminLoginDialog);
      
      const closeAdminPanel = document.getElementById('closeAdminPanel');
      if (closeAdminPanel) {
        closeAdminPanel.addEventListener('click', () => {
          document.getElementById('adminPanel').classList.add('hidden');
        });
      }
      
      // 密碼顯示/隱藏
      const togglePassword = document.getElementById('togglePassword');
      const adminPassword = document.getElementById('adminPassword');
      if (togglePassword && adminPassword) {
        togglePassword.addEventListener('click', function() {
          const type = adminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
          adminPassword.setAttribute('type', type);
          
          const icon = togglePassword.querySelector('i');
          if (type === 'text') {
            icon.classList.remove('ri-eye-off-line');
            icon.classList.add('ri-eye-line');
          } else {
            icon.classList.remove('ri-eye-line');
            icon.classList.add('ri-eye-off-line');
          }
        });
      }
      
      document.getElementById('adminLoginBtn').addEventListener('click', handleAdminLogin);
      document.getElementById('adminLogoutBtn').addEventListener('click', handleAdminLogout);
      
      document.getElementById('generateSummaryBtn').addEventListener('click', generateSummary);
      document.getElementById('clearOrdersBtn').addEventListener('click', promptClearAllOrders);
      document.getElementById('exportSummaryBtn').addEventListener('click', () => exportSummary('full'));
      document.getElementById('exportSummaryViewBtn').addEventListener('click', () => exportSummary('view'));
      document.getElementById('modifyOrdersBtn').addEventListener('click', showOrderModificationPanel);
      
      const modifyOrdersViewBtn = document.getElementById('modifyOrdersViewBtn');
      if (modifyOrdersViewBtn) {
        modifyOrdersViewBtn.addEventListener('click', showOrderModificationPanel);
      }
      
      document.getElementById('backToAdminBtn').addEventListener('click', () => {
        document.getElementById('modifyOrdersPanel').classList.add('hidden');
      });
      
      const syncToCloudflareBtn = document.getElementById('syncToCloudflareBtn');
      const syncFromCloudflareBtn = document.getElementById('syncFromCloudflareBtn');
      syncToCloudflareBtn.addEventListener('click', () => syncToCloudflare(false));
      syncFromCloudflareBtn.addEventListener('click', () => syncFromCloudflare(false));
      
      const syncFromCloudflareViewBtn = document.getElementById('syncFromCloudflareViewBtn');
      syncFromCloudflareViewBtn.addEventListener('click', () => syncFromCloudflare(true));
      
      // 設置桌面端和移動端導出按鈕事件
      const quickExportBtn = document.getElementById('quickExportBtn');
      const mobileExportBtn = document.getElementById('mobileExportBtn');
      
      quickExportBtn.addEventListener('click', quickExport);
      mobileExportBtn.addEventListener('click', quickExport);
      
      // 移除動態調整按鈕顯示的 JavaScript，因為現在使用了 CSS 類別 (hidden md:flex) 自動處理
      
      document.getElementById('versionBadge').addEventListener('click', () => {
        document.getElementById('versionModal').classList.remove('hidden');
      });
      document.getElementById('closeVersionModal').addEventListener('click', () => {
        document.getElementById('versionModal').classList.add('hidden');
      });
      
      const orderAnalysisBtn = document.getElementById('orderAnalysisBtn');
      const orderAnalysisPanel = document.getElementById('orderAnalysisPanel');
      const closeOrderAnalysisPanel = document.getElementById('closeOrderAnalysisPanel');
      if (orderAnalysisBtn) {
        orderAnalysisBtn.addEventListener('click', () => {
          orderAnalysisPanel.classList.remove('hidden');
          loadOrderAnalysis();
          document.getElementById('adminPanel').classList.add('hidden');
        });
      }
      if (closeOrderAnalysisPanel) {
        closeOrderAnalysisPanel.addEventListener('click', () => {
          orderAnalysisPanel.classList.add('hidden');
        });
      }
      
      const dailyStatsTab = document.getElementById('dailyStatsTab');
      const weeklyTrendsTab = document.getElementById('weeklyTrendsTab');
      const userPreferencesTab = document.getElementById('userPreferencesTab');
      if (dailyStatsTab && weeklyTrendsTab && userPreferencesTab) {
        dailyStatsTab.addEventListener('click', () => {
          activateAnalysisTab(dailyStatsTab, document.getElementById('dailyStatsContent'));
        });
        weeklyTrendsTab.addEventListener('click', () => {
          activateAnalysisTab(weeklyTrendsTab, document.getElementById('weeklyTrendsContent'));
        });
        userPreferencesTab.addEventListener('click', () => {
          activateAnalysisTab(userPreferencesTab, document.getElementById('userPreferencesContent'));
        });
      }
      
      if (document.getElementById('checkNetworkStateBtn')) {
        document.getElementById('checkNetworkStateBtn').addEventListener('click', checkNetworkStatus);
      }
      if (document.getElementById('refreshCloudStateBtn')) {
        document.getElementById('refreshCloudStateBtn').addEventListener('click', refreshCloudState);
      }
      // 添加系统设置按钮事件
      if (document.getElementById('systemSettingsBtn')) {
        document.getElementById('systemSettingsBtn').addEventListener('click', showSystemSettings);
      }
      
      // 系统设置功能
      function showSystemSettings() {
        showStatusMessage('正在打开系统设置...', 'info');
        
        // 创建系统设置面板
        const systemSettingsPanel = document.createElement('div');
        systemSettingsPanel.id = 'systemSettingsPanel';
        systemSettingsPanel.className = 'fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center';
        systemSettingsPanel.innerHTML = `
          <div class="bg-white dark:bg-dark-300 max-w-lg w-11/12 rounded-xl shadow-2xl animate-dialogScale p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center">
                <i class="ri-settings-3-line text-xl text-amber-500 mr-2"></i>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">系统设置</h3>
              </div>
              <button id="closeSystemSettingsBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-1.5 transition-colors hover:bg-gray-100 dark:hover:bg-dark-200">
                <i class="ri-close-line text-xl"></i>
              </button>
            </div>
            
            <!-- 系统设置内容 -->
            <div class="space-y-5">
              <!-- 基本设置 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-settings-line text-amber-500 mr-1.5"></i>基本设置
                </h4>
                
                <div class="space-y-4">
                  <!-- 自动保存设置 -->
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-700 dark:text-gray-300">自动保存订单</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">每15分钟自动保存订单到本地存储</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="autoSaveToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 dark:peer-focus:ring-amber-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-amber-500"></div>
                    </label>
                  </div>
                  
                  <!-- 自动同步设置 -->
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-700 dark:text-gray-300">自动云端同步</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">添加新订单后自动同步到云端服务器</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="autoSyncToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-amber-300 dark:peer-focus:ring-amber-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-amber-500"></div>
                    </label>
                  </div>
                </div>
              </div>
              
              <!-- 自动清理设置 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-delete-bin-line text-rose-500 mr-1.5"></i>自动清理设置
                </h4>
                
                <div class="space-y-4">
                  <!-- 每日自动清理 -->
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-sm font-medium text-gray-700 dark:text-gray-300">每日自动清理</p>
                      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">每天凌晨1:00自动删除当日订单并保存历史</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                      <input type="checkbox" id="autoClearToggle" class="sr-only peer" checked>
                      <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-rose-300 dark:peer-focus:ring-rose-800 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-rose-500"></div>
                    </label>
                  </div>
                  
                  <!-- 清理时间设置 -->
                  <div>
                    <label for="autoClearTime" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">自动清理时间</label>
                    <div class="flex items-center space-x-2">
                      <select id="autoClearTime" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-amber-500 focus:border-amber-500 block w-full p-2.5 dark:bg-dark-500 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-amber-500 dark:focus:border-amber-500">
                        <option value="1">凌晨1:00</option>
                        <option value="0">凌晨0:00</option>
                        <option value="2">凌晨2:00</option>
                        <option value="3">凌晨3:00</option>
                        <option value="4">凌晨4:00</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 系统维护 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-tools-line text-blue-500 mr-1.5"></i>系统维护
                </h4>
                
                <div class="grid grid-cols-2 gap-3">
                  <button id="exportSystemDataBtn" type="button" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center">
                    <i class="ri-download-2-line mr-1.5"></i>导出系统数据
                  </button>
                  <button id="importSystemDataBtn" type="button" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center">
                    <i class="ri-upload-2-line mr-1.5"></i>导入系统数据
                  </button>
                  <button id="clearCacheBtn" type="button" class="bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center">
                    <i class="ri-refresh-line mr-1.5"></i>清除浏览器缓存
                  </button>
                  <button id="resetSystemBtn" type="button" class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center">
                    <i class="ri-restart-line mr-1.5"></i>重置系统
                  </button>
                </div>
              </div>
              
              <!-- 关于系统 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-information-line text-green-500 mr-1.5"></i>关于系统
                </h4>
                
                <div class="flex flex-col items-center mb-4">
                  <div id="gghLogoEasterEgg" class="w-16 h-16 bg-black rounded-lg shadow-lg flex items-center justify-center mb-2 cursor-pointer transition-transform hover:scale-105 active:scale-95" title="GGH Logo">
                    <span class="text-white font-bold text-xl tracking-wider">GGH</span>
                  </div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">GGH Pattern</div>
                </div>
                
                <div class="space-y-2">
                  <div class="flex justify-between">
                    <span class="text-sm text-gray-600 dark:text-gray-400">系统版本</span>
                    <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">V4.3.1</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-sm text-gray-600 dark:text-gray-400">最后更新</span>
                    <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">2025/3/23</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-sm text-gray-600 dark:text-gray-400">开发者</span>
                    <span class="text-sm text-gray-800 dark:text-gray-200 font-medium">Law Chi To</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 保存按钮 -->
            <div class="mt-6 flex justify-end">
              <button id="saveSystemSettingsBtn" type="button" class="bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 transition-smooth btn-press shadow-md flex items-center">
                <i class="ri-save-line mr-1.5"></i>保存设置
              </button>
            </div>
          </div>
        `;
        
        document.body.appendChild(systemSettingsPanel);
        
        // 绑定关闭按钮事件
        document.getElementById('closeSystemSettingsBtn').addEventListener('click', function() {
          document.body.removeChild(systemSettingsPanel);
        });
        
        // 绑定保存设置按钮事件
        document.getElementById('saveSystemSettingsBtn').addEventListener('click', function() {
          // 获取设置值
          const autoSave = document.getElementById('autoSaveToggle').checked;
          const autoSync = document.getElementById('autoSyncToggle').checked;
          const autoClear = document.getElementById('autoClearToggle').checked;
          const autoClearTime = document.getElementById('autoClearTime').value;
          
          // 保存设置到 localStorage
          localStorage.setItem('patternSystemSettings', JSON.stringify({
            autoSave,
            autoSync,
            autoClear,
            autoClearTime,
            lastUpdated: new Date().toISOString()
          }));
          
          // 重新设置自动删除计时器
          if (autoClear) {
            // 清除现有计时器
            if (autoDeleteTimer) {
              clearTimeout(autoDeleteTimer);
            }
            
            // 设置新的计时器时间
            setupAutomaticOrderDeletion(parseInt(autoClearTime));
          } else if (autoDeleteTimer) {
            // 如果关闭了自动清理，清除计时器
            clearTimeout(autoDeleteTimer);
            autoDeleteTimer = null;
          }
          
          showStatusMessage('系统设置已保存', 'success');
          document.body.removeChild(systemSettingsPanel);
        });
        
        // 绑定系统维护按钮事件
        document.getElementById('exportSystemDataBtn').addEventListener('click', exportOrdersAsJSON);
        document.getElementById('importSystemDataBtn').addEventListener('click', importOrdersFromJSON);
        
        document.getElementById('clearCacheBtn').addEventListener('click', function() {
          showConfirmDialog(
            "清除浏览器缓存",
            "确定要清除浏览器缓存吗？这将删除所有临时数据，但不会影响您的订单数据。",
            (confirmed) => {
              if (confirmed) {
                try {
                  // 清除不重要的缓存数据
                  localStorage.removeItem('patternSystemCache');
                  localStorage.removeItem('patternTempData');
                  
                  // 清除浏览器缓存 API (如果可用)
                  if ('caches' in window) {
                    caches.keys().then(cacheNames => {
                      cacheNames.forEach(cacheName => {
                        if (cacheName.startsWith('pattern-')) {
                          caches.delete(cacheName);
                        }
                      });
                    });
                  }
                  
                  showStatusMessage('浏览器缓存已清除', 'success');
                } catch (error) {
                  console.error('清除缓存失败:', error);
                  showStatusMessage('清除缓存失败: ' + error.message, 'error');
                }
              }
            }
          );
        });
        
        document.getElementById('resetSystemBtn').addEventListener('click', function() {
          showConfirmDialog(
            "重置系统",
            "确定要重置系统吗？这将删除所有设置和缓存，但不会删除您的订单数据。此操作不可撤销。",
            (confirmed) => {
              if (confirmed) {
                try {
                  // 只删除设置相关数据，保留订单数据
                  localStorage.removeItem('patternSystemSettings');
                  localStorage.removeItem('patternSystemCache');
                  localStorage.removeItem('patternTempData');
                  
                  showStatusMessage('系统已重置，将在3秒后刷新页面', 'success');
                  
                  // 3秒后刷新页面
                  setTimeout(() => {
                    window.location.reload();
                  }, 3000);
                } catch (error) {
                  console.error('重置系统失败:', error);
                  showStatusMessage('重置系统失败: ' + error.message, 'error');
                }
              }
            }
          );
        });
        
        // 加载现有设置
        try {
          const savedSettings = localStorage.getItem('patternSystemSettings');
          if (savedSettings) {
            const settings = JSON.parse(savedSettings);
            document.getElementById('autoSaveToggle').checked = settings.autoSave !== false; // 默认为true
            document.getElementById('autoSyncToggle').checked = settings.autoSync !== false; // 默认为true
            document.getElementById('autoClearToggle').checked = settings.autoClear !== false; // 默认为true
            
            if (settings.autoClearTime) {
              document.getElementById('autoClearTime').value = settings.autoClearTime;
            }
          }
        } catch (error) {
          console.error('加载系统设置失败:', error);
        }
      }
      // 添加批量操作按钮事件
      if (document.getElementById('bulkOperationsBtn')) {
        document.getElementById('bulkOperationsBtn').addEventListener('click', showBulkOperations);
      }
      
      // 批量操作功能
      function showBulkOperations() {
        showStatusMessage('正在打开批量操作面板...', 'info');
        
        // 创建批量操作面板
        const bulkOperationsPanel = document.createElement('div');
        bulkOperationsPanel.id = 'bulkOperationsPanel';
        bulkOperationsPanel.className = 'fixed inset-0 z-50 bg-black bg-opacity-50 backdrop-blur flex items-center justify-center';
        bulkOperationsPanel.innerHTML = `
          <div class="bg-white dark:bg-dark-300 max-w-lg w-11/12 rounded-xl shadow-2xl animate-dialogScale p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <div class="flex items-center">
                <i class="ri-group-line text-xl text-rose-500 mr-2"></i>
                <h3 class="text-lg font-semibold text-gray-800 dark:text-white">批量操作</h3>
              </div>
              <button id="closeBulkOperationsBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-1.5 transition-colors hover:bg-gray-100 dark:hover:bg-dark-200">
                <i class="ri-close-line text-xl"></i>
              </button>
            </div>
            
            <!-- 批量操作内容 -->
            <div class="space-y-5">
              <!-- 批量选择 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-checkbox-multiple-line text-rose-500 mr-1.5"></i>批量选择
                </h4>
                
                <div class="space-y-4">
                  <!-- 按类型选择 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">按餐品类型选择</label>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                      <button type="button" class="bulk-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-2 px-3 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 transition-all duration-200 ease-out flex items-center justify-center" data-category="pasta">
                        <i class="ri-restaurant-2-line mr-1.5"></i>意粉
                      </button>
                      <button type="button" class="bulk-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-2 px-3 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 transition-all duration-200 ease-out flex items-center justify-center" data-category="rice">
                        <i class="ri-cup-line mr-1.5"></i>饭类
                      </button>
                      <button type="button" class="bulk-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-2 px-3 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 transition-all duration-200 ease-out flex items-center justify-center" data-category="burger">
                        <i class="ri-takeaway-fill mr-1.5"></i>汉堡
                      </button>
                      <button type="button" class="bulk-category-btn bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg py-2 px-3 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-dark-300 transition-all duration-200 ease-out flex items-center justify-center" data-category="pizza">
                        <i class="ri-pie-chart-line mr-1.5"></i>Pizza
                      </button>
                    </div>
                  </div>
                  
                  <!-- 按用户选择 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">按用户姓名选择</label>
                    <div id="bulkUserSelection" class="space-y-2 max-h-40 overflow-y-auto styled-scrollbar">
                      <div class="flex justify-center py-2">
                        <div class="animate-spin h-5 w-5 text-gray-500">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
                            <path d="M12 2a10 10 0 0 1 10 10"></path>
                          </svg>
                        </div>
                        <span class="ml-2 text-sm text-gray-500 dark:text-gray-400">加载用户列表中...</span>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 选择日期范围 -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">按日期范围选择</label>
                    <div class="grid grid-cols-2 gap-3">
                      <div>
                        <label for="bulkStartDate" class="block text-xs text-gray-500 dark:text-gray-400 mb-1">开始日期</label>
                        <input type="date" id="bulkStartDate" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
                      </div>
                      <div>
                        <label for="bulkEndDate" class="block text-xs text-gray-500 dark:text-gray-400 mb-1">结束日期</label>
                        <input type="date" id="bulkEndDate" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- 批量操作按钮 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-tools-line text-blue-500 mr-1.5"></i>批量操作工具
                </h4>
                
                <div class="space-y-4">
                  <div id="selectedCountDisplay" class="bg-gray-50 dark:bg-dark-200 p-3 rounded-lg text-center">
                    <span class="text-sm text-gray-600 dark:text-gray-400">当前已选择: <span id="selectedOrdersCount" class="font-medium text-rose-600 dark:text-rose-400">0</span> 个订单</span>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-3">
                    <button id="bulkExportBtn" type="button" class="bulk-action-btn bg-green-600 hover:bg-green-700 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="ri-file-copy-line mr-1.5"></i>导出选中
                    </button>
                    <button id="bulkDeleteBtn" type="button" class="bulk-action-btn bg-red-600 hover:bg-red-700 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                      <i class="ri-delete-bin-line mr-1.5"></i>删除选中
                    </button>
                    <button id="selectAllBtn" type="button" class="bulk-action-btn bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center col-span-2">
                      <i class="ri-checkbox-multiple-fill mr-1.5"></i>全选
                    </button>
                    <button id="clearSelectionBtn" type="button" class="bulk-action-btn bg-gray-600 hover:bg-gray-700 text-white py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center col-span-2">
                      <i class="ri-close-circle-line mr-1.5"></i>清除选择
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- 批量预览 -->
              <div class="bg-white dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm">
                <h4 class="text-base font-medium text-gray-800 dark:text-white mb-3 flex items-center">
                  <i class="ri-eye-line text-purple-500 mr-1.5"></i>已选订单预览
                </h4>
                
                <div id="bulkPreviewArea" class="max-h-60 overflow-y-auto styled-scrollbar bg-gray-50 dark:bg-dark-200 p-3 rounded-lg">
                  <div class="text-center py-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400">请先选择需要操作的订单</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(bulkOperationsPanel);
        
        // 设置今天和一周前的默认日期
        const today = new Date();
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(today.getDate() - 7);
        
        document.getElementById('bulkEndDate').value = today.toISOString().split('T')[0];
        document.getElementById('bulkStartDate').value = oneWeekAgo.toISOString().split('T')[0];
        
        // 绑定关闭按钮事件
        document.getElementById('closeBulkOperationsBtn').addEventListener('click', function() {
          document.body.removeChild(bulkOperationsPanel);
        });
        
        // 获取所有订单
        const allOrders = getOrders();
        
        // 存储选中的订单ID
        let selectedOrderIds = new Set();
        
        // 根据现有订单构建用户列表
        const userSet = new Set();
        allOrders.forEach(order => {
          userSet.add(order.name);
        });
        
        // 更新用户选择区域
        const userSelectionArea = document.getElementById('bulkUserSelection');
        if (userSet.size === 0) {
          userSelectionArea.innerHTML = `
            <div class="text-center py-2">
              <p class="text-sm text-gray-500 dark:text-gray-400">暂无用户数据</p>
            </div>
          `;
        } else {
          userSelectionArea.innerHTML = '';
          Array.from(userSet).sort().forEach(userName => {
            const userCheckbox = document.createElement('div');
            userCheckbox.className = 'flex items-center bg-white dark:bg-dark-500 p-2 rounded-md border border-gray-200 dark:border-gray-600';
            userCheckbox.innerHTML = `
              <input type="checkbox" id="user-${userName}" data-user="${userName}" class="bulk-user-checkbox h-4 w-4 text-rose-600 focus:ring-rose-500 border-gray-300 rounded custom-checkbox">
              <label for="user-${userName}" class="ml-2 text-sm text-gray-700 dark:text-gray-300">${userName}</label>
            `;
            userSelectionArea.appendChild(userCheckbox);
          });
        }
        
        // 更新已选订单数量显示
        function updateSelectedCount() {
          document.getElementById('selectedOrdersCount').textContent = selectedOrderIds.size;
          
          // 更新预览区域
          const previewArea = document.getElementById('bulkPreviewArea');
          if (selectedOrderIds.size === 0) {
            previewArea.innerHTML = `
              <div class="text-center py-4">
                <p class="text-sm text-gray-500 dark:text-gray-400">请先选择需要操作的订单</p>
              </div>
            `;
          } else {
            previewArea.innerHTML = '';
            const selectedOrders = allOrders.filter(order => selectedOrderIds.has(order.id));
            selectedOrders.forEach(order => {
              const orderPreview = document.createElement('div');
              orderPreview.className = 'bg-white dark:bg-dark-400 p-2 rounded-md border border-gray-200 dark:border-gray-600 mb-2 text-sm';
              orderPreview.innerHTML = `
                <div class="flex justify-between items-center">
                  <span class="font-medium text-gray-800 dark:text-white">${order.name}</span>
                  <span class="text-xs text-gray-500 dark:text-gray-400">${new Date(order.timestamp).toLocaleString('zh-HK', { 
                    month: 'numeric', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                  })}</span>
                </div>
                <div class="text-gray-600 dark:text-gray-300 mt-1">
                  <span>${order.food}</span>
                  ${order.drink ? `<span class="ml-2">+ ${order.drink}</span>` : ''}
                </div>
              `;
              previewArea.appendChild(orderPreview);
            });
          }
          
          // 启用/禁用批量操作按钮
          const actionButtons = document.querySelectorAll('.bulk-action-btn');
          actionButtons.forEach(button => {
            if (button.id === 'selectAllBtn' || button.id === 'clearSelectionBtn') {
              return; // 这两个按钮不需要根据选择来禁用
            }
            button.disabled = selectedOrderIds.size === 0;
          });
        }
        
        // 根据类型选择订单
        const categoryButtons = document.querySelectorAll('.bulk-category-btn');
        categoryButtons.forEach(button => {
          button.addEventListener('click', function() {
            const category = this.dataset.category;
            
            // 高亮显示选中的类别按钮
            categoryButtons.forEach(btn => {
              if (btn === this) {
                btn.classList.remove('bg-white', 'dark:bg-dark-400');
                btn.classList.add('bg-rose-500', 'text-white');
              } else {
                btn.classList.remove('bg-rose-500', 'text-white');
                btn.classList.add('bg-white', 'dark:bg-dark-400');
              }
            });
            
            // 根据类别选择订单
            allOrders.forEach(order => {
              let isInCategory = false;
              
              // 检查订单的食物是否属于选定类别
              if (category === 'pasta') {
                isInCategory = menuData.pasta.some(item => item.name === order.food);
              } else if (category === 'rice') {
                isInCategory = menuData.rice.some(item => item.name === order.food);
              } else if (category === 'burger') {
                isInCategory = menuData.burger.some(item => item.name === order.food);
              } else if (category === 'pizza') {
                isInCategory = menuData.pizza.some(item => item.name === order.food);
              }
              
              if (isInCategory) {
                selectedOrderIds.add(order.id);
              }
            });
            
            updateSelectedCount();
          });
        });
        
        // 根据用户选择订单
        document.querySelectorAll('.bulk-user-checkbox').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const userName = this.dataset.user;
            
            if (this.checked) {
              // 添加该用户的所有订单
              allOrders.forEach(order => {
                if (order.name === userName) {
                  selectedOrderIds.add(order.id);
                }
              });
            } else {
              // 移除该用户的所有订单
              allOrders.forEach(order => {
                if (order.name === userName) {
                  selectedOrderIds.delete(order.id);
                }
              });
            }
            
            updateSelectedCount();
          });
        });
        
        // 按日期范围选择
        document.getElementById('bulkStartDate').addEventListener('change', filterByDateRange);
        document.getElementById('bulkEndDate').addEventListener('change', filterByDateRange);
        
        function filterByDateRange() {
          const startDateStr = document.getElementById('bulkStartDate').value;
          const endDateStr = document.getElementById('bulkEndDate').value;
          
          if (!startDateStr || !endDateStr) {
            return;
          }
          
          const startDate = new Date(startDateStr);
          startDate.setHours(0, 0, 0, 0);
          
          const endDate = new Date(endDateStr);
          endDate.setHours(23, 59, 59, 999);
          
          // 按日期范围选择订单
          allOrders.forEach(order => {
            const orderDate = new Date(order.timestamp);
            
            if (orderDate >= startDate && orderDate <= endDate) {
              selectedOrderIds.add(order.id);
            }
          });
          
          updateSelectedCount();
        }
        
        // 全选按钮
        document.getElementById('selectAllBtn').addEventListener('click', function() {
          allOrders.forEach(order => {
            selectedOrderIds.add(order.id);
          });
          
          // 更新用户选择框状态
          document.querySelectorAll('.bulk-user-checkbox').forEach(checkbox => {
            checkbox.checked = true;
          });
          
          updateSelectedCount();
        });
        
        // 清除选择按钮
        document.getElementById('clearSelectionBtn').addEventListener('click', function() {
          selectedOrderIds.clear();
          
          // 更新用户选择框状态
          document.querySelectorAll('.bulk-user-checkbox').forEach(checkbox => {
            checkbox.checked = false;
          });
          
          // 重置类别按钮样式
          categoryButtons.forEach(btn => {
            btn.classList.remove('bg-rose-500', 'text-white');
            btn.classList.add('bg-white', 'dark:bg-dark-400');
          });
          
          updateSelectedCount();
        });
        
        // 导出选中按钮
        document.getElementById('bulkExportBtn').addEventListener('click', function() {
          if (selectedOrderIds.size === 0) {
            showStatusMessage('请先选择要导出的订单', 'warning');
            return;
          }
          
          const selectedOrders = allOrders.filter(order => selectedOrderIds.has(order.id));
          const exportText = generateTextSummary(selectedOrders);
          
          navigator.clipboard.writeText(exportText).then(() => {
            showExportSuccessDialog();
          }).catch(err => {
            showStatusMessage('无法复制到剪贴板: ' + err, 'error');
          });
        });
        
        // 删除选中按钮
        document.getElementById('bulkDeleteBtn').addEventListener('click', function() {
          if (selectedOrderIds.size === 0) {
            showStatusMessage('请先选择要删除的订单', 'warning');
            return;
          }
          
          showConfirmDialog(
            "批量删除订单",
            `确定要删除选中的 ${selectedOrderIds.size} 个订单吗？此操作不可撤销。`,
            (confirmed) => {
              if (confirmed) {
                try {
                  let orders = getOrders();
                  orders = orders.filter(order => !selectedOrderIds.has(order.id));
                  orderStore = orders;
                  updateSummary();
                  saveToLocalStorage();
                  syncToCloudflare(true);
                  
                  showStatusMessage(`已删除 ${selectedOrderIds.size} 个订单`, 'success');
                  
                  // 关闭批量操作面板
                  document.body.removeChild(bulkOperationsPanel);
                } catch (error) {
                  console.error("批量删除订单错误:", error);
                  showStatusMessage('删除失败: ' + error.message, 'error');
                }
              }
            }
          );
        });
        
        // 初始化更新计数器
        updateSelectedCount();
      }
      // 绑定数据导出按钮事件
      const dataExportBtn = document.getElementById('dataExportBtn');
      if (dataExportBtn) {
        console.log('找到数据导出按钮，绑定事件');
        dataExportBtn.addEventListener('click', function() {
          console.log('数据导出按钮被点击');
          exportOrdersAsJSON();
        });
      } else {
        console.error('未找到数据导出按钮');
      }
      if (document.getElementById('generateSummaryViewBtn')) {
        document.getElementById('generateSummaryViewBtn').addEventListener('click', function() {
          generateSummary();
        });
      }
      if (document.getElementById('syncToCloudflareViewBtn')) {
        document.getElementById('syncToCloudflareViewBtn').addEventListener('click', function() {
          syncToCloudflareView(false);
        });
      }
      
      loadOrderHistoryFromStorage();
      
      // 從云端加載歷史記錄
      loadHistoryFromCloud().then(() => {
        console.log("從云端加載歷史記錄完成");
      }).catch(error => {
        console.error("從云端加載歷史記錄失敗:", error);
      });
      
      setupAutomaticOrderDeletion();
      
      syncOrdersFromCloud();
    }

    // 分析標籤頁
    function activateAnalysisTab(tab, content) {
      [document.getElementById('dailyStatsTab'), document.getElementById('weeklyTrendsTab'), document.getElementById('userPreferencesTab')].forEach(t => {
        t.classList.remove('bg-green-500', 'text-white');
        t.classList.add('bg-gray-200', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
      });
      
      [document.getElementById('dailyStatsContent'), document.getElementById('weeklyTrendsContent'), document.getElementById('userPreferencesContent')].forEach(c => {
        c.classList.add('hidden');
      });
      
      tab.classList.remove('bg-gray-200', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
      tab.classList.add('bg-green-500', 'text-white');
      content.classList.remove('hidden');
      
      if (tab.id === 'dailyStatsTab') {
        loadDailyStats();
      } else if (tab.id === 'userPreferencesTab') {
        loadUserPreferencesStats();
      } else if (tab.id === 'weeklyTrendsTab') {
        // 更新週趨勢圖表
        updateCharts();
      }
    }
    
    function loadDailyStats() {
      const allOrders = getOrders();
      
      // 過濾只保留當天的訂單
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      const todayOrders = allOrders.filter(order => {
        if (order.name && order.name.startsWith('5E')) {
          return false;
        }

        const orderDate = new Date(order.timestamp);
        orderDate.setHours(0, 0, 0, 0);
        return orderDate.getTime() === today.getTime();
      });
      
      document.getElementById('totalOrdersToday').textContent = todayOrders.length;
      
      let totalSpending = 0;
      todayOrders.forEach(order => {
        for (const category in menuData) {
          const menuItem = menuData[category].find(item => item.name === order.food);
          if (menuItem) {
            totalSpending += menuItem.price;
            break;
          }
        }
      });
      
      document.getElementById('totalSpendingToday').textContent = `$${totalSpending}`;
      document.getElementById('avgSpendingToday').textContent = `$${todayOrders.length > 0 ? Math.round(totalSpending / todayOrders.length) : 0}`;
      
      updatePopularItemsList(todayOrders);
    }
    
    function updatePopularItemsList(orders) {
      const popularItemsList = document.getElementById('popularItemsList');
      if (!orders || orders.length === 0) {
        popularItemsList.innerHTML = `
          <div class="text-center p-4 text-gray-500 dark:text-gray-400">
            暫無訂單數據
          </div>
        `;
        return;
      }
      
      const foodCounts = {};
      orders.forEach(order => {
        foodCounts[order.food] = (foodCounts[order.food] || 0) + 1;
      });
      
      const popularItems = Object.entries(foodCounts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      
      let html = '';
      popularItems.forEach((item, index) => {
        const [food, count] = item;
        const percentage = Math.round((count / orders.length) * 100);
        let badgeClass = '';
        if (index === 0) {
          badgeClass = 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400';
        } else if (index === 1) {
          badgeClass = 'bg-gray-100 text-gray-700 dark:bg-gray-900/30 dark:text-gray-400';
        } else if (index === 2) {
          badgeClass = 'bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400';
        } else {
          badgeClass = 'bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400';
        }
        
        html += `
          <div class="flex items-center py-2 ${index < popularItems.length - 1 ? 'border-b border-gray-100 dark:border-gray-700' : ''}">
            <div class="w-8 h-8 flex items-center justify-center ${badgeClass} rounded-full mr-3 flex-shrink-0">
              ${index + 1}
            </div>
            <div class="flex-1">
              <div class="flex justify-between mb-1">
                <span class="text-sm font-medium text-gray-800 dark:text-white">${food}</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">${count}份 (${percentage}%)</span>
              </div>
              <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
                <div class="bg-primary-600 h-1.5 rounded-full" style="width: ${percentage}%"></div>
              </div>
            </div>
          </div>
        `;
      });
      
      popularItemsList.innerHTML = html;
    }
    
    function loadUserPreferencesStats() {
      const userPreferencesList = document.getElementById('userPreferencesList');
      const orders = getOrders();
      
      if (!orders || orders.length === 0) {
        userPreferencesList.innerHTML = `
          <div class="text-center p-4 text-gray-500 dark:text-gray-400">
            暫無訂單數據
          </div>
        `;
        return;
      }
      
      const userOrders = {};
      orders.forEach(order => {
        if (!userOrders[order.name]) userOrders[order.name] = [];
        userOrders[order.name].push(order);
      });
      
      const userPreferences = {};
      for (const user in userOrders) {
        const userOrdersList = userOrders[user];
        const foodCounts = {};
        const foodReqsCounts = {};
        
        userOrdersList.forEach(order => {
          foodCounts[order.food] = (foodCounts[order.food] || 0) + 1;
          order.foodReqs.forEach(req => {
            foodReqsCounts[req] = (foodReqsCounts[req] || 0) + 1;
          });
        });
        
        const favoriteFood = Object.entries(foodCounts).sort((a, b) => b[1] - a[1]).map(([food]) => food)[0] || '';
        const favoriteReqs = Object.entries(foodReqsCounts).sort((a, b) => b[1] - a[1]).slice(0, 2).map(([req]) => req);
        
        userPreferences[user] = {
          orderCount: userOrdersList.length,
          favoriteFood,
          favoriteReqs
        };
      }
      
      let html = '';
      Object.entries(userPreferences).forEach(([user, prefs]) => {
        html += `
          <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-200 dark:border-gray-700 mb-3">
            <div class="flex items-center mb-2">
              <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-medium mr-3">
                ${user.substring(0, 2)}
              </div>
              <div>
                <p class="font-medium text-gray-800 dark:text-white">${user}</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">訂單數: ${prefs.orderCount}</p>
              </div>
            </div>
            ${prefs.favoriteFood ? `
              <div class="ml-11 mt-1">
                <div class="text-xs text-gray-600 dark:text-gray-400 flex items-center">
                  <i class="ri-heart-line text-red-500 mr-1.5"></i>
                  <span>常點餐品: ${prefs.favoriteFood}</span>
                </div>
              </div>
            ` : ''}
            ${prefs.favoriteReqs.length > 0 ? `
              <div class="ml-11 mt-1">
                <div class="text-xs text-gray-600 dark:text-gray-400 flex items-center">
                  <i class="ri-star-line text-amber-500 mr-1.5"></i>
                  <span>常見偏好: ${prefs.favoriteReqs.join('、')}</span>
                </div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      userPreferencesList.innerHTML = html;
    }
    
    function loadOrderAnalysis() {
      loadDailyStats();
      updateCharts();
    }
    
    function closeAdminLoginDialog() {
      document.getElementById('adminLoginDialog').classList.add('hidden');
      document.getElementById('adminPassword').value = '';
    }
    
    async function handleAdminLogin() {
      const password = document.getElementById('adminPassword').value;
      const loginErrorEl = document.getElementById('loginError');
      const loginErrorText = document.getElementById('loginErrorText');
      const loginBtn = document.getElementById('adminLoginBtn');
      const loginBtnText = document.getElementById('loginBtnText');
      const loginBtnLoading = document.getElementById('loginBtnLoading');
      
      loginErrorEl.classList.add('hidden');
      
      if (!password) {
        loginErrorText.textContent = '請輸入密碼';
        loginErrorEl.classList.remove('hidden');
        return;
      }
      
      loginBtn.disabled = true;
      loginBtnText.classList.add('hidden');
      loginBtnLoading.classList.remove('hidden');
      
      try {
        if (adminPasswords[password]) {
          currentAdmin = adminPasswords[password];
          document.getElementById('adminName').textContent = currentAdmin.name;
          
          getUserIP().then(userIP => {
            if (userIP) {
              sendLoginIPToAPI(userIP, password);
              saveIPLoginState(userIP, password);
            }
          });
          
          saveAdminLoginState(password);
          
          if (currentAdmin.role === 'full-access') {
            document.getElementById('adminFullAccess').classList.remove('hidden');
            document.getElementById('adminViewAccess').classList.add('hidden');
          } else {
            document.getElementById('adminFullAccess').classList.add('hidden');
            document.getElementById('adminViewAccess').classList.remove('hidden');
          }
          
          document.getElementById('adminLoginDialog').classList.add('hidden');
          document.getElementById('adminPanel').classList.remove('hidden');
          
          document.getElementById('adminPassword').value = '';
          setTimeout(() => {
            showWelcomeDialog(currentAdmin);
          }, 200);
          
          showStatusMessage(`歡迎，${currentAdmin.name}！`, 'success');
        } else {
          loginErrorEl.classList.remove('hidden');
          loginErrorText.textContent = '密碼錯誤，請重試';
          document.getElementById('adminPassword').focus();
          loginErrorEl.classList.add('animate-shakeX');
          setTimeout(() => {
            loginErrorEl.classList.remove('animate-shakeX');
          }, 600);
        }
      } catch (error) {
        console.error('登入過程出錯:', error);
        loginErrorText.textContent = '登入過程發生錯誤，請重試';
        loginErrorEl.classList.remove('hidden');
      } finally {
        loginBtn.disabled = false;
        loginBtnText.classList.remove('hidden');
        loginBtnLoading.classList.add('hidden');
      }
    }
    
    function handleAdminLogout() {
      currentAdmin = null;
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('modifyOrdersPanel').classList.add('hidden');
      
      clearAdminLoginState();
      localStorage.removeItem('patternIPLoginStatus');
      
      showStatusMessage('已登出', 'success');
    }
    
    function promptClearAllOrders() {
      showConfirmDialog(
        "清除所有訂單", 
        "確定要清除所有訂單嗎？此操作不可撤銷。", 
        (confirmed) => {
          if (confirmed) {
            clearAllOrders();
          }
        }
      );
    }
    
    function clearAllOrders() {
      try {
        orderStore = [];
        updateSummary();
        localStorage.removeItem('patternOrders');
        saveToLocalStorage();
        showStatusMessage('所有訂單已清除', 'success');
        syncToCloudflare(true);
      } catch (error) {
        console.error("清除訂單錯誤:", error);
        showStatusMessage('清除失敗: ' + error.message, 'error');
      }
    }
    
    function tryLoadFromLocalStorage() {
      try {
        const storedOrders = localStorage.getItem('patternOrders');
        if (storedOrders) {
          const parsed = JSON.parse(storedOrders);
          if (Array.isArray(parsed) && parsed.length > 0) {
            console.log(`[本地存儲] 找到 ${parsed.length} 條訂單`);
            orderStore = parsed;
            updateSummary();
            return true;
          }
        }
      } catch (error) {
        console.warn('[本地存儲] 載入失敗:', error);
      }
      return false;
    }
    
    function saveToLocalStorage() {
      try {
        const orders = getOrders();
        localStorage.setItem('patternOrders', JSON.stringify(orders));
        localStorage.setItem('patternOrdersLastSave', new Date().toISOString());
        console.log(`[本地存儲] 已保存 ${orders.length} 條訂單`);
      } catch (error) {
        console.warn('[本地存儲] 保存失敗:', error);
      }
    }
    
    function showOrderModificationPanel() {
      const orders = getOrders();
      const orderList = document.getElementById('orderList');
      orderList.innerHTML = '';
      
      if (orders.length === 0) {
        orderList.innerHTML = '<div class="bg-gray-50 dark:bg-dark-400 p-4 rounded-lg text-gray-600 dark:text-gray-400 text-center">暫無訂單可修改</div>';
      } else {
        orders.forEach((order, index) => {
          const orderItem = document.createElement('div');
          orderItem.className = 'p-4 bg-white dark:bg-dark-400 border border-gray-200 dark:border-gray-600 rounded-lg mb-3 shadow-card card-hover transition-smooth slide-in-up';
          orderItem.style.animationDelay = `${index * 0.05}s`;
          orderItem.dataset.orderId = order.id;
          
          orderItem.innerHTML = `
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center">
                <span class="w-7 h-7 flex items-center justify-center bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-2 text-sm font-medium">${index + 1}</span>
                <p class="font-medium text-gray-800 dark:text-white">${order.name}</p>
              </div>
              <div class="flex gap-2">
                <button type="button" class="edit-order-btn px-2.5 py-1 text-xs bg-yellow-500 hover:bg-yellow-600 text-white rounded-md focus:outline-none focus:ring-1 focus:ring-yellow-500 transition-smooth btn-press shadow-sm flex items-center">
                  <i class="ri-edit-2-line mr-1"></i>編輯
                </button>
                <button type="button" class="delete-order-btn px-2.5 py-1 text-xs bg-red-500 hover:bg-red-600 text-white rounded-md focus:outline-none focus:ring-1 focus:ring-red-500 transition-smooth btn-press shadow-sm flex items-center">
                  <i class="ri-delete-bin-2-line mr-1"></i>刪除
                </button>
              </div>
            </div>
            <div class="pl-9">
              <p class="text-sm text-gray-700 dark:text-gray-300 flex items-center">
                <i class="ri-restaurant-2-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                <span class="font-medium">餐品:</span> 
                <span class="ml-1">${order.food}</span>
              </p>
              ${order.foodReqs.length > 0 ? 
                `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1 flex items-center">
                  <i class="ri-settings-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                  <span class="font-medium">要求:</span>
                  <span class="ml-1">${order.foodReqs.join(', ')}</span>
                </p>` : ''}
              ${order.drink ? 
                `<p class="text-sm text-gray-700 dark:text-gray-300 mt-1 flex items-center">
                  <i class="ri-cup-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                  <span class="font-medium">飲料:</span>
                  <span class="ml-1">${order.drink}</span>
                </p>` : ''}
              ${order.drinkReqs.length > 0 ? 
                `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1 flex items-center">
                  <i class="ri-settings-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                  <span class="font-medium">飲料要求:</span>
                  <span class="ml-1">${order.drinkReqs.join(', ')}</span>
                </p>` : ''}
              <p class="text-xs text-gray-500 dark:text-gray-500 mt-2 flex items-center">
                <i class="ri-time-line mr-1.5"></i>
                ${new Date(order.timestamp).toLocaleTimeString('zh-HK', {hour: '2-digit', minute: '2-digit'})}
              </p>
            </div>
          `;
          
          orderList.appendChild(orderItem);
          
          const editBtn = orderItem.querySelector('.edit-order-btn');
          const deleteBtn = orderItem.querySelector('.delete-order-btn');
          
          editBtn.addEventListener('click', () => {
            editOrder(order.id);
          });
          deleteBtn.addEventListener('click', () => {
            promptDeleteOrder(order.id);
          });
        });
      }
      
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('modifyOrdersPanel').classList.remove('hidden');
    }
    
    function promptDeleteOrder(orderId) {
      showConfirmDialog(
        "刪除訂單",
        "確定要刪除此訂單嗎？此操作不可撤銷。",
        (confirmed) => {
          if (confirmed) {
            deleteOrder(orderId);
          }
        }
      );
    }
    
    function editOrder(orderId) {
      const orders = getOrders();
      const orderToEdit = orders.find(o => o.id === orderId);
      if (!orderToEdit) {
        showStatusMessage('找不到此訂單', 'error');
        return;
      }
      
      document.getElementById('name').value = orderToEdit.name;
      
      let category = '';
      for (const [cat, items] of Object.entries(menuData)) {
        if (items.some(item => item.name === orderToEdit.food)) {
          category = cat;
          break;
        }
      }
      if (category) {
        const categoryBtn = document.querySelector(`.category-btn[data-category="${category}"]`);
        if (categoryBtn) {
          const categoryButtons = document.querySelectorAll('.category-btn');
          categoryButtons.forEach(btn => {
            btn.classList.remove('bg-primary-600', 'text-white');
            btn.classList.add('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
          });
          
          categoryBtn.classList.remove('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
          categoryBtn.classList.add('bg-primary-600', 'text-white');
          
          updateFoodOptions(category);
          
          setTimeout(() => {
            document.getElementById('foodSelect').value = orderToEdit.food;
          }, 100);
        }
      }
      
      document.querySelectorAll('input[name="foodReq"]').forEach(checkbox => {
        checkbox.checked = orderToEdit.foodReqs.includes(checkbox.value);
      });
      
      const drinkSelect = document.getElementById('drinkSelect');
      const drinkReqSection = document.getElementById('drinkReqSection');
      drinkSelect.value = orderToEdit.drink || '';
      if (orderToEdit.drink) {
        drinkReqSection.classList.remove('hidden');
        document.querySelectorAll('input[name="drinkReq"]').forEach(checkbox => {
          checkbox.checked = orderToEdit.drinkReqs.includes(checkbox.value);
        });
      } else {
        drinkReqSection.classList.add('hidden');
      }
      
      selectedOrderForEdit = orderId;
      document.getElementById('adminPanel').classList.add('hidden');
      document.getElementById('modifyOrdersPanel').classList.add('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      const submitBtn = document.querySelector('#orderForm button[type="submit"]');
      submitBtn.innerHTML = '<i class="ri-save-line mr-2"></i>更新訂單';
      
      showStatusMessage('正在編輯訂單', 'info');
    }
    
    function deleteOrder(orderId) {
      try {
        let orders = getOrders();
        const idx = orders.findIndex(o => o.id === orderId);
        if (idx === -1) {
          showStatusMessage('刪除失敗：找不到訂單', 'error');
          return;
        }
        
        orders.splice(idx, 1);
        orderStore = orders;
        showOrderModificationPanel();
        updateSummary();
        saveToLocalStorage();
        syncToCloudflare(true);
        showStatusMessage('訂單已刪除', 'success');
      } catch (error) {
        console.error("刪除訂單錯誤:", error);
        showStatusMessage('刪除失敗: ' + error.message, 'error');
      }
    }
    
    function updateFoodOptions(category) {
      const foodSelect = document.getElementById('foodSelect');
      foodSelect.innerHTML = '';
      
      if (!category || !menuData[category]) {
        const defaultOption = document.createElement('option');
        defaultOption.textContent = '請先選擇分類';
        defaultOption.value = '';
        defaultOption.disabled = true;
        defaultOption.selected = true;
        foodSelect.appendChild(defaultOption);
        return;
      }
      
      menuData[category].forEach(item => {
        const option = document.createElement('option');
        option.textContent = `${item.name} (${item.price}元)`;
        option.value = item.name;
        foodSelect.appendChild(option);
      });
      
      const defaultOption = document.createElement('option');
      defaultOption.textContent = '選擇餐品';
      defaultOption.value = '';
      defaultOption.selected = true;
      foodSelect.insertBefore(defaultOption, foodSelect.firstChild);
    }
      
    function handleOrderSubmit(event) {
      event.preventDefault();
      const name = document.getElementById('name').value.trim();
      const food = document.getElementById('foodSelect').value;
      const foodReqs = Array.from(document.querySelectorAll('input[name="foodReq"]:checked')).map(el => el.value);
      const drink = document.getElementById('drinkSelect').value;
      const drinkReqs = Array.from(document.querySelectorAll('input[name="drinkReq"]:checked')).map(el => el.value);
      
      if (!name) {
        showStatusMessage('請輸入你的名字', 'error');
        return;
      }
      if (!selectedOrderForEdit && !food) {
        showStatusMessage('請選擇餐品', 'error');
        return;
      }
      
      if (selectedOrderForEdit) {
        const orders = getOrders();
        const idx = orders.findIndex(o => o.id === selectedOrderForEdit);
        if (idx !== -1) {
          const originalOrder = orders[idx];
          orders[idx] = {
            ...originalOrder,
            name,
            food: food || originalOrder.food,
            foodReqs,
            drink,
            drinkReqs
          };
          orderStore = orders;
          selectedOrderForEdit = null;
          updateSummary();
          saveToLocalStorage();
          syncToCloudflare(true);
          
          orderForm.reset();
          document.getElementById('foodSelect').innerHTML = '<option value="" disabled selected>請先選擇分類</option>';
          document.getElementById('drinkReqSection').classList.add('hidden');
          const categoryButtons = document.querySelectorAll('.category-btn');
          categoryButtons.forEach(btn => {
            btn.classList.remove('bg-primary-600', 'text-white');
            btn.classList.add('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
          });
          
          const submitBtn = document.querySelector('#orderForm button[type="submit"]');
          submitBtn.innerHTML = '<i class="ri-send-plane-fill mr-2"></i>提交訂單';
          
          showStatusMessage('訂單已更新', 'success');
        } else {
          showStatusMessage('找不到要編輯的訂單', 'error');
        }
      } else {
        const order = {
          id: Date.now().toString(),
          timestamp: new Date().toISOString(),
          name,
          food,
          foodReqs,
          drink,
          drinkReqs
        };
        saveOrder(order);
        updateSummary();
        syncToCloudflare(true);
        
        orderForm.reset();
        document.getElementById('foodSelect').innerHTML = '<option value="" disabled selected>請先選擇分類</option>';
        document.getElementById('drinkReqSection').classList.add('hidden');
        const categoryButtons = document.querySelectorAll('.category-btn');
        categoryButtons.forEach(btn => {
          btn.classList.remove('bg-primary-600', 'text-white');
          btn.classList.add('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
        });
        
        showStatusMessage('訂單提交成功！', 'success');
      }
    }
    
    function saveOrder(order) {
      let orders = getOrders();
      orders.push(order);
      orderStore = orders;
      saveToLocalStorage();
    }
    
    function getOrders() {
      return [...orderStore];
    }
    
    // 按日期分组订单
    function groupOrdersByDate(orders) {
      const groups = {};
      
      orders.forEach(order => {
        const date = new Date(order.timestamp);
        // 使用本地时区而不是UTC格式化日期
        const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        if (!groups[dateStr]) {
          groups[dateStr] = [];
        }
        
        groups[dateStr].push(order);
      });
      
      return groups;
    }
    
    function updateSummary() {
      // 获取所有非5E开头的订单
      let orders = getOrders().filter(order => !order.name.startsWith('5E'));
      const summaryContent = document.getElementById('summaryContent');
      
      if (orders.length === 0) {
        summaryContent.innerHTML = `
          <div class="flex flex-col items-center justify-center text-center py-8">
            <div class="text-gray-300 dark:text-gray-600 mb-3 animate-float">
              <i class="ri-file-list-3-line text-5xl"></i>
            </div>
            <p class="text-gray-600 dark:text-gray-400">今日暫無訂單。</p>
            <p class="text-sm text-gray-500 dark:text-gray-500 mt-1">使用左側表單提交第一個訂單</p>
          </div>
        `;
        return;
      }
      
      // 按日期分组订单
      const ordersByDate = groupOrdersByDate(orders);
      
      // 获取所有日期并排序（最新的日期在前面）
      const dates = Object.keys(ordersByDate).sort((a, b) => new Date(b) - new Date(a));
      
      let summaryHtml = '';
      
      // 为每个日期创建一个分组
      dates.forEach(dateStr => {
        const ordersForDate = ordersByDate[dateStr];
        const date = new Date(dateStr);
        const formattedDate = date.toLocaleDateString('zh-HK', { 
          month: 'long', 
          day: 'numeric', 
          weekday: 'short' 
        });
        
        // 日期分隔符
        if (dateStr !== dates[0]) {
          summaryHtml += `
            <div class="date-divider">
              <span class="date-divider-text">${formattedDate}</span>
            </div>
          `;
        }
        
        // 当前日期的订单统计
        if (dateStr === dates[0]) {
          summaryHtml += `
            <div class="mb-3 pb-3 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between slide-in-up">
              <h3 class="text-lg font-medium text-gray-800 dark:text-white flex items-center">
                <i class="ri-calendar-line mr-2 text-primary-500"></i>
                ${formattedDate}
              </h3>
              <span class="text-sm bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 px-2 py-1 rounded-full">
                ${ordersForDate.length} 個訂單
              </span>
            </div>
          `;
        } else {
          summaryHtml += `
            <div class="my-3 flex items-center justify-between">
              <span class="text-sm bg-gray-100 dark:bg-gray-700/30 text-gray-600 dark:text-gray-400 px-2 py-1 rounded-full">
                ${ordersForDate.length} 個訂單
              </span>
            </div>
          `;
        }
        
        // 处理特定日期的订单统计
        const foodCount = {};
        const foodReqMap = {};
        const drinkCount = {};
        const drinkReqMap = {};
        const userFoodReqs = {};
        const userDrinkReqs = {};
        
        ordersForDate.forEach(order => {
          foodCount[order.food] = (foodCount[order.food] || 0) + 1;
          if (!foodReqMap[order.food]) {
            foodReqMap[order.food] = {};
          }
          order.foodReqs.forEach(req => {
            foodReqMap[order.food][req] = (foodReqMap[order.food][req] || 0) + 1;
          });
          if (order.foodReqs.length > 0) {
            if (!userFoodReqs[order.food]) {
              userFoodReqs[order.food] = {};
            }
            if (!userFoodReqs[order.food][order.name]) {
              userFoodReqs[order.food][order.name] = [];
            }
            userFoodReqs[order.food][order.name] = order.foodReqs;
          }
          
          if (order.drink) {
            drinkCount[order.drink] = (drinkCount[order.drink] || 0) + 1;
            if (!drinkReqMap[order.drink]) {
              drinkReqMap[order.drink] = {};
            }
            order.drinkReqs.forEach(req => {
              drinkReqMap[order.drink][req] = (drinkReqMap[order.drink][req] || 0) + 1;
            });
            if (order.drinkReqs.length > 0) {
              if (!userDrinkReqs[order.drink]) {
                userDrinkReqs[order.drink] = {};
              }
              if (!userDrinkReqs[order.drink][order.name]) {
                userDrinkReqs[order.drink][order.name] = [];
              }
              userDrinkReqs[order.drink][order.name] = order.drinkReqs;
            }
          }
        });
        
        summaryHtml += `
          <div class="mb-6 slide-in-up" style="animation-delay: 0.1s">
            <div class="flex items-center mb-2.5">
              <i class="ri-restaurant-2-line mr-2 text-primary-600"></i>
              <h4 class="text-md font-medium text-gray-800 dark:text-white">餐品統計</h4>
            </div>
            <ul class="space-y-3">
              ${Object.entries(foodCount).map(([food, count], index) => {
                let html = `
                  <li class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm slide-in-left" style="animation-delay: ${0.15 + index * 0.05}s">
                    <div class="flex items-center">
                      <span class="text-primary-600 dark:text-primary-400 font-medium">${count}份</span>
                      <span class="mx-1.5 text-gray-400">•</span>
                      <span class="font-medium text-gray-800 dark:text-white">${food}</span>
                    </div>
                `;
                if (foodReqMap[food] && Object.keys(foodReqMap[food]).length > 0) {
                  html += `<div class="mt-1.5 ml-6 pl-2 border-l-2 border-gray-200 dark:border-gray-700">`;
                  Object.entries(foodReqMap[food]).forEach(([req, reqCount]) => {
                    if (reqCount > 1) {
                      html += `<div class="text-sm text-gray-600 dark:text-gray-400 mb-1 flex items-center slide-in-left"><i class="ri-arrow-right-s-line mr-1 text-primary-400"></i>${req} x${reqCount}</div>`;
                    } else {
                      html += `<div class="text-sm text-gray-600 dark:text-gray-400 mb-1 flex items-center slide-in-left"><i class="ri-arrow-right-s-line mr-1 text-primary-400"></i>${req}</div>`;
                    }
                  });
                  html += '</div>';
                }
                if (userFoodReqs[food]) {
                  html += `<div class="mt-2 ml-6 pl-2 border-l-2 border-blue-200 dark:border-blue-800">`;
                  Object.entries(userFoodReqs[food]).forEach(([userName, reqs], reqIdx) => {
                    html += `<div class="text-sm text-blue-600 dark:text-blue-400 mb-1 flex items-start slide-in-left">
                      <i class="ri-user-line mr-1 mt-0.5 text-blue-500"></i>
                      <span class="font-medium">${userName}:</span>
                      <span class="ml-1">${reqs.join('、')}</span>
                    </div>`;
                  });
                  html += '</div>';
                }
                
                html += '</li>';
                return html;
              }).join('')}
            </ul>
          </div>
        `;
        
        if (Object.keys(drinkCount).length > 0) {
          summaryHtml += `
            <div class="mb-6 slide-in-up" style="animation-delay: 0.2s">
              <div class="flex items-center mb-2.5">
                <i class="ri-cup-line mr-2 text-primary-600"></i>
                <h4 class="text-md font-medium text-gray-800 dark:text-white">飲料統計</h4>
              </div>
              <ul class="space-y-3">
                ${Object.entries(drinkCount).map(([drink, count], index) => {
                  let html = `
                    <li class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm slide-in-left" style="animation-delay: ${0.25 + index * 0.05}s">
                      <div class="flex items-center">
                        <span class="text-primary-600 dark:text-primary-400 font-medium">${count}份</span>
                        <span class="mx-1.5 text-gray-400">•</span>
                        <span class="font-medium text-gray-800 dark:text-white">${drink}</span>
                      </div>
                  `;
                  if (drinkReqMap[drink] && Object.keys(drinkReqMap[drink]).length > 0) {
                    html += `<div class="mt-1.5 ml-6 pl-2 border-l-2 border-gray-200 dark:border-gray-700">`;
                    Object.entries(drinkReqMap[drink]).forEach(([req, reqCount], reqIndex) => {
                      if (reqCount > 1) {
                        html += `<div class="text-sm text-gray-600 dark:text-gray-400 mb-1 flex items-center slide-in-left"><i class="ri-arrow-right-s-line mr-1 text-primary-400"></i>${req} x${reqCount}</div>`;
                      } else {
                        html += `<div class="text-sm text-gray-600 dark:text-gray-400 mb-1 flex items-center slide-in-left"><i class="ri-arrow-right-s-line mr-1 text-primary-400"></i>${req}</div>`;
                      }
                    });
                    html += '</div>';
                  }
                  if (userDrinkReqs[drink]) {
                    html += `<div class="mt-2 ml-6 pl-2 border-l-2 border-blue-200 dark:border-blue-800">`;
                    Object.entries(userDrinkReqs[drink]).forEach(([userName, reqs], reqIdx) => {
                      html += `<div class="text-sm text-blue-600 dark:text-blue-400 mb-1 flex items-start slide-in-left">
                        <i class="ri-user-line mr-1 mt-0.5 text-blue-500"></i>
                        <span class="font-medium">${userName}:</span>
                        <span class="ml-1">${reqs.join('、')}</span>
                      </div>`;
                    });
                    html += '</div>';
                  }
                  
                  html += '</li>';
                  return html;
                }).join('')}
              </ul>
            </div>
          `;
        }
        
        summaryHtml += `
          <div class="mb-6 slide-in-up" style="animation-delay: 0.3s">
            <div class="flex items-center mb-2.5">
              <i class="ri-user-3-line mr-2 text-primary-600"></i>
              <h4 class="text-md font-medium text-gray-800 dark:text-white">個人訂單詳情</h4>
            </div>
            <div class="space-y-3">
        `;
        
        const groupedByName = ordersForDate.reduce((acc, o) => {
          if (!acc[o.name]) acc[o.name] = [];
          acc[o.name].push(o);
          return acc;
        }, {});
        
        Object.entries(groupedByName).forEach(([name, userOrders], nameIndex) => {
          summaryHtml += `
            <div class="bg-white dark:bg-dark-400 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm slide-in-up">
              <div class="flex items-center mb-2">
                <span class="w-6 h-6 flex items-center justify-center bg-primary-100 dark:bg-primary-900/30 text-primary-600 dark:text-primary-400 rounded-full mr-2 text-xs font-medium">${nameIndex + 1}</span>
                <p class="font-medium text-gray-800 dark:text-white">${name}</p>
              </div>
              <div class="space-y-2 ml-8">
                ${userOrders.map((order, orderIndex) => `
                  <div class="pb-2 ${orderIndex < userOrders.length - 1 ? 'border-b border-gray-100 dark:border-gray-700' : ''}">
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                      <i class="ri-restaurant-2-line text-gray-500 dark:text-gray-400 mr-1.5"></i>${order.food}
                      ${order.foodReqs.length > 0 ? `<span class="ml-2 text-gray-600 dark:text-gray-400"><i class="ri-arrow-right-s-line text-primary-400 mr-1"></i>${order.foodReqs.join('、')}</span>` : ''}
                    </p>
                    ${order.drink ? `
                      <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">
                        <i class="ri-cup-line text-gray-500 dark:text-gray-400 mr-1.5"></i>${order.drink}
                        ${order.drinkReqs.length > 0 ? `<span class="ml-2 text-gray-600 dark:text-gray-400"><i class="ri-arrow-right-s-line text-primary-400 mr-1"></i>${order.drinkReqs.join('、')}</span>` : ''}
                      </p>` : ''}
                    <p class="text-xs text-gray-500 dark:text-gray-500 mt-1 flex items-center">
                      <i class="ri-time-line mr-1.5"></i>
                      ${new Date(order.timestamp).toLocaleTimeString('zh-HK', {hour: '2-digit', minute: '2-digit'})}
                    </p>
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        });
        
        summaryHtml += `</div></div>`;
      });
      
      summaryContent.innerHTML = summaryHtml;
    }
    
    function generateSummary() {
      updateSummary();
      saveSummaryToStorage();
      saveToLocalStorage();
      syncToCloudflare(true);
      showStatusMessage('訂單匯總已生成', 'success');
    }
    
    function exportSummary(mode) {
      const format = mode === 'full' ? document.getElementById('exportFormat').value : document.getElementById('exportFormatView').value;
      const orders = getOrders();
      if (orders.length === 0) {
        showStatusMessage('沒有訂單可以導出', 'error');
        return;
      }
      let exportText = '';
      if (format === 'text') {
        exportText = generateTextSummary(orders);
      } else if (format === 'markdown') {
        exportText = generateMarkdownSummary(orders);
      }
      
      navigator.clipboard.writeText(exportText).then(() => {
        showExportSuccessDialog();
      }).catch(err => {
        showStatusMessage('無法複製到剪貼板: ' + err, 'error');
        console.error('Failed to copy:', err);
      });
    }
    
    function generateTextSummary(orders) {
      const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
      const currentDate = new Date();
      const weekday = weekdays[currentDate.getDay()];
      const formattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
      
      const separator = "============================================";
      const subSeparator = "--------------------------------------------";
      
      let summary = `🍽️ Pattern 餐廳訂單匯總 🍽️\n`;
      summary += `📅 ${formattedDate} (星期${weekday})   👥 總訂單數: ${orders.length}\n`;
      summary += `${separator}\n\n`;
      
      const foodReqsByUser = {};
      const drinkReqsByUser = {};
      const foodCount = {};
      const drinkCount = {};
      
      orders.forEach(order => {
        foodCount[order.food] = (foodCount[order.food] || 0) + 1;
        if (order.foodReqs.length > 0) {
          if (!foodReqsByUser[order.food]) {
            foodReqsByUser[order.food] = [];
          }
          foodReqsByUser[order.food].push(order.foodReqs);
        }
        if (order.drink) {
          drinkCount[order.drink] = (drinkCount[order.drink] || 0) + 1;
          if (order.drinkReqs.length > 0) {
            if (!drinkReqsByUser[order.drink]) {
              drinkReqsByUser[order.drink] = [];
            }
            drinkReqsByUser[order.drink].push(order.drinkReqs);
          }
        }
      });
      
      summary += `📋 餐品總數統計\n${subSeparator}\n`;
      Object.entries(foodCount).sort((a, b) => b[1] - a[1]).forEach(([food, count]) => {
        summary += `${food}: ${count}份\n`;
        if (foodReqsByUser[food] && foodReqsByUser[food].length > 0) {
          const reqCounts = {};
          foodReqsByUser[food].forEach(reqArray => {
            const reqString = reqArray.join('、');
            reqCounts[reqString] = (reqCounts[reqString] || 0) + 1;
          });
          Object.entries(reqCounts).forEach(([reqStr, reqCount]) => {
            if (reqCount > 1) {
              summary += `   ↳ ${reqStr} x${reqCount}\n`;
            } else {
              summary += `   ↳ ${reqStr}\n`;
            }
          });
        }
        summary += '\n';
      });
      
      if (Object.keys(drinkCount).length > 0) {
        summary += `🥤 飲料總數統計\n${subSeparator}\n`;
        Object.entries(drinkCount).sort((a, b) => b[1] - a[1]).forEach(([drink, count], index) => {
          summary += `${index + 1}. ${drink}: ${count}份\n`;
          if (drinkReqsByUser[drink] && drinkReqsByUser[drink].length > 0) {
            const reqCounts = {};
            drinkReqsByUser[drink].forEach(reqArray => {
              const reqString = reqArray.join(' ');
              reqCounts[reqString] = (reqCounts[reqString] || 0) + 1;
            });
            Object.entries(reqCounts).forEach(([reqStr, reqCount]) => {
              const formattedReq = reqStr.split(' ').join('');
              if (reqCount > 1) {
                summary += `   ↳ ${formattedReq} x${reqCount}\n`;
              } else {
                summary += `   ↳ ${formattedReq}\n`;
              }
            });
          }
        });
      }
      
      const timeStr = new Date().toLocaleTimeString('zh-HK', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      summary += `${separator}\n`;
      summary += `自動匯總時間: ${timeStr}\n`;
      
      return summary;
    }
    
    function analyzeOrders(orders) {
      const foodCount = {};
      const foodReqMap = {};
      const drinkCount = {};
      const drinkReqMap = {};
      const userFoodReqs = {};
      const userDrinkReqs = {};
      
      orders.forEach(order => {
        foodCount[order.food] = (foodCount[order.food] || 0) + 1;
        if (!foodReqMap[order.food]) {
          foodReqMap[order.food] = {};
        }
        order.foodReqs.forEach(req => {
          foodReqMap[order.food][req] = (foodReqMap[order.food][req] || 0) + 1;
        });
        if (order.foodReqs.length > 0) {
          if (!userFoodReqs[order.food]) {
            userFoodReqs[order.food] = {};
          }
          if (!userFoodReqs[order.food][order.name]) {
            userFoodReqs[order.food][order.name] = [];
          }
          userFoodReqs[order.food][order.name] = order.foodReqs;
        }
        
        if (order.drink) {
          drinkCount[order.drink] = (drinkCount[order.drink] || 0) + 1;
          if (!drinkReqMap[order.drink]) {
            drinkReqMap[order.drink] = {};
          }
          order.drinkReqs.forEach(req => {
            drinkReqMap[order.drink][req] = (drinkReqMap[order.drink][req] || 0) + 1;
          });
          if (order.drinkReqs.length > 0) {
            if (!userDrinkReqs[order.drink]) {
              userDrinkReqs[order.drink] = {};
            }
            if (!userDrinkReqs[order.drink][order.name]) {
              userDrinkReqs[order.drink][order.name] = [];
            }
            userDrinkReqs[order.drink][order.name] = order.drinkReqs;
          }
        }
      });
      
      return { foodCount, foodReqMap, drinkCount, drinkReqMap, userFoodReqs, userDrinkReqs };
    }
    
    function generateMarkdownSummary(orders) {
      const analysis = analyzeOrders(orders);
      let summary = `# Pattern 餐廳訂單匯總 (${new Date().toLocaleDateString('zh-HK')})\n`;
      summary += `**總訂單數:** ${orders.length}\n\n`;
      
      summary += `## 餐品統計\n`;
      Object.entries(analysis.foodCount).sort((a, b) => b[1] - a[1]).forEach(([food, count]) => {
        summary += `### ${food}: ${count}份\n`;
        if (analysis.foodReqMap[food] && Object.keys(analysis.foodReqMap[food]).length > 0) {
          summary += `#### 要求統計\n`;
          Object.entries(analysis.foodReqMap[food]).sort((a, b) => b[1] - a[1]).forEach(([req, reqCount]) => {
            if (reqCount > 1) {
              summary += `- ${req}: ${reqCount}次\n`;
            } else {
              summary += `- ${req}\n`;
            }
          });
        }
        if (analysis.userFoodReqs[food] && Object.keys(analysis.userFoodReqs[food]).length > 0) {
          summary += `#### 個人要求\n`;
          Object.entries(analysis.userFoodReqs[food]).forEach(([userName, reqs]) => {
            summary += `- **${userName}**: ${reqs.join('、')}\n`;
          });
        }
        summary += '\n';
      });
      
      if (Object.keys(analysis.drinkCount).length > 0) {
        summary += `## 飲料統計\n`;
        Object.entries(analysis.drinkCount).sort((a, b) => b[1] - a[1]).forEach(([drink, count]) => {
          summary += `### ${drink}: ${count}份\n`;
          if (analysis.drinkReqMap[drink] && Object.keys(analysis.drinkReqMap[drink]).length > 0) {
            summary += `#### 要求統計\n`;
            Object.entries(analysis.drinkReqMap[drink]).sort((a, b) => b[1] - a[1]).forEach(([req, reqCount]) => {
              if (reqCount > 1) {
                summary += `- ${req}: ${reqCount}次\n`;
              } else {
                summary += `- ${req}\n`;
              }
            });
          }
          if (analysis.userDrinkReqs[drink] && Object.keys(analysis.userDrinkReqs[drink]).length > 0) {
            summary += `#### 個人要求\n`;
            Object.entries(analysis.userDrinkReqs[drink]).forEach(([userName, reqs]) => {
              summary += `- **${userName}**: ${reqs.join('、')}\n`;
            });
          }
          summary += '\n';
        });
      }
      
      const timeStr = new Date().toLocaleTimeString('zh-HK', {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
      summary += `---\n匯總時間: ${timeStr}\n`;
      
      return summary;
    }
    
    function saveSummaryToStorage() {
      summaryStore = {
        date: new Date().toISOString(),
        content: document.getElementById('summaryContent').innerHTML,
        orders: getOrders()
      };
    }
    
    function showStatusMessage(message, type='success') {
      const statusMessage = document.getElementById('statusMessage');
      const statusMessageText = document.getElementById('statusMessageText');
      const statusIcon = document.getElementById('statusIcon');
      
      statusMessageText.textContent = message;
      
      if (type === 'error') {
        statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#EF4444" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>';
        statusMessageText.className = 'text-red-700 dark:text-red-400';
      } else if (type === 'success') {
        statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#10B981" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.06l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>';
        statusMessageText.className = 'text-green-700 dark:text-green-400';
      } else if (type === 'info') {
        statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#3B82F6" class="w-5 h-5"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75.75 0 009.253 9H9z" clip-rule="evenodd" /></svg>';
        statusMessageText.className = 'text-blue-700 dark:text-blue-400';
      } else if (type === 'warning') {
        statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#F59E0B" class="w-5 h-5"><path fill-rule="evenodd" d="M8.257 3.099c.366-.68 1.367-.68 1.732 0l6. 999 13. 002A1 1 0 0116. 999 18H3a1 1 0 01-.866-1.5L8.257 3.1zM9 4.414L4 13h10L9 4.414z" clip-rule="evenodd" /></svg>';
        statusMessageText.className = 'text-yellow-700 dark:text-yellow-400';
      } else {
        statusIcon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="#6B7280" class="w-5 h-5"><path fill-rule="evenodd" d="M18 10A8 8 0 114 10a8 8 0 0114 0zm-7-4a1 1 0 10-2 0 1 1 0 002 0zm0 2a.75.75 0 00-.75.75v3.5a.75.75 0 001.5 0v-3.5A.75.75 0 0010 8z" clip-rule="evenodd" /></svg>';
        statusMessageText.className = 'text-gray-800 dark:text-gray-100';
      }
      
      statusMessage.classList.remove('hidden');
      setTimeout(() => {
        statusMessage.classList.add('hidden');
      }, 3000);
    }
    
    function showCloudSyncIndicator(message = '正在同步到雲端...') {
      document.getElementById('cloudSyncText').textContent = message;
      document.getElementById('cloudSyncIndicator').classList.remove('hidden');
    }
    
    function hideCloudSyncIndicator() {
      document.getElementById('cloudSyncIndicator').classList.add('hidden');
    }
    
    async function syncToCloudflare(silent = false) {
      if (autoSyncInProgress) return;
      autoSyncInProgress = true;
      
      const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc";
      try {
        if (silent) {
          showCloudSyncIndicator();
        } else {
          document.getElementById('syncToCloudflareText').classList.add('hidden');
          document.getElementById('syncToCloudflareSpinner').classList.remove('hidden');
          document.getElementById('syncToCloudflareBtn').disabled = true;
        }
        
        const orders = getOrders();
        const response = await fetch(`${apiEndpoint}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orders)
        });
        if (!response.ok) {
          throw new Error(`API 請求失敗: ${response.status}`);
        }
        
        const summary = {
          date: new Date().toISOString(),
          content: document.getElementById('summaryContent').innerHTML,
          orders: orders
        };
        const summaryResponse = await fetch(`${apiEndpoint}/api/summary`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(summary)
        });
        if (!summaryResponse.ok) {
          throw new Error(`摘要 API 請求失敗: ${summaryResponse.status}`);
        }
        
        // 同步歷史記錄
        if (orderHistoryStore && orderHistoryStore.length > 0) {
          const historyResponse = await fetch(`${apiEndpoint}/api/history/bulk`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderHistoryStore)
          });
          
          if (!historyResponse.ok) {
            console.warn('歷史記錄同步失敗:', historyResponse.status);
          } else {
            console.log('歷史記錄同步成功');
          }
        }
        
        saveToLocalStorage();
        if (!silent) {
          showStatusMessage('成功推送到雲端!', 'success');
        }
      } catch (error) {
        console.error('Cloudflare 同步錯誤:', error);
        saveToLocalStorage();
        if (!silent) {
          showStatusMessage(`無法同步到雲端: ${error.message}`, 'error');
        }
      } finally {
        autoSyncInProgress = false;
        if (silent) {
          hideCloudSyncIndicator();
        } else {
          document.getElementById('syncToCloudflareText').classList.remove('hidden');
          document.getElementById('syncToCloudflareSpinner').classList.add('hidden');
          document.getElementById('syncToCloudflareBtn').disabled = false;
        }
      }
    }
    
    async function syncFromCloudflare(isViewMode = false, silent = false) {
      const apiEndpoint = isViewMode ? (document.getElementById('apiEndpointView').value.trim() || "https://api.cpuloyalty.cc") : (document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc");
      
      try {
        if (!silent) {
          const textElement = isViewMode ? document.getElementById('syncFromCloudflareTextView') : document.getElementById('syncFromCloudflareText');
          const spinnerElement = isViewMode ? document.getElementById('syncFromCloudflareSpinnerView') : document.getElementById('syncFromCloudflareSpinner');
          const buttonElement = isViewMode ? document.getElementById('syncFromCloudflareViewBtn') : document.getElementById('syncFromCloudflareBtn');
          if (textElement) textElement.classList.add('hidden');
          if (spinnerElement) spinnerElement.classList.remove('hidden');
          if (buttonElement) buttonElement.disabled = true;
        }
        
        const response = await fetch(`${apiEndpoint}/api/orders`);
        if (!response.ok) {
          throw new Error(`API 請求失敗: ${response.status}`);
        }
        const orders = await response.json();
        if (!Array.isArray(orders)) {
          throw new Error('服務器返回的數據格式不正確');
        }
        
        orderStore = orders;
        saveToLocalStorage();
        updateSummary();
        
        // 也從云端同步歷史記錄
        await loadHistoryFromCloud();
        
        if (!silent) {
          showStatusMessage('成功從雲端同步!', 'success');
        }
      } catch (error) {
        console.error('Cloudflare 同步錯誤:', error);
        if (silent && !tryLoadFromLocalStorage()) {
          orderStore = [];
          updateSummary();
        }
        if (!silent) {
          showStatusMessage(`無法從雲端同步: ${error.message}`, 'error');
        }
        throw error;
      } finally {
        if (!silent) {
          const textElement = isViewMode ? document.getElementById('syncFromCloudflareTextView') : document.getElementById('syncFromCloudflareText');
          const spinnerElement = isViewMode ? document.getElementById('syncFromCloudflareSpinnerView') : document.getElementById('syncFromCloudflareSpinner');
          const buttonElement = isViewMode ? document.getElementById('syncFromCloudflareViewBtn') : document.getElementById('syncFromCloudflareBtn');
          if (textElement) textElement.classList.remove('hidden');
          if (spinnerElement) spinnerElement.classList.add('hidden');
          if (buttonElement) buttonElement.disabled = false;
        }
      }
    }
    
    async function syncToCloudflareView(silent = false) {
      const apiEndpoint = document.getElementById('apiEndpointView').value.trim() || "https://api.cpuloyalty.cc";
      try {
        if (silent) {
          showCloudSyncIndicator("普通管理員正在同步到雲端...");
        } else {
          document.getElementById('syncToCloudflareTextView').classList.add('hidden');
          document.getElementById('syncToCloudflareSpinnerView').classList.remove('hidden');
          if (document.getElementById('syncToCloudflareViewBtn')) {
            document.getElementById('syncToCloudflareViewBtn').disabled = true;
          }
        }
        
        const orders = getOrders();
        const response = await fetch(`${apiEndpoint}/api/orders`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(orders)
        });
        if (!response.ok) {
          throw new Error(`API 請求失敗: ${response.status}`);
        }
        
        const summary = {
          date: new Date().toISOString(),
          content: document.getElementById('summaryContent').innerHTML,
          orders: orders
        };
        const summaryResponse = await fetch(`${apiEndpoint}/api/summary`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(summary)
        });
        if (!summaryResponse.ok) {
          throw new Error(`摘要 API 請求失敗: ${summaryResponse.status}`);
        }
        
        // 同步歷史記錄
        if (orderHistoryStore && orderHistoryStore.length > 0) {
          const historyResponse = await fetch(`${apiEndpoint}/api/history/bulk`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderHistoryStore)
          });
          
          if (!historyResponse.ok) {
            console.warn('歷史記錄同步失敗:', historyResponse.status);
          } else {
            console.log('歷史記錄同步成功');
          }
        }
        
        if (!silent) {
          showStatusMessage('成功推送到雲端!', 'success');
        }
      } catch (error) {
        console.error('Cloudflare 同步錯誤:', error);
        if (!silent) {
          showStatusMessage(`無法同步到雲端: ${error.message}`, 'error');
        }
        throw error;
      } finally {
        if (silent) {
          hideCloudSyncIndicator();
        } else {
          if (document.getElementById('syncToCloudflareTextView')) {
            document.getElementById('syncToCloudflareTextView').classList.remove('hidden');
          }
          if (document.getElementById('syncToCloudflareSpinnerView')) {
            document.getElementById('syncToCloudflareSpinnerView').classList.add('hidden');
          }
          if (document.getElementById('syncToCloudflareViewBtn')) {
            document.getElementById('syncToCloudflareViewBtn').disabled = false;
          }
        }
      }
    }
    
    async function checkNetworkStatus() {
      showStatusMessage('正在檢查網絡狀態...', 'info');
      const btn = document.getElementById('checkNetworkStateBtn');
      btn.innerHTML = '<i class="ri-loader-2-line spin mr-1.5"></i>診斷中...';
      btn.disabled = true;
      
      try {
        const pingEndpoints = [
          'https://www.cloudflare.com/cdn-cgi/trace',
          'https://httpbin.org/get',
          'https://api.ipify.org?format=json'
        ];
        let success = false;
        let pingTime = 0;
        let endpoint = '';
        
        for (const testEndpoint of pingEndpoints) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const startTime = Date.now();
            await fetch(testEndpoint, { method: 'GET', signal: controller.signal, mode: 'no-cors' });
            clearTimeout(timeoutId);
            const endTime = Date.now();
            pingTime = endTime - startTime;
            success = true;
            endpoint = testEndpoint.split('/')[2];
            break;
          } catch (e) {
            console.log(`端點 ${testEndpoint} 測試失敗:`, e.message);
          }
        }
        
        if (!success) {
          try {
            const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc";
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 5000);
            const startTime = Date.now();
            await fetch(`${apiEndpoint}/api/ping`, { method: 'GET', signal: controller.signal, mode: 'no-cors' });
            clearTimeout(timeoutId);
            const endTime = Date.now();
            pingTime = endTime - startTime;
            success = true;
            endpoint = apiEndpoint.split('/')[2];
          } catch (e) {
            console.log(`API端點測試失敗:`, e.message);
          }
        }
        
        if (success) {
          showStatusMessage(`網絡連接正常，延遲: ${pingTime}ms (${endpoint})`, 'success');
        } else {
          showStatusMessage('網絡連接可能存在問題，請檢查設定', 'warning');
        }
      } catch (error) {
        console.error('網絡診斷錯誤:', error);
        showStatusMessage(`網絡診斷出錯: ${error.name === 'AbortError' ? '請求超時' : error.message}`, 'error');
      } finally {
        btn.innerHTML = '<i class="ri-radar-line mr-1.5"></i>網絡診斷';
        btn.disabled = false;
      }
    }
    
    async function refreshCloudState() {
      const btn = document.getElementById('refreshCloudStateBtn');
      btn.innerHTML = '<i class="ri-loader-2-line spin mr-1.5"></i>刷新中...';
      btn.disabled = true;
      
      try {
        await syncFromCloudflare(false, false);
        showStatusMessage('雲端狀態已更新', 'success');
      } catch (error) {
        console.error('刷新雲端狀態錯誤:', error);
        showStatusMessage(`刷新失敗: ${error.message}`, 'error');
      } finally {
        btn.innerHTML = '<i class="ri-refresh-line mr-1.5"></i>刷新狀態';
        btn.disabled = false;
      }
    }
    
    async function syncOrdersFromCloud() {
      document.getElementById('initialLoadingIndicator').classList.remove('hidden');
      
      try {
        await syncFromCloudflare(false, true);
        console.log("成功從雲端同步訂單");
      } catch (error) {
        console.error("從雲端同步失敗:", error);
        showStatusMessage("從雲端載入數據失敗，使用本地數據", "warning");
        
        if (!tryLoadFromLocalStorage()) {
          orderStore = [];
          updateSummary();
        }
      } finally {
        document.getElementById('initialLoadingIndicator').classList.add('hidden');
        
        tryAutoLogin();
      }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      init();
    });
  
  // 5E学生专用点餐系统逻辑 ==============================================
  
  // 存储5E订单的数组
  let fiveEOrderStore = [];
  
  // 初始化5E餐品数据
  function initializeFiveEFoodOptions() {
    const categoryButtons = document.querySelectorAll('.fiveE-category-btn');
    categoryButtons.forEach(button => {
      button.addEventListener('click', () => {
        // 重置所有按钮样式
        categoryButtons.forEach(btn => {
          btn.classList.remove('bg-indigo-600', 'text-white');
          btn.classList.add('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
        });
        
        // 设置选中按钮样式
        button.classList.remove('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
        button.classList.add('bg-indigo-600', 'text-white');
        
        // 更新食品选项
        updateFiveEFoodOptions(button.dataset.category);
      });
    });
    
    // 显示/隐藏学生ID字段
    const userTypeRadios = document.querySelectorAll('input[name="fiveEUserType"]');
    userTypeRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        const studentIdField = document.getElementById('fiveEStudentIdField');
        if (radio.value === 'student') {
          studentIdField.classList.remove('hidden');
        } else {
          studentIdField.classList.add('hidden');
        }
      });
    });
    
    // 处理饮料要求部分显示/隐藏
    const drinkSelect = document.getElementById('fiveEDrinkSelect');
    const drinkReqSection = document.getElementById('fiveEDrinkReqSection');
    
    drinkSelect.addEventListener('change', () => {
      if (drinkSelect.value) {
        drinkReqSection.classList.remove('hidden');
      } else {
        drinkReqSection.classList.add('hidden');
        document.querySelectorAll('input[name="fiveEDrinkReq"]').forEach(checkbox => {
          checkbox.checked = false;
        });
      }
    });
    
    // 提交订单按钮
    document.getElementById('fiveESubmitOrderBtn').addEventListener('click', handleFiveEOrderSubmit);
  }
  
  // 更新5E食品选项
  function updateFiveEFoodOptions(category) {
    const foodSelect = document.getElementById('fiveEFoodSelect');
    foodSelect.innerHTML = '';
    
    if (!category || !menuData[category]) {
      const defaultOption = document.createElement('option');
      defaultOption.textContent = '請先選擇分類';
      defaultOption.value = '';
      defaultOption.disabled = true;
      defaultOption.selected = true;
      foodSelect.appendChild(defaultOption);
      return;
    }
    
    menuData[category].forEach(item => {
      const option = document.createElement('option');
      option.textContent = `${item.name} (${item.price}元)`;
      option.value = item.name;
      foodSelect.appendChild(option);
    });
    
    const defaultOption = document.createElement('option');
    defaultOption.textContent = '選擇餐品';
    defaultOption.value = '';
    defaultOption.selected = true;
    defaultOption.disabled = true;
    foodSelect.insertBefore(defaultOption, foodSelect.firstChild);
  }
  
  // 打开5E订单模态窗口
  function openFiveEOrderSystem() {
    document.getElementById('fiveEOrderSystem').classList.remove('hidden');
    loadFiveEOrders(); // 加载已有订单
    updateFiveEOrderSummary(); // 更新订单统计
  }
  
  // 关闭5E订单模态窗口
  function closeFiveEOrderSystem() {
    document.getElementById('fiveEOrderSystem').classList.add('hidden');
  }
  
  // 处理5E订单提交 - 使用共享云端存储
  function handleFiveEOrderSubmit() {
    const userType = document.querySelector('input[name="fiveEUserType"]:checked').value;
    let name = document.getElementById('fiveEName').value.trim();
    const studentId = userType === 'student' ? document.getElementById('fiveEStudentId').value.trim() : '';
    const food = document.getElementById('fiveEFoodSelect').value;
    const foodReqs = Array.from(document.querySelectorAll('input[name="fiveEFoodReq"]:checked')).map(el => el.value);
    const drink = document.getElementById('fiveEDrinkSelect').value;
    const drinkReqs = Array.from(document.querySelectorAll('input[name="fiveEDrinkReq"]:checked')).map(el => el.value);
    
    // 验证输入
    if (!name) {
      showStatusMessage('請輸入您的姓名', 'error');
      return;
    }
    
    if (userType === 'student' && !studentId) {
      showStatusMessage('請輸入您的學號', 'error');
      return;
    }
    
    if (!food) {
      showStatusMessage('請選擇餐品', 'error');
      return;
    }
    
    // 保存原始名字用于显示在欢迎弹窗中
    const displayName = name;
    
    // 名字前加上"5E"前缀（如果尚未添加）
    if (!name.startsWith('5E')) {
      name = '5E' + name;
    }
    
    // 创建订单对象 - 使用主系统的订单格式
    const order = {
      id: Date.now().toString(),
      timestamp: new Date().toISOString(),
      name: name, // 添加了5E前缀的名字
      food,
      foodReqs,
      drink,
      drinkReqs,
      // 在主系统的额外字段中保存5E特有信息
      meta: {
        userType,
        studentId,
        source: '5E'
      }
    };
    
    // 直接添加到主系统的订单存储
    saveOrder(order);
    
    // 更新订单列表和统计
    loadFiveEOrders();
    updateFiveEOrderSummary();
    
    // 调用主系统的同步功能而不是5E特有的同步功能
    syncToCloudflare(true);
    
    // 重置表单
    resetFiveEOrderForm();
    
    // 显示成功消息
    showStatusMessage('訂單提交成功！', 'success');
    
    // 显示欢迎弹窗
    show5EWelcomeDialog(displayName);
  }
  
  // 5E专用欢迎弹窗函数
  function show5EWelcomeDialog(name) {
    const welcomeTitle = document.getElementById('welcomeTitle');
    const welcomeMessage = document.getElementById('welcomeMessage');
    const welcomeOk = document.getElementById('welcomeOk');
    const welcomeDialog = document.getElementById('welcomeDialog');
    const welcomeName = document.getElementById('welcomeName');
    
    // 设置弹窗内容
    welcomeTitle.textContent = `訂單已提交成功！`;
    welcomeName.textContent = name;
    welcomeMessage.innerHTML = `好嘢！<span id="welcomeName">${name}</span>好嘢！<span class="thumbs-up text-xl">👏🏻</span>`;
    
    // 显示弹窗
    welcomeDialog.classList.remove('hidden');
    
    // 注册确认按钮事件
    welcomeOk.onclick = () => {
      welcomeDialog.classList.add('hidden');
    };
  }
  
  // 重置5E订单表单
  function resetFiveEOrderForm() {
    document.getElementById('fiveEName').value = '';
    document.getElementById('fiveEStudentId').value = '';
    document.getElementById('fiveEFoodSelect').innerHTML = '<option value="" disabled selected>請先選擇分類</option>';
    document.getElementById('fiveEDrinkSelect').value = '';
    document.getElementById('fiveEDrinkReqSection').classList.add('hidden');
    
    // 重置分类按钮样式
    document.querySelectorAll('.fiveE-category-btn').forEach(btn => {
      btn.classList.remove('bg-indigo-600', 'text-white');
      btn.classList.add('bg-white', 'dark:bg-dark-400', 'text-gray-700', 'dark:text-gray-300');
    });
    
    // 重置复选框
    document.querySelectorAll('input[name="fiveEFoodReq"]').forEach(checkbox => {
      checkbox.checked = false;
    });
    
    document.querySelectorAll('input[name="fiveEDrinkReq"]').forEach(checkbox => {
      checkbox.checked = false;
    });
  }
  
  // 保存5E订单
  function saveFiveEOrder(order) {
    fiveEOrderStore.push(order);
    saveFiveEOrdersToLocalStorage();
    
    // 同步到云端
    syncFiveEOrdersToCloud(true);
  }
  
  // 保存5E订单到本地存储
  function saveFiveEOrdersToLocalStorage() {
    try {
      localStorage.setItem('fiveEOrders', JSON.stringify(fiveEOrderStore));
      console.log(`[5E訂單] 已保存 ${fiveEOrderStore.length} 條訂單`);
    } catch (error) {
      console.warn('[5E訂單] 保存失敗:', error);
    }
  }
  
  // 将5E订单同步到云端 - 增强版
  async function syncFiveEOrdersToCloud(silent = false) {
    // 创建一个ID用于跟踪这次同步操作
    const syncId = Date.now().toString();
    console.log(`[5E訂單] [${syncId}] 開始同步到雲端`);
    
    try {
      if (!silent) {
        showCloudSyncIndicator('正在同步5E訂單到雲端...');
      }
      
      // 检查网络连接
      if (!navigator.onLine) {
        throw new Error('無網絡連接，請檢查您的網絡設置');
      }
      
      const apiEndpoint = document.getElementById('apiEndpoint').value.trim() || "https://api.cpuloyalty.cc";
      console.log(`[5E訂單] [${syncId}] 使用API端點: ${apiEndpoint}/api/fiveEOrders`);
      
      // 增加超时处理
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时
      
      try {
        console.log(`[5E訂單] [${syncId}] 正在发送数据，共 ${fiveEOrderStore.length} 条记录`);
        const response = await fetch(`${apiEndpoint}/api/fiveEOrders`, {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'X-Sync-ID': syncId // 添加自定义header便于服务器端跟踪
          },
          body: JSON.stringify(fiveEOrderStore),
          signal: controller.signal,
          // 增加重要的fetch选项
          mode: 'cors',
          credentials: 'same-origin',
          cache: 'no-cache'
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          // 尝试获取详细错误信息
          let errorDetails = '';
          try {
            const errorJson = await response.json();
            errorDetails = errorJson.message || errorJson.error || '';
          } catch (e) {
            // 如果无法解析JSON错误，使用状态文本
            errorDetails = response.statusText;
          }
          
          throw new Error(`API請求失敗 (${response.status}): ${errorDetails}`);
        }
        
        // 尝试获取响应内容
        const responseData = await response.json().catch(() => ({}));
        const successCount = responseData.count || fiveEOrderStore.length;
        
        console.log(`[5E訂單] [${syncId}] 成功同步到雲端 (${successCount} 條記錄)`);
        
        if (!silent) {
          showStatusMessage(`5E訂單已同步到雲端 (${successCount} 條記錄)`, 'success');
        }
        
        return true;
      } catch (fetchError) {
        clearTimeout(timeoutId);
        
        if (fetchError.name === 'AbortError') {
          throw new Error('同步請求超時，請檢查網絡連接或API端點');
        }
        
        throw fetchError;
      }
    } catch (error) {
      console.error(`[5E訂單] [${syncId}] 同步失敗:`, error);
      
      // 保存到本地作为备份
      saveFiveEOrdersToLocalStorage();
      
      // 区分不同类型的错误提供更具体的反馈
      let errorMessage = error.message;
      if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
        errorMessage = '網絡錯誤，無法連接到服務器';
      } else if (error.message.includes('JSON')) {
        errorMessage = '服務器返回的數據格式無效';
      }
      
      if (!silent) {
        showStatusMessage(`5E訂單同步失敗: ${errorMessage}。已自動保存到本地。`, 'error');
      }
      
      // 抛出错误以便调用方可以处理
      throw error;
    } finally {
      if (!silent) {
        hideCloudSyncIndicator();
      }
      console.log(`[5E訂單] [${syncId}] 同步操作完成`);
    }
  }
  
  // 从云端获取5E订单 - 增强版
  async function syncFiveEOrdersFromCloud(silent = false) {
    // 创建一个ID用于跟踪这次同步操作
    const syncId = Date.now().toString();
    console.log(`[5E訂單] [${syncId}] 開始從雲端同步`);
    
    try {
      if (!silent) {
        showCloudSyncIndicator('正在從雲端同步5E訂單...');
      }
      
      // 检查网络连接
      if (!navigator.onLine) {
        throw new Error('無網絡連接，請檢查您的網絡設置');
      }
      
      // 获取API端点 - 尝试从多个地方获取
      let apiEndpoint = document.getElementById('apiEndpoint')?.value.trim() || "";
      if (!apiEndpoint) {
        apiEndpoint = document.getElementById('apiEndpointView')?.value.trim() || "";
      }
      if (!apiEndpoint) {
        apiEndpoint = "https://api.cpuloyalty.cc"; // 回退到默认值
      }
      
      console.log(`[5E訂單] [${syncId}] 使用API端點: ${apiEndpoint}/api/fiveEOrders`);
      
      // 增加超时处理
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000); // 15秒超时
      
      try {
        const response = await fetch(`${apiEndpoint}/api/fiveEOrders`, {
          method: 'GET',
          headers: { 
            'Accept': 'application/json',
            'X-Sync-ID': syncId // 添加自定义header便于服务器端跟踪
          },
          signal: controller.signal,
          // 增加重要的fetch选项
          mode: 'cors',
          credentials: 'same-origin',
          cache: 'no-cache'
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          // 尝试获取详细错误信息
          let errorDetails = '';
          try {
            const errorJson = await response.json();
            errorDetails = errorJson.message || errorJson.error || '';
          } catch (e) {
            // 如果无法解析JSON错误，使用状态文本
            errorDetails = response.statusText;
          }
          
          throw new Error(`API請求失敗 (${response.status}): ${errorDetails}`);
        }
        
        // 检查Content-Type以确保我们收到的是JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
          throw new Error(`非預期的響應類型: ${contentType}`);
        }
        
        const data = await response.json();
        console.log(`[5E訂單] [${syncId}] 收到云端數據`, data ? `(${JSON.stringify(data).substring(0, 100)}...)` : '(空)');
        
        if (!data) {
          throw new Error('雲端返回空數據');
        }
        
        if (Array.isArray(data)) {
          console.log(`[5E訂單] [${syncId}] 從雲端獲取到 ${data.length} 條訂單`);
          fiveEOrderStore = data;
          saveFiveEOrdersToLocalStorage();
          
          // 更新UI
          loadFiveEOrders();
          updateFiveEOrderSummary();
          
          if (!silent) {
            showStatusMessage(`成功從雲端同步 ${data.length} 條5E訂單`, 'success');
          }
          
          // 返回成功
          return true;
        } else {
          throw new Error('返回的數據不是數組格式');
        }
      } catch (fetchError) {
        clearTimeout(timeoutId);
        
        if (fetchError.name === 'AbortError') {
          throw new Error('同步請求超時，請檢查網絡連接或API端點');
        }
        
        throw fetchError;
      }
    } catch (error) {
      console.error(`[5E訂單] [${syncId}] 從雲端同步失敗:`, error);
      
      // 如果从云端同步失败，尝试从本地加载
      loadFiveEOrdersFromLocalStorage();
      
      // 区分不同类型的错误提供更具体的反馈
      let errorMessage = error.message;
      if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
        errorMessage = '網絡錯誤，無法連接到服務器';
      } else if (error.message.includes('JSON')) {
        errorMessage = '服務器返回的數據格式無效';
      }
      
      if (!silent) {
        showStatusMessage(`從雲端同步5E訂單失敗: ${errorMessage}。已加載本地數據。`, 'warning');
      }
      
      return false;
    } finally {
      if (!silent) {
        hideCloudSyncIndicator();
      }
      console.log(`[5E訂單] [${syncId}] 同步操作完成`);
    }
  }
  
  // 从本地存储加载5E订单
  function loadFiveEOrdersFromLocalStorage() {
    try {
      const storedOrders = localStorage.getItem('fiveEOrders');
      if (storedOrders) {
        fiveEOrderStore = JSON.parse(storedOrders);
        console.log(`[5E訂單] 從本地加載了 ${fiveEOrderStore.length} 條訂單`);
      }
    } catch (error) {
      console.warn('[5E訂單] 載入失敗:', error);
      fiveEOrderStore = [];
    }
  }
  
  // 加载5E订单到界面
  function loadFiveEOrders() {
    const orderList = document.getElementById('fiveEOrderList');
    
    // 从主系统的orderStore获取以"5E"开头的订单
    const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    if (fiveEOrders.length === 0) {
      orderList.innerHTML = `
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="ri-inbox-line text-4xl mb-2 block"></i>
          <p>暫無訂單</p>
          <p class="text-sm mt-1">訂單提交後將顯示在這裡</p>
        </div>
      `;
      return;
    }
    
    // 按日期分组订单
    const ordersByDate = {};
    fiveEOrders.forEach(order => {
      const date = new Date(order.timestamp);
      const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
      
      if (!ordersByDate[dateStr]) {
        ordersByDate[dateStr] = [];
      }
      
      ordersByDate[dateStr].push(order);
    });
    
    // 获取所有日期并按降序排序（最新的日期在前）
    const dates = Object.keys(ordersByDate).sort((a, b) => new Date(b) - new Date(a));
    
    let html = '';
    
    // 遍历每个日期组
    dates.forEach(dateStr => {
      const ordersForDate = ordersByDate[dateStr];
      const date = new Date(dateStr);
      
      // 生成日期标题（星期几和日期）
      const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
      const weekday = weekdays[date.getDay()];
      const formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 (星期${weekday})`;
      
      // 添加日期分隔符
      html += `
        <div class="date-divider mb-4">
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center">
              <i class="ri-calendar-2-line text-indigo-600 dark:text-indigo-400 mr-2"></i>
              <h5 class="text-sm font-medium text-gray-800 dark:text-white">${formattedDate}</h5>
            </div>
            <span class="text-xs bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 px-2 py-0.5 rounded-full">
              ${ordersForDate.length} 個訂單
            </span>
          </div>
        </div>
      `;
      
      // 按照时间倒序排列当天的订单
      const sortedOrders = [...ordersForDate].sort((a, b) => 
        new Date(b.timestamp) - new Date(a.timestamp)
      );
      
      // 生成每个订单的HTML
      sortedOrders.forEach(order => {
        // 从meta字段中获取5E特有信息，如果存在的话
        const userType = order.meta?.userType || 'student';
        const studentId = order.meta?.studentId || '';
        
        html += `
          <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-sm mb-3 fade-in border border-gray-100 dark:border-gray-600" data-order-id="${order.id}">
            <div class="flex justify-between items-start mb-2">
              <div class="flex items-center">
                <div class="w-8 h-8 bg-indigo-100 dark:bg-indigo-900/30 rounded-full flex items-center justify-center text-indigo-600 dark:text-indigo-400 font-medium mr-3 flex-shrink-0">
                  ${userType === 'teacher' ? 'T' : 'S'}
                </div>
                <div>
                  <p class="font-medium text-gray-800 dark:text-white">${order.name.replace('5E', '')}</p>
                  ${studentId ? `<p class="text-xs text-gray-500 dark:text-gray-400">學號: ${studentId}</p>` : ''}
                </div>
              </div>
              <button class="delete-fiveE-order-btn text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-1">
                <i class="ri-delete-bin-line"></i>
              </button>
            </div>
            
            <div class="ml-11">
              <p class="text-sm text-gray-700 dark:text-gray-300 flex items-center">
                <i class="ri-restaurant-2-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                <span class="font-medium">餐品:</span> 
                <span class="ml-1">${order.food}</span>
              </p>
              ${order.foodReqs.length > 0 ? 
                `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1 flex items-center">
                  <i class="ri-settings-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                  <span class="font-medium">要求:</span>
                  <span class="ml-1">${order.foodReqs.join(', ')}</span>
                </p>` : ''}
              ${order.drink ? 
                `<p class="text-sm text-gray-700 dark:text-gray-300 mt-1 flex items-center">
                  <i class="ri-cup-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                  <span class="font-medium">飲料:</span>
                  <span class="ml-1">${order.drink}</span>
                </p>` : ''}
              ${order.drinkReqs.length > 0 ? 
                `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1 flex items-center">
                  <i class="ri-settings-line text-gray-500 dark:text-gray-400 mr-1.5"></i>
                  <span class="font-medium">飲料要求:</span>
                  <span class="ml-1">${order.drinkReqs.join(', ')}</span>
                </p>` : ''}
              <p class="text-xs text-gray-500 dark:text-gray-500 mt-2 flex items-center">
                <i class="ri-time-line mr-1.5"></i>
                ${new Date(order.timestamp).toLocaleTimeString('zh-HK', {
                  hour: '2-digit',
                  minute: '2-digit'
                })}
              </p>
            </div>
          </div>
        `;
      });
    });
    
    orderList.innerHTML = html;
    
    // 添加删除订单按钮事件
    document.querySelectorAll('.delete-fiveE-order-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const orderId = this.closest('[data-order-id]').dataset.orderId;
        deleteFiveEOrder(orderId);
      });
    });
  }
  
  // 删除5E订单
  function deleteFiveEOrder(orderId) {
    showConfirmDialog(
      "删除5E订单",
      "确定要删除此订单吗？此操作不可撤销。",
      (confirmed) => {
        if (confirmed) {
          // 从主订单存储中删除
          let orders = getOrders();
          const index = orders.findIndex(order => order.id === orderId);
          if (index !== -1) {
            orders.splice(index, 1);
            orderStore = orders;
            
            // 更新UI和存储
            saveToLocalStorage();
            loadFiveEOrders();
            updateFiveEOrderSummary();
            syncToCloudflare(true);
            showStatusMessage('訂單已刪除', 'success');
          }
        }
      }
    );
  }
  
  // 清空所有5E订单
  function clearAllFiveEOrders() {
    showConfirmDialog(
      "清空所有5E订单",
      "确定要清空所有5E订单吗？此操作不可撤销。",
      (confirmed) => {
        if (confirmed) {
          fiveEOrderStore = [];
          saveFiveEOrdersToLocalStorage();
          loadFiveEOrders();
          updateFiveEOrderSummary();
          showStatusMessage('所有5E訂單已清空', 'success');
        }
      }
    );
  }
  
  // 导出5E订单
  function exportFiveEOrders() {
    // 从主系统的orderStore获取以"5E"开头的订单
    const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    if (fiveEOrders.length === 0) {
      showStatusMessage('沒有訂單可以導出', 'error');
      return;
    }
    
    let exportText = generateFiveEOrderSummary(fiveEOrders);
    
    navigator.clipboard.writeText(exportText).then(() => {
      showExportSuccessDialog();
    }).catch(err => {
      showStatusMessage('無法複製到剪貼板: ' + err, 'error');
      console.error('Failed to copy:', err);
    });
  }
  
  // 生成5E订单汇总文本
    function generateFiveEOrderSummary(fiveEOrders) {
    const weekdays = ["日", "一", "二", "三", "四", "五", "六"];
    const currentDate = new Date();
    const weekday = weekdays[currentDate.getDay()];
    const formattedDate = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
    
    const separator = "============================================";
    const subSeparator = "--------------------------------------------";
    
    let summary = `🏫 5E班級專用訂單匯總 🏫\n`;
    summary += `📅 ${formattedDate} (星期${weekday})   👥 總訂單數: ${fiveEOrders.length}\n`;
    summary += `${separator}\n\n`;
    
    // 分别统计老师和学生
    const teacherOrders = fiveEOrders.filter(order => order.meta?.userType === 'teacher');
    const studentOrders = fiveEOrders.filter(order => !order.meta?.userType || order.meta?.userType === 'student');
    
    summary += `👨‍🏫 老師訂單: ${teacherOrders.length}份\n`;
    summary += `👨‍🎓 學生訂單: ${studentOrders.length}份\n\n`;
    
    // 餐品统计
    const foodReqsByUser = {};
    const drinkReqsByUser = {};
    const foodCount = {};
    const drinkCount = {};
    
    fiveEOrders.forEach(order => {
      foodCount[order.food] = (foodCount[order.food] || 0) + 1;
      if (order.foodReqs.length > 0) {
        if (!foodReqsByUser[order.food]) {
          foodReqsByUser[order.food] = [];
        }
        foodReqsByUser[order.food].push(order.foodReqs);
      }
      if (order.drink) {
        drinkCount[order.drink] = (drinkCount[order.drink] || 0) + 1;
        if (order.drinkReqs.length > 0) {
          if (!drinkReqsByUser[order.drink]) {
            drinkReqsByUser[order.drink] = [];
          }
          drinkReqsByUser[order.drink].push(order.drinkReqs);
        }
      }
    });
    
    summary += `📋 餐品總數統計\n${subSeparator}\n`;
    Object.entries(foodCount).sort((a, b) => b[1] - a[1]).forEach(([food, count]) => {
      summary += `${food}: ${count}份\n`;
      if (foodReqsByUser[food] && foodReqsByUser[food].length > 0) {
        const reqCounts = {};
        foodReqsByUser[food].forEach(reqArray => {
          const reqString = reqArray.join('、');
          reqCounts[reqString] = (reqCounts[reqString] || 0) + 1;
        });
        Object.entries(reqCounts).forEach(([reqStr, reqCount]) => {
          if (reqCount > 1) {
            summary += `   ↳ ${reqStr} x${reqCount}\n`;
          } else {
            summary += `   ↳ ${reqStr}\n`;
          }
        });
      }
      summary += '\n';
    });
    
    if (Object.keys(drinkCount).length > 0) {
      summary += `🥤 飲料總數統計\n${subSeparator}\n`;
      Object.entries(drinkCount).sort((a, b) => b[1] - a[1]).forEach(([drink, count], index) => {
        summary += `${drink}: ${count}份\n`;
        if (drinkReqsByUser[drink] && drinkReqsByUser[drink].length > 0) {
          const reqCounts = {};
          drinkReqsByUser[drink].forEach(reqArray => {
            const reqString = reqArray.join(' ');
            reqCounts[reqString] = (reqCounts[reqString] || 0) + 1;
          });
          Object.entries(reqCounts).forEach(([reqStr, reqCount]) => {
            const formattedReq = reqStr.split(' ').join('');
            if (reqCount > 1) {
              summary += `   ↳ ${formattedReq} x${reqCount}\n`;
            } else {
              summary += `   ↳ ${formattedReq}\n`;
            }
          });
        }
        summary += '\n';
      });
    }
    
    // 添加详细订单信息，按老师和学生分组，同时包含价格
    summary += `📝 詳細訂單列表\n${subSeparator}\n\n`;
    
    if (teacherOrders.length > 0) {
      summary += `【老師訂單】\n`;
      teacherOrders.forEach((order, index) => {
        // 查找餐品价格
        let foodPrice = 0;
        for (const category in menuData) {
          const menuItem = menuData[category].find(item => item.name === order.food);
          if (menuItem) {
            foodPrice = menuItem.price;
            break;
          }
        }
        
        summary += `${index + 1}. ${order.name.replace('5E', '')}: ${order.food}${order.foodReqs.length > 0 ? ' (' + order.foodReqs.join('、') + ')' : ''} - $${foodPrice}\n`;
        if (order.drink) {
          summary += `   🥤 ${order.drink}${order.drinkReqs.length > 0 ? ' (' + order.drinkReqs.join('、') + ')' : ''}\n`;
        }
      });
      summary += '\n';
    }
    
    if (studentOrders.length > 0) {
      summary += `【學生訂單】\n`;
      studentOrders.forEach((order, index) => {
        // 查找餐品价格
        let foodPrice = 0;
        for (const category in menuData) {
          const menuItem = menuData[category].find(item => item.name === order.food);
          if (menuItem) {
            foodPrice = menuItem.price;
            break;
          }
        }
        
        const studentId = order.meta?.studentId || '';
        summary += `${index + 1}. ${order.name.replace('5E', '')}${studentId ? ' (' + studentId + ')' : ''}: ${order.food}${order.foodReqs.length > 0 ? ' (' + order.foodReqs.join('、') + ')' : ''} - $${foodPrice}\n`;
        if (order.drink) {
          summary += `   🥤 ${order.drink}${order.drinkReqs.length > 0 ? ' (' + order.drinkReqs.join('、') + ')' : ''}\n`;
        }
      });
    }
    
    const timeStr = new Date().toLocaleTimeString('zh-HK', {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    });
    summary += `\n${separator}\n`;
    summary += `導出時間: ${timeStr}\n`;
    
    return summary;
  }
  
  // 更新5E订单统计
  function updateFiveEOrderSummary() {
    const foodSummary = document.getElementById('fiveEFoodSummary');
    const drinkSummary = document.getElementById('fiveEDrinkSummary');
    const orderCount = document.getElementById('fiveEOrderCount');
    
    // 从主系统的orderStore获取以"5E"开头的订单
    const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    if (fiveEOrders.length === 0) {
      foodSummary.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">暫無數據</p>';
      drinkSummary.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-sm">暫無數據</p>';
      orderCount.textContent = '總訂單數: 0';
      return;
    }
    
    // 餐品统计
    const foodCount = {};
    fiveEOrders.forEach(order => {
      foodCount[order.food] = (foodCount[order.food] || 0) + 1;
    });
    
    let foodHtml = '';
    Object.entries(foodCount)
      .sort((a, b) => b[1] - a[1])
      .forEach(([food, count]) => {
        foodHtml += `
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-700 dark:text-gray-300">${food}</span>
            <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">${count}份</span>
          </div>
        `;
      });
    
    foodSummary.innerHTML = foodHtml || '<p class="text-gray-500 dark:text-gray-400 text-sm">暫無餐品數據</p>';
    
    // 饮料统计
    const drinkCount = {};
    fiveEOrders.forEach(order => {
      if (order.drink) {
        drinkCount[order.drink] = (drinkCount[order.drink] || 0) + 1;
      }
    });
    
    let drinkHtml = '';
    Object.entries(drinkCount)
      .sort((a, b) => b[1] - a[1])
      .forEach(([drink, count]) => {
        drinkHtml += `
          <div class="flex justify-between items-center">
            <span class="text-sm text-gray-700 dark:text-gray-300">${drink}</span>
            <span class="text-sm font-medium text-indigo-600 dark:text-indigo-400">${count}份</span>
          </div>
        `;
      });
    
    drinkSummary.innerHTML = drinkHtml || '<p class="text-gray-500 dark:text-gray-400 text-sm">暫無飲品數據</p>';
    
    // 订单总数
    orderCount.textContent = `總訂單數: ${fiveEOrders.length}`;
  }
  
  // 导出为真正的Excel格式
  function exportToExcel() {
    // 动态加载XLSX库
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = url;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // 从主系统的orderStore获取以"5E"开头的订单
    const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    if (fiveEOrders.length === 0) {
      showStatusMessage('沒有訂單可以導出', 'error');
      return;
    }
    
    showLoading('準備導出', '正在生成Excel文件...');

    // 加载SheetJS库
    loadScript('https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js')
      .then(() => {
        // 准备数据
        const data = [
          ['姓名', '学号', '身份', '餐品', '餐品要求', '飲品', '飲品要求', '价格', '時間']
        ];
        
        fiveEOrders.forEach(order => {
          const name = order.name.replace('5E', '');
          const studentId = order.meta?.studentId || '';
          const userType = order.meta?.userType === 'teacher' ? '老师' : '学生';
          const food = order.food;
          const foodReqs = order.foodReqs.join('、');
          const drink = order.drink || '';
          const drinkReqs = order.drinkReqs.join('、');
          
          // 查找餐品价格
          let foodPrice = 0;
          for (const category in menuData) {
            const menuItem = menuData[category].find(item => item.name === order.food);
            if (menuItem) {
              foodPrice = menuItem.price;
              break;
            }
          }
          
          const timestamp = new Date(order.timestamp).toLocaleString('zh-HK');
          
          data.push([name, studentId, userType, food, foodReqs, drink, drinkReqs, foodPrice, timestamp]);
        });
        
        // 创建工作簿
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(data);
        
        // 设置一些列宽
        const cols = [
          {wch: 10}, // 姓名
          {wch: 10}, // 学号
          {wch: 8},  // 身份
          {wch: 30}, // 餐品
          {wch: 20}, // 餐品要求
          {wch: 10}, // 飲品
          {wch: 15}, // 飲品要求
          {wch: 8},  // 价格
          {wch: 20}  // 時間
        ];
        ws['!cols'] = cols;
        
        // 添加到工作簿
        XLSX.utils.book_append_sheet(wb, ws, "5E訂單");
        
        // 生成Excel二进制数据
        const excelData = XLSX.write(wb, {
          bookType: 'xlsx',
          type: 'base64'
        });
        
        // 由于iframe限制，不能直接下载，所以我们转换为数据URL供用户手动保存
        const dateStr = new Date().toISOString().split('T')[0];
        const dataUrl = `data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,${excelData}`;
        
        hideLoading();

        // 创建模态窗口展示如何保存Excel文件
        const excelModal = document.createElement('div');
        excelModal.className = 'fixed inset-0 z-50 bg-black bg-opacity-70 backdrop-blur-sm flex items-center justify-center';
        excelModal.innerHTML = `
          <div class="bg-white dark:bg-dark-300 max-w-lg w-11/12 rounded-xl shadow-2xl p-6 animate-dialogScale">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
                <i class="ri-file-excel-2-line text-green-600 mr-2"></i>Excel文件已準備好
              </h3>
              <button id="closeExcelModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 rounded-full p-1.5 transition-colors hover:bg-gray-100 dark:hover:bg-dark-200">
                <i class="ri-close-line text-xl"></i>
              </button>
            </div>
            
            <div class="mb-6">
              <p class="text-gray-700 dark:text-gray-300 mb-4">Excel文件已生成，請點擊下方按鈕查看，然後使用「另存為」功能保存。</p>
              
              <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4 mb-4">
                <div class="flex">
                  <i class="ri-information-line text-yellow-500 text-lg mr-2 flex-shrink-0 mt-0.5"></i>
                  <div>
                    <p class="text-sm text-yellow-700 dark:text-yellow-400">由於瀏覽器限制，無法直接下載文件。請按照以下步驟保存：</p>
                    <ol class="list-decimal ml-5 mt-2 text-sm text-gray-700 dark:text-gray-400 space-y-1">
                      <li>點擊「查看Excel文件」按鈕</li>
                      <li>在新頁面中右鍵點擊並選擇「另存為」</li>
                      <li>保存文件為 "5E訂單_${dateStr}.xlsx"</li>
                    </ol>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3">
              <button id="closeExcelModalBtn" class="px-4 py-2 bg-gray-200 dark:bg-dark-400 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-dark-500 transition-colors">
                關閉
              </button>
              <a href="${dataUrl}" target="_blank" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors inline-flex items-center">
                <i class="ri-file-excel-2-line mr-1.5"></i>查看Excel文件
              </a>
            </div>
          </div>
        `;
        
        document.body.appendChild(excelModal);
        
        // 绑定关闭事件
        document.getElementById('closeExcelModal').addEventListener('click', () => {
          document.body.removeChild(excelModal);
        });
        document.getElementById('closeExcelModalBtn').addEventListener('click', () => {
          document.body.removeChild(excelModal);
        });
      })
      .catch(err => {
        hideLoading();
        console.error('Excel導出錯誤:', err);
        showStatusMessage('導出Excel失敗: ' + err.message, 'error');
        
        // 兜底方案: 如果无法加载库，使用原始的CSV剪贴板方法
        exportToCsv();
      });
  }
  
  // 备用方案: 导出为CSV格式并复制到剪贴板
  function exportToCsv() {
    // 从主系统的orderStore获取以"5E"开头的订单
    const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    if (fiveEOrders.length === 0) {
      showStatusMessage('沒有訂單可以導出', 'error');
      return;
    }
    
    // 创建CSV内容
    let csvContent = "姓名,学号,身份,餐品,餐品要求,飲品,飲品要求,价格,時間\n";
    
    fiveEOrders.forEach(order => {
      // 处理CSV中的特殊字符
      const name = order.name.replace('5E', '').replace(/"/g, '""');
      const studentId = order.meta?.studentId || '';
      const userType = order.meta?.userType === 'teacher' ? '老师' : '学生';
      const food = order.food.replace(/"/g, '""');
      const foodReqs = order.foodReqs.join('、').replace(/"/g, '""');
      const drink = order.drink ? order.drink.replace(/"/g, '""') : '';
      const drinkReqs = order.drinkReqs.join('、').replace(/"/g, '""');
      
      // 查找餐品价格
      let foodPrice = 0;
      for (const category in menuData) {
        const menuItem = menuData[category].find(item => item.name === order.food);
        if (menuItem) {
          foodPrice = menuItem.price;
          break;
        }
      }
      
      const timestamp = new Date(order.timestamp).toLocaleString('zh-HK');
      
      // 添加一行CSV数据
      csvContent += `"${name}","${studentId}","${userType}","${food}","${foodReqs}","${drink}","${drinkReqs}","${foodPrice}","${timestamp}"\n`;
    });
    
    // 复制到剪贴板
    navigator.clipboard.writeText(csvContent).then(() => {
      showStatusMessage('已複製Excel格式數據到剪貼板，可直接粘貼到Excel', 'success');
      
      // 显示自定义导出成功对话框
      const exportSuccessDialog = document.getElementById('exportSuccessDialog');
      const exportSuccessOk = document.getElementById('exportSuccessOk');
      
      // 更新对话框内容，让用户知道这是Excel格式
      const dialogTitle = exportSuccessDialog.querySelector('h3');
      if (dialogTitle) {
        dialogTitle.textContent = 'Excel格式導出成功！';
      }
      
      const dialogContent = exportSuccessDialog.querySelector('p');
      if (dialogContent) {
        dialogContent.textContent = 'Excel格式數據已複製到剪貼板，請打開Excel並粘貼。';
      }
      
      exportSuccessDialog.classList.remove('hidden');
      exportSuccessOk.focus();
      
      exportSuccessOk.onclick = () => {
        exportSuccessDialog.classList.add('hidden');
        // 恢复原来的标题和内容
        if (dialogTitle) {
          dialogTitle.textContent = '導出成功！';
        }
        if (dialogContent) {
          dialogContent.textContent = '訂單信息已成功複製到剪貼板。';
        }
      };
    }).catch(err => {
      showStatusMessage('無法複製Excel格式到剪貼板: ' + err, 'error');
      console.error('Failed to copy Excel format:', err);
    });
  }

  // 初始化5E订单系统
  function initializeFiveEOrderSystem() {
    // 加载存储的订单
    loadFiveEOrdersFromLocalStorage();
    
    // 打开和关闭事件
    document.getElementById('fiveEOrderBtn').addEventListener('click', openFiveEOrderSystem);
    document.getElementById('closeFiveESystem').addEventListener('click', closeFiveEOrderSystem);
    
    // 初始化食品选项
    initializeFiveEFoodOptions();
    
    // 打印、导出和清空按钮事件
    document.getElementById('fiveEPrintBtn').addEventListener('click', showPrintPreview);
    document.getElementById('fiveEExportOrdersBtn').addEventListener('click', exportFiveEOrders);
    document.getElementById('fiveEExportExcelBtn').addEventListener('click', exportToExcel);
    document.getElementById('fiveEClearOrdersBtn').addEventListener('click', clearAllFiveEOrders);
    
    // 初始化移动端选项卡切换
    initializeFiveEMobileTabs();

    // 添加下面的代码 - 5E订单操作下拉菜单功能
    const fiveEActionsDropdownBtn = document.getElementById('fiveEActionsDropdownBtn');
    const fiveEActionsDropdown = document.getElementById('fiveEActionsDropdown');
    if (fiveEActionsDropdownBtn && fiveEActionsDropdown) {
      fiveEActionsDropdownBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fiveEActionsDropdown.classList.toggle('hidden');
      });

      fiveEActionsDropdown.addEventListener('click', function(e) {
        e.stopPropagation();
      });

      document.addEventListener('click', function() {
        fiveEActionsDropdown.classList.add('hidden');
        });
      }
    }
  
  // 初始化5E移动端选项卡
  function initializeFiveEMobileTabs() {
    const fiveEFormTab = document.getElementById('fiveEFormTab');
    const fiveEListTab = document.getElementById('fiveEListTab');
    const fiveEFormView = document.getElementById('fiveEFormView');
    const fiveEListView = document.getElementById('fiveEListView');
    
    if (fiveEFormTab && fiveEListTab && fiveEFormView && fiveEListView) {
      // 切换到表单视图
      fiveEFormTab.addEventListener('click', function() {
        fiveEFormTab.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        fiveEFormTab.classList.add('bg-indigo-600', 'text-white');
        
        fiveEListTab.classList.remove('bg-indigo-600', 'text-white');
        fiveEListTab.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        
        fiveEFormView.classList.remove('hidden');
        fiveEListView.classList.add('hidden');
        
        // 更新订单计数徽章
        updateFiveEOrderCounter();
      });
      
      // 切换到列表视图
      fiveEListTab.addEventListener('click', function() {
        fiveEListTab.classList.remove('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        fiveEListTab.classList.add('bg-indigo-600', 'text-white');
        
        fiveEFormTab.classList.remove('bg-indigo-600', 'text-white');
        fiveEFormTab.classList.add('bg-gray-100', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
        
        fiveEListView.classList.remove('hidden');
        fiveEFormView.classList.add('hidden');
      });
      
      // 初始化时更新一次订单计数器
      updateFiveEOrderCounter();
      
      console.log("5E移动端Tab切换逻辑已初始化");
    }
  }
  
  // 更新5E订单计数器
  function updateFiveEOrderCounter() {
    const counter = document.getElementById('fiveEOrderCounter');
    if (counter) {
      // 获取以5E开头的订单数量
      const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
      counter.textContent = fiveEOrders.length;
    }
  }
  
  // 显示打印预览
  function showPrintPreview() {
    // 从主系统的orderStore获取以"5E"开头的订单
    const fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    if (fiveEOrders.length === 0) {
      showStatusMessage('沒有訂單可以打印', 'error');
      return;
    }
    
    // 创建打印预览模态框
    const printPreviewModal = document.createElement('div');
    printPreviewModal.id = 'printPreviewModal';
    printPreviewModal.className = 'fixed inset-0 z-50 bg-black bg-opacity-75 backdrop-blur flex items-center justify-center';
    
    // 构建打印预览内容
    let previewHTML = `
      <div class="bg-white dark:bg-dark-300 max-w-4xl w-11/12 rounded-xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-bold text-gray-800 dark:text-white flex items-center">
            <i class="ri-printer-line mr-2 text-blue-600"></i>5E班級訂單打印預覽
          </h3>
          <div class="flex space-x-3">
            <button id="printOrdersBtn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg flex items-center">
              <i class="ri-printer-line mr-1.5"></i>打印訂單
            </button>
            <button id="closePrintPreviewBtn" class="bg-gray-200 dark:bg-dark-400 hover:bg-gray-300 dark:hover:bg-dark-500 text-gray-700 dark:text-gray-300 py-2 px-4 rounded-lg flex items-center">
              <i class="ri-close-line mr-1.5"></i>關閉
            </button>
          </div>
        </div>
        
        <!-- 打印选项 -->
        <div class="mb-6 bg-gray-50 dark:bg-dark-400 p-4 rounded-lg border border-gray-200 dark:border-gray-700">
          <h4 class="text-md font-medium text-gray-800 dark:text-white mb-3">打印選項</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">打印類型</label>
              <select id="printType" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
                <option value="summary">匯總格式</option>
                <option value="detailed">詳細格式</option>
                <option value="kitchen">廚房專用格式</option>
                <option value="payment">金額明細</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">排序方式</label>
              <select id="sortOrder" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
                <option value="food">按餐品分組</option>
                <option value="time">按時間排序</option>
                <option value="name">按姓名排序</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">其他選項</label>
              <div class="flex items-center mt-2">
                <input type="checkbox" id="includePrices" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked>
                <label for="includePrices" class="ml-2 text-sm text-gray-700 dark:text-gray-300">包含價格</label>
              </div>
            </div>
          </div>
          <div class="mt-3">
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">餐廳備註</label>
            <input type="text" id="restaurantNote" placeholder="例如: 請提前15分鐘準備" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg input-focus-ring dark:bg-dark-500 dark:text-white">
          </div>
        </div>
        
        <!-- 打印预览区域 -->
        <div class="print-preview-content bg-white p-6 border border-gray-200 rounded-lg">
          <div id="printContent" class="print-content">
            <!-- 打印内容将动态插入这里 -->
          </div>
        </div>
      </div>
    `;
    
    printPreviewModal.innerHTML = previewHTML;
    document.body.appendChild(printPreviewModal);
    
    // 更新打印内容
    updatePrintPreview();
    
    // 绑定事件
    document.getElementById('printType').addEventListener('change', updatePrintPreview);
    document.getElementById('sortOrder').addEventListener('change', updatePrintPreview);
    document.getElementById('includePrices').addEventListener('change', updatePrintPreview);
    document.getElementById('restaurantNote').addEventListener('input', updatePrintPreview);
    
    document.getElementById('printOrdersBtn').addEventListener('click', function() {
      printFiveEOrders();
    });
    
    document.getElementById('closePrintPreviewBtn').addEventListener('click', function() {
      document.body.removeChild(printPreviewModal);
    });
  }
  
  // 更新打印预览内容
  function updatePrintPreview() {
    const printType = document.getElementById('printType').value;
    const sortOrder = document.getElementById('sortOrder').value;
    const includePrices = document.getElementById('includePrices').checked;
    const restaurantNote = document.getElementById('restaurantNote').value;
    
    // 从主系统的orderStore获取以"5E"开头的订单
    let fiveEOrders = getOrders().filter(order => order.name.startsWith('5E'));
    
    // 排序订单
    if (sortOrder === 'food') {
      fiveEOrders.sort((a, b) => a.food.localeCompare(b.food));
    } else if (sortOrder === 'time') {
      fiveEOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    } else if (sortOrder === 'name') {
      fiveEOrders.sort((a, b) => a.name.localeCompare(b.name));
    }
    
    const printContent = document.getElementById('printContent');
    let html = '';
    
    // 标题部分
    html += `
      <div style="text-align: center; margin-bottom: 20px;">
        <h1 style="font-size: 24px; font-weight: bold; margin-bottom: 5px;">5E班級訂單</h1>
        <p style="font-size: 14px; color: #666;">${new Date().toLocaleDateString('zh-HK', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' })}</p>
        ${restaurantNote ? `<p style="font-size: 16px; font-weight: bold; color: #e53e3e; margin-top: 10px; padding: 5px; border: 1px dashed #e53e3e;">${restaurantNote}</p>` : ''}
      </div>
    `;
    
    if (printType === 'summary') {
      // 汇总格式 - 按餐品统计
      const foodCount = {};
      const foodReqsCount = {};
      
      fiveEOrders.forEach(order => {
        foodCount[order.food] = (foodCount[order.food] || 0) + 1;
        
        // 分析食物要求
        if (order.foodReqs && order.foodReqs.length > 0) {
          if (!foodReqsCount[order.food]) {
            foodReqsCount[order.food] = {};
          }
          
          order.foodReqs.forEach(req => {
            foodReqsCount[order.food][req] = (foodReqsCount[order.food][req] || 0) + 1;
          });
        }
      });
      
      // 餐品统计表格
      html += `
        <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #4f46e5; padding-bottom: 5px; color: #4f46e5;">餐品統計</h2>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background-color: #f3f4f6;">
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">餐品名稱</th>
              <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">數量</th>
              ${includePrices ? '<th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">單價</th>' : ''}
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">特殊要求</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      Object.entries(foodCount).forEach(([food, count]) => {
        // 查找餐品价格
        let foodPrice = 0;
        for (const category in menuData) {
          const menuItem = menuData[category].find(item => item.name === food);
          if (menuItem) {
            foodPrice = menuItem.price;
            break;
          }
        }
        
        // 特殊要求
        let reqsHtml = '';
        if (foodReqsCount[food]) {
          Object.entries(foodReqsCount[food]).forEach(([req, reqCount]) => {
            reqsHtml += `<div>${req}: ${reqCount}份</div>`;
          });
        }
        
        html += `
          <tr>
            <td style="padding: 10px; border: 1px solid #e5e7eb;">${food}</td>
            <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold;">${count}</td>
            ${includePrices ? `<td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">$${foodPrice}</td>` : ''}
            <td style="padding: 10px; border: 1px solid #e5e7eb;">${reqsHtml || '-'}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      // 饮料统计
      const drinkCount = {};
      const drinkReqsCount = {};
      
      fiveEOrders.forEach(order => {
        if (order.drink) {
          drinkCount[order.drink] = (drinkCount[order.drink] || 0) + 1;
          
          // 分析饮料要求
          if (order.drinkReqs && order.drinkReqs.length > 0) {
            if (!drinkReqsCount[order.drink]) {
              drinkReqsCount[order.drink] = {};
            }
            
            order.drinkReqs.forEach(req => {
              drinkReqsCount[order.drink][req] = (drinkReqsCount[order.drink][req] || 0) + 1;
            });
          }
        }
      });
      
      if (Object.keys(drinkCount).length > 0) {
        html += `
          <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #4f46e5; padding-bottom: 5px; color: #4f46e5; margin-top: 30px;">飲品統計</h2>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
              <tr style="background-color: #f3f4f6;">
                <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">飲品名稱</th>
                <th style="padding: 10px; text-align: center; border: 1px solid #e5e7eb;">數量</th>
                <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">特殊要求</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        Object.entries(drinkCount).forEach(([drink, count]) => {
          // 特殊要求
          let reqsHtml = '';
          if (drinkReqsCount[drink]) {
            Object.entries(drinkReqsCount[drink]).forEach(([req, reqCount]) => {
              reqsHtml += `<div>${req}: ${reqCount}份</div>`;
            });
          }
          
          html += `
            <tr>
              <td style="padding: 10px; border: 1px solid #e5e7eb;">${drink}</td>
              <td style="padding: 10px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold;">${count}</td>
              <td style="padding: 10px; border: 1px solid #e5e7eb;">${reqsHtml || '-'}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
        `;
      }
      
      // 总计
      if (includePrices) {
        let totalAmount = 0;
        fiveEOrders.forEach(order => {
          for (const category in menuData) {
            const menuItem = menuData[category].find(item => item.name === order.food);
            if (menuItem) {
              totalAmount += menuItem.price;
              break;
            }
          }
        });
        
        html += `
          <div style="text-align: right; margin-top: 30px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
            <p style="font-size: 18px; font-weight: bold;">訂單總金額: $${totalAmount}</p>
          </div>
        `;
      }
      
    } else if (printType === 'detailed') {
      // 详细格式 - 显示每个人的订单
      html += `
        <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #4f46e5; padding-bottom: 5px; color: #4f46e5;">詳細訂單列表 (總共 ${fiveEOrders.length} 份)</h2>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <thead>
            <tr style="background-color: #f3f4f6;">
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">學生姓名</th>
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">餐品</th>
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">飲品</th>
              ${includePrices ? '<th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">金額</th>' : ''}
            </tr>
          </thead>
          <tbody>
      `;
      
      fiveEOrders.forEach(order => {
        // 查找餐品价格
        let foodPrice = 0;
        for (const category in menuData) {
          const menuItem = menuData[category].find(item => item.name === order.food);
          if (menuItem) {
            foodPrice = menuItem.price;
            break;
          }
        }
        
        // 准备食物和饮料显示，包括特殊要求
        const foodDisplay = `${order.food}${order.foodReqs.length > 0 ? ' (' + order.foodReqs.join('、') + ')' : ''}`;
        const drinkDisplay = order.drink ? `${order.drink}${order.drinkReqs.length > 0 ? ' (' + order.drinkReqs.join('、') + ')' : ''}` : '-';
        
        html += `
          <tr>
            <td style="padding: 10px; border: 1px solid #e5e7eb;">${order.name.replace('5E', '')}</td>
            <td style="padding: 10px; border: 1px solid #e5e7eb;">${foodDisplay}</td>
            <td style="padding: 10px; border: 1px solid #e5e7eb;">${drinkDisplay}</td>
            ${includePrices ? `<td style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">$${foodPrice}</td>` : ''}
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      // 总计
      if (includePrices) {
        let totalAmount = 0;
        fiveEOrders.forEach(order => {
          for (const category in menuData) {
            const menuItem = menuData[category].find(item => item.name === order.food);
            if (menuItem) {
              totalAmount += menuItem.price;
              break;
            }
          }
        });
        
        html += `
          <div style="text-align: right; margin-top: 20px; padding-top: 10px; border-top: 1px solid #e5e7eb;">
            <p style="font-size: 18px; font-weight: bold;">訂單總金額: $${totalAmount}</p>
          </div>
        `;
      }
      
    } else if (printType === 'payment') {
      // 金额明细格式 - 按学生分组，显示每个学生需要支付的金额
      // 按学生名称对订单进行分组
      const studentOrders = {};
      
      fiveEOrders.forEach(order => {
        const studentName = order.name.replace('5E', '');
        if (!studentOrders[studentName]) {
          studentOrders[studentName] = [];
        }
        studentOrders[studentName].push(order);
      });
      
      html += `
        <h2 style="font-size: 18px; font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #4f46e5; padding-bottom: 10px; color: #4f46e5;">5E班級金額明細表</h2>
        <p style="text-align: center; margin-bottom: 20px; font-size: 14px;">請各位同學準備好相應金額</p>
        
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
          <thead>
            <tr style="background-color: #f3f4f6;">
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">姓名</th>
              <th style="padding: 10px; text-align: left; border: 1px solid #e5e7eb;">訂單明細</th>
              <th style="padding: 10px; text-align: right; border: 1px solid #e5e7eb;">金額</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      // 计算每个学生需要支付的总金额
      Object.entries(studentOrders).forEach(([studentName, orders]) => {
        let totalAmount = 0;
        let orderDetails = '';
        
        orders.forEach((order, index) => {
          // 查找餐品价格
          let foodPrice = 0;
          for (const category in menuData) {
            const menuItem = menuData[category].find(item => item.name === order.food);
            if (menuItem) {
              foodPrice = menuItem.price;
              break;
            }
          }
          
          // 计算这个订单的总价
          totalAmount += foodPrice;
          
          // 准备订单详情
          orderDetails += `<div style="${index > 0 ? 'margin-top: 8px; padding-top: 8px; border-top: 1px dashed #e5e7eb;' : ''}">`;
          orderDetails += `<div><strong>${order.food}</strong>`;
          if (order.foodReqs.length > 0) {
            orderDetails += ` <span style="color: #6b7280;">(${order.foodReqs.join('、')})</span>`;
          }
          orderDetails += ` <span style="float: right;">$${foodPrice}</span></div>`;
          
          if (order.drink) {
            orderDetails += `<div style="padding-left: 15px; color: #6b7280;">+ ${order.drink}`;
            if (order.drinkReqs.length > 0) {
              orderDetails += ` (${order.drinkReqs.join('、')})`;
            }
            orderDetails += `</div>`;
          }
          orderDetails += `</div>`;
        });
        
        // 添加到表格中
        html += `
          <tr>
            <td style="padding: 10px; border: 1px solid #e5e7eb; vertical-align: top; font-weight: bold;">${studentName}</td>
            <td style="padding: 10px; border: 1px solid #e5e7eb; vertical-align: top;">${orderDetails}</td>
            <td style="padding: 10px; border: 1px solid #e5e7eb; vertical-align: top; text-align: right; font-size: 18px; font-weight: bold; color: #4f46e5;">$${totalAmount}</td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      // 计算总金额
      let grandTotal = 0;
      fiveEOrders.forEach(order => {
        for (const category in menuData) {
          const menuItem = menuData[category].find(item => item.name === order.food);
          if (menuItem) {
            grandTotal += menuItem.price;
            break;
          }
        }
      });
      
      html += `
        <div style="text-align: right; margin-top: 20px; padding-top: 10px; border-top: 2px solid #4f46e5;">
          <p style="font-size: 18px; font-weight: bold;">班級總金額: <span style="color: #4f46e5;">$${grandTotal}</span></p>
        </div>
      `;
      
    } else if (printType === 'kitchen') {
      // 厨房专用格式 - 按餐品类型分组，更简洁的格式
      const foodGroups = {};
      
      fiveEOrders.forEach(order => {
        if (!foodGroups[order.food]) {
          foodGroups[order.food] = [];
        }
        foodGroups[order.food].push(order);
      });
      
      html += `
        <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px;">廚房製作單 (${fiveEOrders.length}份)</h2>
      `;
      
      Object.entries(foodGroups).forEach(([food, orders]) => {
        html += `
          <div style="margin-bottom: 30px; page-break-inside: avoid;">
            <h3 style="font-size: 18px; font-weight: bold; background-color: #f3f4f6; padding: 10px; border-left: 4px solid #4f46e5;">
              ${food} - ${orders.length}份
            </h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background-color: #f3f4f6;">
                  <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; width: 40px;">序號</th>
                  <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">姓名</th>
                  <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">特殊要求</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        orders.forEach((order, index) => {
          html += `
            <tr>
              <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold;">${index + 1}</td>
              <td style="padding: 8px; border: 1px solid #e5e7eb;">${order.name.replace('5E', '')}</td>
              <td style="padding: 8px; border: 1px solid #e5e7eb; ${order.foodReqs.length > 0 ? 'font-weight: bold; color: #e53e3e;' : ''}">
                ${order.foodReqs.length > 0 ? order.foodReqs.join('、') : '-'}
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
          </div>
        `;
      });
      
      // 饮料部分
      const drinkOrders = fiveEOrders.filter(order => order.drink);
      if (drinkOrders.length > 0) {
        const drinkGroups = {};
        
        drinkOrders.forEach(order => {
          if (!drinkGroups[order.drink]) {
            drinkGroups[order.drink] = [];
          }
          drinkGroups[order.drink].push(order);
        });
        
        html += `
          <div style="margin-top: 30px; border-top: 2px dashed #4f46e5; padding-top: 20px; page-break-before: always;">
            <h2 style="font-size: 20px; font-weight: bold; margin-bottom: 15px; text-align: center;">飲品製作單 (${drinkOrders.length}份)</h2>
        `;
        
        Object.entries(drinkGroups).forEach(([drink, orders]) => {
          html += `
            <div style="margin-bottom: 30px; page-break-inside: avoid;">
              <h3 style="font-size: 18px; font-weight: bold; background-color: #f3f4f6; padding: 10px; border-left: 4px solid #4f46e5;">
                ${drink} - ${orders.length}份
              </h3>
              <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                  <tr style="background-color: #f3f4f6;">
                    <th style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; width: 40px;">序號</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">姓名</th>
                    <th style="padding: 8px; text-align: left; border: 1px solid #e5e7eb;">特殊要求</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          orders.forEach((order, index) => {
            html += `
              <tr>
                <td style="padding: 8px; text-align: center; border: 1px solid #e5e7eb; font-weight: bold;">${index + 1}</td>
                <td style="padding: 8px; border: 1px solid #e5e7eb;">${order.name.replace('5E', '')}</td>
                <td style="padding: 8px; border: 1px solid #e5e7eb; ${order.drinkReqs.length > 0 ? 'font-weight: bold; color: #e53e3e;' : ''}">
                  ${order.drinkReqs.length > 0 ? order.drinkReqs.join('、') : '-'}
                </td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
        });
        
        html += `</div>`;
      }
    }
    
    // 打印时间和页脚
    html += `
      <div style="margin-top: 30px; text-align: center; font-size: 12px; color: #6b7280; border-top: 1px solid #e5e7eb; padding-top: 10px;">
        <p>打印時間: ${new Date().toLocaleString('zh-HK')}</p>
        <p>5E班專用訂單系統</p>
      </div>
    `;
    
    printContent.innerHTML = html;
  }
  
  // 执行打印功能
  function printFiveEOrders() {
    const printContent = document.getElementById('printContent').innerHTML;
    
    // 创建打印窗口
    const printWindow = window.open('', '_blank', 'width=800,height=600');
    printWindow.document.open();
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <title>5E班級訂單打印</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
          body { font-family: Arial, 'Microsoft YaHei UI', sans-serif; line-height: 1.5; margin: 20px; }
          @media print {
            @page { margin: 0.5cm; }
            body { margin: 0; }
            .no-print { display: none !important; }
          }
        </style>
      </head>
      <body>
        <div class="no-print" style="text-align: center; margin-bottom: 20px;">
          <button onclick="window.print()" style="padding: 10px 20px; background-color: #4f46e5; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
            點擊此處打印
          </button>
          <p style="font-size: 13px; color: #6b7280; margin-top: 5px;">打印完成後可關閉此窗口</p>
        </div>
        ${printContent}
      </body>
      </html>
    `);
    printWindow.document.close();
    
    // 监听打印窗口的关闭事件
    if (window.navigator.userAgent.toLowerCase().includes('chrome')) {
      // Chrome浏览器中的处理方式
      setTimeout(() => {
        printWindow.focus();
      }, 300);
    } else {
      // 其他浏览器中的处理方式
      printWindow.focus();
    }
    
    // 记录打印行为
    showStatusMessage('訂單已发送至打印预览', 'success');
  }
  
  // 在DOM加载完成后初始化5E订单系统
  document.addEventListener('DOMContentLoaded', function() {
    initializeFiveEOrderSystem();
  });
  
  // 设置主页标题点击触发彩蛋
  window.addEventListener('load', function() {
    console.log("注册GGH Pattern标题彩蛋点击事件");
    let clickCount = 0;
    let clickTimer = null;
    
    // 使用主页的GGH Pattern标题作为彩蛋触发点
    const gghPatternTitle = document.querySelector('h1.text-3xl.md\\:text-4xl');
    if (gghPatternTitle) {
      gghPatternTitle.style.cursor = 'pointer';
      gghPatternTitle.addEventListener('click', function() {
        console.log("GGH Pattern标题被点击", clickCount + 1);
        // 增加点击计数
        clickCount++;
        
        // 清除之前的计时器
        if (clickTimer) {
          clearTimeout(clickTimer);
        }
        
        // 设置新的计时器，2秒内没有新点击则重置
        clickTimer = setTimeout(() => {
          clickCount = 0;
          console.log("点击计数重置");
        }, 2000);
        
        // 当点击达到3次时，显示彩蛋
        if (clickCount >= 3) {
          clickCount = 0;
          clearTimeout(clickTimer);
          console.log("触发彩蛋!");
          showEasterEgg();
        }
      });
    } else {
      console.error("找不到GGH Pattern标题元素!");
    }
    
    // 保留原GGH Logo彩蛋事件逻辑
    const gghLogo = document.getElementById('gghLogoEasterEgg');
    if (gghLogo) {
      gghLogo.addEventListener('click', function() {
        console.log("GGH图标被点击");
        showEasterEgg();
      });
    }
  });
  
  </script>






</body></html>